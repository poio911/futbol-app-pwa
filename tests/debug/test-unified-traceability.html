<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Sistema Unificado de Trazabilidad</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.05);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(0,255,157,0.3);
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            border-left: 4px solid #00ff9d;
        }
        
        .log-output {
            background: #000;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #333;
        }
        
        .btn {
            background: linear-gradient(45deg, #00ff9d, #00d4aa);
            color: #0a0a0a;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,255,157,0.3);
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .status.success { background: rgba(16,185,129,0.2); border: 1px solid #10b981; }
        .status.error { background: rgba(239,68,68,0.2); border: 1px solid #ef4444; }
        .status.warning { background: rgba(245,158,11,0.2); border: 1px solid #f59e0b; }
        .status.info { background: rgba(59,130,246,0.2); border: 1px solid #3b82f6; }
        
        .test-results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .test-results { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üß™ Test del Sistema Unificado de Trazabilidad</h1>
            <p>Verificando integraci√≥n de evaluation_logs con unified-evaluation-system.js</p>
        </div>
        
        <div class="test-section">
            <h3>üîß Configuraci√≥n del Test</h3>
            <button class="btn" onclick="initializeTest()">üöÄ Inicializar Test</button>
            <button class="btn" onclick="simulateEvaluations()">‚ö° Simular 8 Evaluaciones</button>
            <button class="btn" onclick="checkTraceability()">üîç Verificar Trazabilidad</button>
            <button class="btn" onclick="clearLogs()">üßπ Limpiar Logs</button>
        </div>
        
        <div class="test-results">
            <div class="test-section">
                <h3>üìä Estado del Test</h3>
                <div id="test-status">
                    <div class="status info">‚è≥ Esperando inicializaci√≥n...</div>
                </div>
            </div>
            
            <div class="test-section">
                <h3>üéØ Resultados</h3>
                <div id="test-results">
                    <p>‚Ä¢ Funci√≥n logEvaluationTrace: <span id="trace-function">‚ùì</span></p>
                    <p>‚Ä¢ Registros en evaluation_logs: <span id="trace-logs">‚ùì</span></p>
                    <p>‚Ä¢ Trazabilidad completa: <span id="trace-complete">‚ùì</span></p>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üìã Log de Ejecuci√≥n</h3>
            <div id="log-output" class="log-output">Esperando logs del test...\n</div>
        </div>
    </div>

    <script src="js/firebase-simple.js"></script>
    <script src="js/unified-evaluation-system.js"></script>
    
    <script>
        let testDb = null;
        let testMatchId = `test_match_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        // Funci√≥n de logging centralizada
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logOutput = document.getElementById('log-output');
            const typeEmojis = {
                info: '‚ÑπÔ∏è',
                success: '‚úÖ', 
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                debug: 'üîç'
            };
            
            const logMessage = `[${timestamp}] ${typeEmojis[type] || '‚ÑπÔ∏è'} ${message}\n`;
            logOutput.textContent += logMessage;
            logOutput.scrollTop = logOutput.scrollHeight;
            
            console.log(`[TEST] ${message}`);
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('test-status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function updateResult(elementId, status, isSuccess) {
            const element = document.getElementById(elementId);
            element.textContent = isSuccess ? `‚úÖ ${status}` : `‚ùå ${status}`;
            element.style.color = isSuccess ? '#10b981' : '#ef4444';
        }
        
        async function initializeTest() {
            log('üöÄ Inicializando test del sistema de trazabilidad...', 'info');
            updateStatus('üîÑ Inicializando conexiones...', 'info');
            
            try {
                // Verificar Firebase
                if (!firebase?.apps?.length) {
                    log('‚ùå Firebase no inicializado', 'error');
                    updateStatus('‚ùå Error: Firebase no disponible', 'error');
                    return;
                }
                
                testDb = firebase.firestore();
                log('‚úÖ Firebase conectado correctamente', 'success');
                
                // Verificar Storage
                if (!window.Storage) {
                    log('‚ùå Storage no disponible', 'error');
                    updateStatus('‚ùå Error: Storage no disponible', 'error');
                    return;
                }
                
                log('‚úÖ Storage disponible', 'success');
                
                // Verificar funci√≥n de trazabilidad
                if (typeof window.Storage.logEvaluationTrace === 'function') {
                    log('‚úÖ Funci√≥n logEvaluationTrace encontrada', 'success');
                    updateResult('trace-function', 'Disponible', true);
                } else {
                    log('‚ùå Funci√≥n logEvaluationTrace no encontrada', 'error');
                    updateResult('trace-function', 'No disponible', false);
                    updateStatus('‚ùå Error: Funci√≥n de trazabilidad no disponible', 'error');
                    return;
                }
                
                // Verificar unified-evaluation-system
                if (typeof window.UnifiedEvaluationSystem !== 'undefined') {
                    log('‚úÖ UnifiedEvaluationSystem disponible', 'success');
                } else {
                    log('‚ö†Ô∏è UnifiedEvaluationSystem no encontrado, continuando...', 'warning');
                }
                
                log(`üéØ Test configurado para partido: ${testMatchId}`, 'info');
                updateStatus('‚úÖ Inicializaci√≥n completada - Listo para simular evaluaciones', 'success');
                
            } catch (error) {
                log(`‚ùå Error en inicializaci√≥n: ${error.message}`, 'error');
                updateStatus(`‚ùå Error en inicializaci√≥n: ${error.message}`, 'error');
            }
        }
        
        async function simulateEvaluations() {
            log('‚ö° Iniciando simulaci√≥n de 8 evaluaciones...', 'info');
            updateStatus('üîÑ Simulando evaluaciones grupales...', 'info');
            
            try {
                // Simular datos de evaluaci√≥n grupal
                const mockEvalData = {
                    matchId: testMatchId,
                    matchName: 'Test Match - Trazabilidad',
                    participationRate: 0.8, // 80% participaci√≥n para activar sistema
                    evaluations: {
                        'evaluator_1': { rating: 8, goals: 1 },
                        'evaluator_2': { rating: 7, goals: 0 },
                        'evaluator_3': { rating: 9, goals: 2 },
                        'evaluator_4': { rating: 6, goals: 0 },
                        'evaluator_5': { rating: 8, goals: 1 },
                        'evaluator_6': { rating: 7, goals: 0 },
                        'evaluator_7': { rating: 8, goals: 1 },
                        'evaluator_8': { rating: 9, goals: 2 }
                    }
                };
                
                log(`üìä Simulando evaluaci√≥n grupal con ${Object.keys(mockEvalData.evaluations).length} evaluadores`, 'info');
                log(`üìà Participaci√≥n: ${(mockEvalData.participationRate * 100).toFixed(1)}%`, 'info');
                
                // Crear usuario de test
                const testUserId = `test_user_${Date.now()}`;
                const testPlayerData = {
                    id: testUserId,
                    displayName: 'Test Player',
                    name: 'Test Player',
                    ovr: 60,
                    pac: 55,
                    sho: 65,
                    pas: 60,
                    dri: 58,
                    def: 62,
                    phy: 59
                };
                
                log(`üë§ Usuario de test creado: ${testPlayerData.displayName} (OVR: ${testPlayerData.ovr})`, 'info');
                
                // Simular el proceso de actualizaci√≥n unificada
                const oldOVR = testPlayerData.ovr;
                const newOVR = oldOVR + 8; // Simular incremento de +8
                
                // Crear contexto de evaluaci√≥n
                const beforeData = {
                    ovr: oldOVR,
                    pac: testPlayerData.pac,
                    sho: testPlayerData.sho,
                    pas: testPlayerData.pas,
                    dri: testPlayerData.dri,
                    def: testPlayerData.def,
                    phy: testPlayerData.phy
                };
                
                const afterData = {
                    ovr: newOVR,
                    pac: testPlayerData.pac + 1,
                    sho: testPlayerData.sho + 2,
                    pas: testPlayerData.pas + 1,
                    dri: testPlayerData.dri + 1,
                    def: testPlayerData.def + 2,
                    phy: testPlayerData.phy + 1
                };
                
                const evaluationContext = {
                    matchId: testMatchId,
                    evaluatorId: 'test-unified-system',
                    evaluatedUserName: testPlayerData.displayName,
                    evaluationType: 'test-unified-group-completion',
                    evaluationData: {
                        participationRate: mockEvalData.participationRate,
                        totalEvaluators: Object.keys(mockEvalData.evaluations).length,
                        ovrIncrease: newOVR - oldOVR,
                        completedAt: Date.now(),
                        testMode: true
                    }
                };
                
                log('üîÑ Llamando a logEvaluationTrace...', 'debug');
                
                // Llamar a la funci√≥n de trazabilidad
                await window.Storage.logEvaluationTrace(testUserId, beforeData, afterData, evaluationContext);
                
                log(`‚úÖ Trazabilidad creada para ${testPlayerData.displayName}: ${oldOVR} ‚Üí ${newOVR} (+${newOVR - oldOVR})`, 'success');
                log('üìù Registro guardado en evaluation_logs collection', 'success');
                
                updateStatus('‚úÖ Simulaci√≥n completada - Verificando trazabilidad...', 'success');
                
                // Auto-verificar despu√©s de un momento
                setTimeout(() => {
                    checkTraceability();
                }, 2000);
                
            } catch (error) {
                log(`‚ùå Error en simulaci√≥n: ${error.message}`, 'error');
                updateStatus(`‚ùå Error en simulaci√≥n: ${error.message}`, 'error');
            }
        }
        
        async function checkTraceability() {
            log('üîç Verificando registros de trazabilidad...', 'info');
            updateStatus('üîÑ Consultando evaluation_logs...', 'info');
            
            try {
                if (!testDb) {
                    throw new Error('Base de datos no inicializada');
                }
                
                // Consultar evaluation_logs
                const snapshot = await testDb.collection('evaluation_logs')
                    .where('matchId', '==', testMatchId)
                    .get();
                
                log(`üìä Encontrados ${snapshot.size} registros en evaluation_logs`, 'info');
                
                if (snapshot.size > 0) {
                    updateResult('trace-logs', `${snapshot.size} registros encontrados`, true);
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        log(`üìã Registro: ${data.evaluatedUserName} | ${data.evaluationType} | OVR: ${data.ovrChange?.before} ‚Üí ${data.ovrChange?.after}`, 'debug');
                        
                        // Verificar estructura completa
                        const hasRequiredFields = data.matchId && data.evaluatedUserName && data.changes && data.ovrChange;
                        if (hasRequiredFields) {
                            log('‚úÖ Estructura de trazabilidad completa verificada', 'success');
                            updateResult('trace-complete', 'Estructura v√°lida', true);
                        } else {
                            log('‚ö†Ô∏è Estructura de trazabilidad incompleta', 'warning');
                            updateResult('trace-complete', 'Estructura incompleta', false);
                        }
                    });
                    
                    updateStatus('‚úÖ Verificaci√≥n completada - Sistema funcionando correctamente', 'success');
                    log('üéâ Test completado exitosamente - El sistema de trazabilidad est√° funcionando!', 'success');
                    
                } else {
                    updateResult('trace-logs', 'No se encontraron registros', false);
                    updateResult('trace-complete', 'Sin datos', false);
                    updateStatus('‚ùå No se encontraron registros de trazabilidad', 'error');
                    log('‚ùå No se crearon registros en evaluation_logs', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error verificando trazabilidad: ${error.message}`, 'error');
                updateStatus(`‚ùå Error en verificaci√≥n: ${error.message}`, 'error');
                updateResult('trace-logs', 'Error en consulta', false);
                updateResult('trace-complete', 'Error en verificaci√≥n', false);
            }
        }
        
        function clearLogs() {
            document.getElementById('log-output').textContent = 'Logs limpiados...\n';
            log('üßπ Logs limpiados', 'info');
        }
        
        // Auto-inicializar cuando se cargue la p√°gina
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('üîÑ P√°gina cargada, preparando test...', 'info');
            }, 1000);
        });
    </script>
</body>
</html>