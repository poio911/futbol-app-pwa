<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Admin Panel - F√∫tbol Stats</title>
    
    <!-- Boxicons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <!-- Firebase - Solo Firestore, sin Auth -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary: #00ff9d;
            --secondary: #ff00e6;
            --dark: #0a0a0a;
            --darker: #050505;
            --card-bg: rgba(26, 31, 46, 0.9);
            --text-light: #ffffff;
            --text-secondary: #b0b0b0;
            --border: rgba(255, 255, 255, 0.1);
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 50%, var(--darker) 100%);
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: auto;
        }

        /* AUTH SCREEN */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .auth-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .auth-header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .auth-header p {
            color: #666;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e1e1;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .login-btn:hover {
            opacity: 0.9;
        }

        .auth-error {
            background: #fee2e2;
            color: #dc2626;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        /* ADMIN DASHBOARD */
        .admin-dashboard {
            display: none;
        }

        .admin-header {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .admin-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logout-btn {
            background: var(--error);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: opacity 0.3s ease;
        }

        .logout-btn:hover {
            opacity: 0.9;
        }

        .admin-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* NAVIGATION TABS */
        .admin-nav {
            display: flex;
            gap: 4px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-tab.active {
            background: var(--primary);
            color: var(--dark);
        }

        /* TAB CONTENT */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* CARDS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .stat-title {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--dark);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--error);
        }

        /* TABLES */
        .data-table {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .table-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--dark);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        th {
            background: rgba(0, 255, 157, 0.1);
            color: var(--primary);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }

        td {
            color: var(--text-light);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .admin-header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .admin-nav {
                flex-wrap: wrap;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 8px 12px;
            }
        }

        /* LOADING */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading i {
            font-size: 24px;
            margin-right: 12px;
            /* Animaci√≥n eliminada */
        }

        /* ANALYTICS STYLES */
        .analytics-container {
            padding: 20px 0;
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .analytics-title {
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }

        .analytics-section {
            margin-bottom: 40px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }

        .analytics-section h4 {
            color: var(--primary);
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-content {
            min-height: 100px;
        }

        .stat-description {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .comparison-table th {
            background: rgba(0, 255, 157, 0.15);
            color: var(--primary);
            font-size: 11px;
            padding: 8px 12px;
        }

        .comparison-table td {
            padding: 8px 12px;
            font-size: 13px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .trend-positive {
            color: var(--success);
        }

        .trend-negative {
            color: var(--error);
        }

        .trend-neutral {
            color: var(--text-secondary);
        }

        .highlight-stat {
            background: rgba(0, 255, 157, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            margin: 10px 0;
        }

        .evaluation-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .evaluation-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .evaluation-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .evaluation-player {
            font-weight: 600;
            color: var(--primary);
        }

        .evaluation-change {
            font-weight: 700;
            font-size: 16px;
        }

        .evaluation-details {
            font-size: 12px;
            color: var(--text-secondary);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
        }

        /* MODAL EMBEBIDA */
        .detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .detail-modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        
        .detail-modal-content {
            background: var(--dark);
            border: 2px solid var(--border);
            border-radius: 20px;
            width: 100%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 30px;
            backdrop-filter: blur(20px);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .detail-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
            margin-bottom: 20px;
        }
        
        .detail-modal-title {
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
        }
        
        .close-modal-btn {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.4);
            color: #ff4444;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .close-modal-btn:hover {
            background: rgba(255, 0, 0, 0.3);
            transform: scale(1.05);
        }
        
        .detail-modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .evaluation-full-detail {
            display: grid;
            gap: 20px;
        }
        
        .evaluation-section {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        
        .evaluation-section-title {
            color: var(--primary);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
        }
        
        .stats-before, .stats-after {
            background: rgba(255, 255, 255, 0.02);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .stats-arrow {
            color: var(--primary);
            font-size: 24px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .stat-name {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .stat-value {
            color: white;
            font-weight: 600;
        }
        
        .stat-change {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .stat-change.positive {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }
        
        .stat-change.negative {
            background: rgba(255, 0, 0, 0.2);
            color: #ff4444;
        }
        
        .stat-change.neutral {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }
        
        /* HIDDEN */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- AUTH SCREEN -->
    <div class="auth-screen" id="auth-screen">
        <div class="auth-container">
            <div class="auth-header">
                <h1>üîß Admin Panel</h1>
                <p>Panel de Administraci√≥n - Solo Administradores</p>
            </div>
            
            <div class="form-group">
                <label>Email de Administrador:</label>
                <input type="email" id="admin-email" placeholder="admin@email.com">
            </div>
            
            <div class="form-group">
                <label>Contrase√±a:</label>
                <input type="password" id="admin-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            
            <button class="login-btn" onclick="window.adminAuth()">
                <i class='bx bx-log-in'></i>
                Acceso Administrativo
            </button>
            
            <div class="auth-error" id="auth-error"></div>
        </div>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div class="admin-dashboard" id="admin-dashboard">
        <!-- HEADER -->
        <header class="admin-header">
            <div class="admin-header-content">
                <div class="admin-title">
                    <i class='bx bx-shield-check'></i>
                    Panel de Administraci√≥n
                </div>
                <div class="admin-user">
                    <span id="admin-user-name">Admin</span>
                    <button class="logout-btn" onclick="window.logout()">
                        <i class='bx bx-log-out'></i>
                        Salir
                    </button>
                </div>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="admin-content">
            <!-- NAVIGATION -->
            <nav class="admin-nav">
                <button class="nav-tab active" onclick="window.showTab('dashboard')">
                    <i class='bx bx-dashboard'></i>
                    Dashboard
                </button>
                <button class="nav-tab" onclick="window.showTab('players')">
                    <i class='bx bx-group'></i>
                    Jugadores
                </button>
                <button class="nav-tab" onclick="window.showTab('matches')">
                    <i class='bx bx-football'></i>
                    Partidos
                </button>
                <button class="nav-tab" onclick="window.showTab('evaluations')">
                    <i class='bx bx-line-chart'></i>
                    Evaluaciones
                </button>
                <button class="nav-tab" onclick="window.showTab('analytics')">
                    <i class='bx bx-bar-chart-alt-2'></i>
                    An√°lisis
                </button>
                <button class="nav-tab" onclick="window.showTab('database')">
                    <i class='bx bx-data'></i>
                    Base de Datos
                </button>
            </nav>

            <!-- DASHBOARD TAB -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Jugadores</div>
                            <div class="stat-icon">
                                <i class='bx bx-group'></i>
                            </div>
                        </div>
                        <div class="stat-value" id="total-players">0</div>
                        <div class="stat-change positive">
                            <i class='bx bx-trending-up'></i>
                            +12% desde el mes pasado
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Partidos</div>
                            <div class="stat-icon">
                                <i class='bx bx-football'></i>
                            </div>
                        </div>
                        <div class="stat-value" id="total-matches">0</div>
                        <div class="stat-change positive">
                            <i class='bx bx-trending-up'></i>
                            +25% esta semana
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Evaluaciones Totales</div>
                            <div class="stat-icon">
                                <i class='bx bx-line-chart'></i>
                            </div>
                        </div>
                        <div class="stat-value" id="total-evaluations">0</div>
                        <div class="stat-change positive">
                            <i class='bx bx-trending-up'></i>
                            +45% √∫ltimo partido
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">OVR Promedio</div>
                            <div class="stat-icon">
                                <i class='bx bx-trophy'></i>
                            </div>
                        </div>
                        <div class="stat-value" id="avg-ovr">0</div>
                        <div class="stat-change positive">
                            <i class='bx bx-trending-up'></i>
                            +2.5 puntos
                        </div>
                    </div>
                </div>
            </div>

            <!-- PLAYERS TAB -->
            <div id="players" class="tab-content">
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Gesti√≥n de Jugadores</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="window.exportPlayers()">
                                <i class='bx bx-export'></i>
                                Exportar
                            </button>
                            <button class="btn btn-secondary" onclick="window.loadPlayers()">
                                <i class='bx bx-refresh'></i>
                                Recargar
                            </button>
                        </div>
                    </div>
                    <div id="players-content" class="loading">
                        <i class='bx bx-loader-alt'></i>
                        Cargando jugadores...
                    </div>
                </div>
            </div>

            <!-- MATCHES TAB -->
            <div id="matches" class="tab-content">
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Gesti√≥n de Partidos</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="window.exportMatches()">
                                <i class='bx bx-export'></i>
                                Exportar
                            </button>
                            <button class="btn btn-secondary" onclick="window.loadMatches()">
                                <i class='bx bx-refresh'></i>
                                Recargar
                            </button>
                        </div>
                    </div>
                    <div id="matches-content" class="loading">
                        <i class='bx bx-loader-alt'></i>
                        Cargando partidos...
                    </div>
                </div>
            </div>

            <!-- EVALUATIONS TAB -->
            <div id="evaluations" class="tab-content">
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">An√°lisis de Evaluaciones</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="window.exportEvaluations()">
                                <i class='bx bx-export'></i>
                                Exportar
                            </button>
                            <button class="btn btn-secondary" onclick="window.loadEvaluations()">
                                <i class='bx bx-refresh'></i>
                                Recargar
                            </button>
                        </div>
                    </div>
                    <div id="evaluations-content" class="loading">
                        <i class='bx bx-loader-alt'></i>
                        Cargando evaluaciones...
                    </div>
                </div>
            </div>

            <!-- ANALYTICS TAB -->
            <div id="analytics" class="tab-content">
                <div class="analytics-container">
                    <div class="analytics-header">
                        <h3 class="analytics-title">üìä An√°lisis Estad√≠stico Detallado</h3>
                        <button class="btn btn-primary" onclick="window.generateAnalytics()">
                            <i class='bx bx-refresh'></i>
                            Actualizar An√°lisis
                        </button>
                    </div>
                    
                    <!-- AN√ÅLISIS GENERAL -->
                    <div class="analytics-section">
                        <h4>üèÜ Rendimiento General</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Jugador Mejor Valorado</div>
                                    <div class="stat-icon">üëë</div>
                                </div>
                                <div class="stat-value" id="best-player">-</div>
                                <div class="stat-description" id="best-player-ovr">OVR: -</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Mayor Progreso</div>
                                    <div class="stat-icon">üìà</div>
                                </div>
                                <div class="stat-value" id="most-improved">-</div>
                                <div class="stat-description" id="most-improved-change">Cambio: -</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Evaluaciones Recientes</div>
                                    <div class="stat-icon">‚è±Ô∏è</div>
                                </div>
                                <div class="stat-value" id="recent-evaluations">0</div>
                                <div class="stat-description">√öltima semana</div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-title">Tendencia General</div>
                                    <div class="stat-icon">üìä</div>
                                </div>
                                <div class="stat-value" id="general-trend">-</div>
                                <div class="stat-description" id="trend-description">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- AN√ÅLISIS POR POSICI√ìN -->
                    <div class="analytics-section">
                        <h4>‚öΩ An√°lisis por Posici√≥n</h4>
                        <div id="position-analysis" class="analysis-content">
                            <div class="loading">
                                <i class='bx bx-loader-alt'></i>
                                Analizando datos por posici√≥n...
                            </div>
                        </div>
                    </div>

                    <!-- TOP EVALUACIONES -->
                    <div class="analytics-section">
                        <h4>üîù Evaluaciones Destacadas</h4>
                        <div id="top-evaluations" class="analysis-content">
                            <div class="loading">
                                <i class='bx bx-loader-alt'></i>
                                Cargando evaluaciones destacadas...
                            </div>
                        </div>
                    </div>

                    <!-- HISTORIAL DE CAMBIOS -->
                    <div class="analytics-section">
                        <h4>üìà Historial de Cambios de OVR</h4>
                        <div id="ovr-history" class="analysis-content">
                            <div class="loading">
                                <i class='bx bx-loader-alt'></i>
                                Generando historial de cambios...
                            </div>
                        </div>
                    </div>

                    <!-- ESTAD√çSTICAS DETALLADAS -->
                    <div class="analytics-section">
                        <h4>üìã Estad√≠sticas Detalladas</h4>
                        <div id="detailed-stats" class="analysis-content">
                            <div class="loading">
                                <i class='bx bx-loader-alt'></i>
                                Calculando estad√≠sticas detalladas...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DATABASE TAB -->
            <div id="database" class="tab-content">
                <h3>üóÑÔ∏è Gesti√≥n de Base de Datos</h3>
                <p>Pr√≥ximamente: Herramientas de gesti√≥n directa de Firebase</p>
            </div>
        </div>
    </div>

    <!-- MODAL DE DETALLES -->
    <div id="detail-modal" class="detail-modal">
        <div class="detail-modal-content">
            <div class="detail-modal-header">
                <h2 class="detail-modal-title" id="modal-title">Detalles</h2>
                <button class="close-modal-btn" onclick="window.closeDetailModal()">
                    <i class='bx bx-x'></i> Cerrar
                </button>
            </div>
            <div class="detail-modal-body" id="modal-body">
                <!-- El contenido se inyecta din√°micamente -->
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // Hacer funciones globales
        window.editPlayer = null;
        window.deletePlayer = null;
        window.viewMatchDetails = null;
        window.deleteMatch = null;
        window.viewEvaluationDetails = null;
        window.deleteEvaluation = null;
        window.exportPlayers = null;
        window.exportMatches = null;
        window.exportEvaluations = null;
        window.loadPlayers = null;
        window.loadMatches = null;
        window.loadEvaluations = null;
        window.generateAnalytics = null;
        window.adminAuth = null;
        window.logout = null;
        window.showTab = null;
        
        // Firebase Configuration (misma config del main app)
        const firebaseConfig = {
            apiKey: "AIzaSyAes7EVn8hQswS8XgvDMJfN6U4IT_ZL_WY",
            authDomain: "mil-disculpis.firebaseapp.com",
            databaseURL: "https://mil-disculpis-default-rtdb.firebaseio.com",
            projectId: "mil-disculpis",
            storageBucket: "mil-disculpis.firebasestorage.app",
            messagingSenderId: "5614567933",
            appId: "1:5614567933:web:0dce7bf37b8325c0861994",
            measurementId: "G-EMLP4TKXKR"
        };

        // Initialize Firebase - Solo Firestore
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let currentAdmin = null;
        let allPlayers = [];
        let allMatches = [];
        let allEvaluations = [];

        // Authentication - Simple verificaci√≥n sin Firebase Auth
        window.adminAuth = async function() {
            const email = document.getElementById('admin-email').value.trim();
            const password = document.getElementById('admin-password').value;

            // Verificar que sea el email espec√≠fico
            if (email !== 'poio911@hotmail.com') {
                showError('Acceso denegado. Solo administradores autorizados.');
                return;
            }

            // Verificar contrase√±a espec√≠fica (puedes cambiarla aqu√≠)
            if (password !== 'Shalke911') {
                showError('Contrase√±a incorrecta.');
                return;
            }

            try {
                console.log('üîê Autenticaci√≥n admin exitosa');
                
                // Crear objeto admin simulado
                currentAdmin = {
                    email: email,
                    displayName: 'Admin',
                    isAdmin: true
                };
                
                console.log('‚úÖ Admin logueado exitosamente:', currentAdmin.email);
                
                // Mostrar dashboard
                showDashboard();
                
                // Cargar datos iniciales
                await loadInitialData();
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                showError('Error cargando el panel de administraci√≥n.');
            }
        }

        window.showError = function(message) {
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        window.showDashboard = function() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'block';
            document.getElementById('admin-user-name').textContent = currentAdmin.email;
        }

        window.logout = function() {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('admin-dashboard').style.display = 'none';
            currentAdmin = null;
            
            // Limpiar formulario
            document.getElementById('admin-email').value = '';
            document.getElementById('admin-password').value = '';
            
            console.log('üö™ Admin deslogueado');
        }

        // Tab Navigation
        window.showTab = function(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active from nav buttons
            const navButtons = document.querySelectorAll('.nav-tab');
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active to clicked button
            event.target.classList.add('active');
            
            // Load data for specific tab
            if (tabName === 'players') loadPlayers();
            else if (tabName === 'matches') loadMatches();
            else if (tabName === 'evaluations') loadEvaluations();
            else if (tabName === 'analytics') generateAnalytics();
        }

        // Data Loading Functions
        async function loadInitialData() {
            try {
                // Cargar estad√≠sticas generales
                await Promise.all([
                    loadDashboardStats(),
                    loadPlayers(),
                    loadMatches(),
                    loadEvaluations()
                ]);
                console.log('‚úÖ Datos iniciales cargados');
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
            }
        }

        async function loadDashboardStats() {
            try {
                // Cargar jugadores
                const playersSnapshot = await db.collection('futbol_users').get();
                const totalPlayers = playersSnapshot.size;
                document.getElementById('total-players').textContent = totalPlayers;

                // Calcular OVR promedio
                let totalOVR = 0;
                playersSnapshot.forEach(doc => {
                    const player = doc.data();
                    totalOVR += player.ovr || 0;
                });
                const avgOVR = totalPlayers > 0 ? (totalOVR / totalPlayers).toFixed(1) : 0;
                document.getElementById('avg-ovr').textContent = avgOVR;

                // Cargar partidos de m√∫ltiples colecciones
                let totalMatchesCount = 0;
                const matchCollections = ['matches', 'collaborative_matches', 'futbol_matches'];
                
                for (const collectionName of matchCollections) {
                    try {
                        const snapshot = await db.collection(collectionName).get();
                        totalMatchesCount += snapshot.size;
                        console.log(`üìä Dashboard - ${collectionName}: ${snapshot.size} partidos`);
                    } catch (err) {
                        console.warn(`Dashboard - Collection ${collectionName} no existe`);
                    }
                }
                
                document.getElementById('total-matches').textContent = totalMatchesCount;

                // Cargar evaluaciones de m√∫ltiples fuentes
                let totalEvaluationsCount = 0;
                const evalCollections = ['evaluations', 'player_evaluations', 'match_evaluations', 'playerEvaluations'];
                
                for (const collectionName of evalCollections) {
                    try {
                        const snapshot = await db.collection(collectionName).get();
                        totalEvaluationsCount += snapshot.size;
                        console.log(`üìä Dashboard - ${collectionName}: ${snapshot.size} evaluaciones`);
                    } catch (err) {
                        console.warn(`Dashboard - Collection ${collectionName} no existe`);
                    }
                }
                
                document.getElementById('total-evaluations').textContent = totalEvaluationsCount;

            } catch (error) {
                console.error('Error cargando estad√≠sticas del dashboard:', error);
            }
        }

        window.loadPlayers = async function() {
            const content = document.getElementById('players-content');
            content.innerHTML = '<div class="loading"><i class="bx bx-loader-alt"></i>Cargando jugadores...</div>';

            try {
                const snapshot = await db.collection('futbol_users').get();
                allPlayers = [];
                
                snapshot.forEach(doc => {
                    allPlayers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Renderizar tabla
                renderPlayersTable();

            } catch (error) {
                console.error('Error cargando jugadores:', error);
                content.innerHTML = '<div style="padding: 20px; color: var(--error);">Error cargando jugadores</div>';
            }
        }

        // Helper function to get player stats with correct priority
        function getPlayerStats(player) {
            // PRIORITY 1: Direct stats (NEW UNIFIED STRUCTURE)
            if (player.pac !== undefined || player.sho !== undefined) {
                const stats = {
                    pac: player.pac || 0,
                    sho: player.sho || 0,
                    pas: player.pas || 0,
                    dri: player.dri || 0,
                    def: player.def || 0,
                    phy: player.phy || 0
                };
                stats.ovr = player.ovr || ((stats.pac + stats.sho + stats.pas + stats.dri + stats.def + stats.phy) / 6);
                return stats;
            }
            
            // PRIORITY 2: Nested attributes (LEGACY STRUCTURE)
            if (player.attributes && Object.keys(player.attributes).length > 0) {
                const stats = {
                    pac: player.attributes.pac || 0,
                    sho: player.attributes.sho || 0,
                    pas: player.attributes.pas || 0,
                    dri: player.attributes.dri || 0,
                    def: player.attributes.def || 0,
                    phy: player.attributes.phy || 0
                };
                stats.ovr = player.ovr || ((stats.pac + stats.sho + stats.pas + stats.dri + stats.def + stats.phy) / 6);
                return stats;
            }
            
            // PRIORITY 3: Default values
            const stats = { pac: 0, sho: 0, pas: 0, dri: 0, def: 0, phy: 0 };
            stats.ovr = player.ovr || 0;
            return stats;
        }

        function renderPlayersTable() {
            const content = document.getElementById('players-content');
            
            if (allPlayers.length === 0) {
                content.innerHTML = '<div style="padding: 20px;">No se encontraron jugadores</div>';
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Posici√≥n</th>
                            <th>OVR</th>
                            <th>PAC</th>
                            <th>SHO</th>
                            <th>PAS</th>
                            <th>DRI</th>
                            <th>DEF</th>
                            <th>PHY</th>
                            <th>√öltima Conexi√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allPlayers.map(player => {
                            const stats = getPlayerStats(player);
                            return `
                            <tr>
                                <td>${player.displayName || player.name || 'Sin nombre'}</td>
                                <td>${player.email || 'Sin email'}</td>
                                <td>
                                    <span style="background: var(--primary); color: var(--dark); padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                        ${player.position || 'N/A'}
                                    </span>
                                </td>
                                <td>
                                    <span style="background: var(--secondary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                        ${player.ovr || 0}
                                    </span>
                                </td>
                                <td>${stats.pac}</td>
                                <td>${stats.sho}</td>
                                <td>${stats.pas}</td>
                                <td>${stats.dri}</td>
                                <td>${stats.def}</td>
                                <td>${stats.phy}</td>
                                <td>${player.lastLogin ? new Date(player.lastLogin).toLocaleDateString() : 'Nunca'}</td>
                                <td>
                                    <button class="btn btn-secondary" onclick="window.editPlayer('${player.id}')" style="margin-right: 5px;">
                                        <i class='bx bx-edit'></i>
                                    </button>
                                    <button class="btn btn-danger" onclick="window.deletePlayer('${player.id}')">
                                        <i class='bx bx-trash'></i>
                                    </button>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
            
            content.innerHTML = tableHTML;
        }

        window.loadMatches = async function() {
            const content = document.getElementById('matches-content');
            content.innerHTML = '<div class="loading"><i class="bx bx-loader-alt"></i>Cargando partidos...</div>';

            try {
                // Buscar en m√∫ltiples colecciones de partidos
                const collections = ['matches', 'collaborative_matches', 'futbol_matches'];
                allMatches = [];
                
                for (const collectionName of collections) {
                    try {
                        const snapshot = await db.collection(collectionName).get();
                        console.log(`üìä ${collectionName}: ${snapshot.size} documentos`);
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            allMatches.push({
                                id: doc.id,
                                collection: collectionName,
                                ...data
                            });
                        });
                    } catch (err) {
                        console.warn(`Collection ${collectionName} no existe:`, err.message);
                    }
                }

                console.log(`‚úÖ Total partidos cargados: ${allMatches.length}`);
                
                // Ordenar por fecha
                allMatches.sort((a, b) => {
                    const dateA = a.date || a.timestamp || a.createdAt || 0;
                    const dateB = b.date || b.timestamp || b.createdAt || 0;
                    return new Date(dateB) - new Date(dateA);
                });

                // Renderizar tabla
                renderMatchesTable();

            } catch (error) {
                console.error('Error cargando partidos:', error);
                content.innerHTML = '<div style="padding: 20px; color: var(--error);">Error cargando partidos: ' + error.message + '</div>';
            }
        }

        function renderMatchesTable() {
            const content = document.getElementById('matches-content');
            
            if (allMatches.length === 0) {
                content.innerHTML = '<div style="padding: 20px;">No se encontraron partidos</div>';
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>T√≠tulo</th>
                            <th>Colecci√≥n</th>
                            <th>Estado</th>
                            <th>Participantes</th>
                            <th>Detalles</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allMatches.map(match => {
                            const date = match.date || match.timestamp || match.createdAt;
                            const dateStr = date ? new Date(date).toLocaleDateString() : 'N/A';
                            
                            // Calcular participantes de forma m√°s completa
                            let participants = 0;
                            let participantsList = [];
                            
                            // Verificar diferentes estructuras de datos
                            if (match.teams && Array.isArray(match.teams)) {
                                match.teams.forEach(team => {
                                    if (team.players && Array.isArray(team.players)) {
                                        participants += team.players.length;
                                        team.players.forEach(p => participantsList.push(p.name || p.displayName || 'Jugador'));
                                    }
                                });
                            } else if (match.participants && Array.isArray(match.participants)) {
                                participants = match.participants.length;
                                match.participants.forEach(p => participantsList.push(p.name || p.displayName || 'Jugador'));
                            } else if (match.players) {
                                if (Array.isArray(match.players)) {
                                    participants = match.players.length;
                                    match.players.forEach(p => participantsList.push(p.name || p.displayName || 'Jugador'));
                                } else if (typeof match.players === 'object') {
                                    participants = Object.keys(match.players).length;
                                    Object.values(match.players).forEach(p => participantsList.push(p.name || p.displayName || 'Jugador'));
                                }
                            } else if (match.teamA && match.teamB) {
                                // Para estructura teamA/teamB
                                if (match.teamA.players) participants += match.teamA.players.length || 0;
                                if (match.teamB.players) participants += match.teamB.players.length || 0;
                            } else if (match.team1 && match.team2) {
                                // Para estructura team1/team2
                                if (match.team1.players) participants += match.team1.players.length || 0;
                                if (match.team2.players) participants += match.team2.players.length || 0;
                            }
                            
                            const status = match.status || match.state || match.isFinished ? 'completed' : 'pending';
                            const title = match.title || match.name || match.type || match.matchType || 'Sin t√≠tulo';
                            
                            // Debug info
                            console.log(`Partido ${match.id}: ${participants} participantes encontrados`, match);
                            
                            return `
                                <tr>
                                    <td>${dateStr}</td>
                                    <td>${title}</td>
                                    <td>
                                        <span style="background: var(--primary); color: var(--dark); padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                                            ${match.collection}
                                        </span>
                                    </td>
                                    <td>
                                        <span style="background: ${status === 'completed' || status === 'finished' ? 'var(--success)' : 'var(--warning)'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                                            ${status}
                                        </span>
                                    </td>
                                    <td title="${participantsList.join(', ')}">${participants} participantes</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="window.viewMatchDetails('${match.id}', '${match.collection}')" style="font-size: 12px;">
                                            <i class='bx bx-show'></i>
                                            Ver
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-danger" onclick="window.deleteMatch('${match.id}', '${match.collection}')" style="font-size: 12px;">
                                            <i class='bx bx-trash'></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            content.innerHTML = tableHTML;
        }

        window.loadEvaluations = async function() {
            const content = document.getElementById('evaluations-content');
            content.innerHTML = '<div class="loading"><i class="bx bx-loader-alt"></i>Cargando evaluaciones...</div>';

            try {
                // Primero asegurar que los partidos est√°n cargados
                if (allMatches.length === 0) {
                    await loadMatches();
                }
                
                // NUEVO: Buscar evaluaciones en sistema unificado
                const collections = ['evaluation_logs', 'evaluations', 'player_evaluations', 'match_evaluations', 'playerEvaluations'];
                allEvaluations = [];
                
                for (const collectionName of collections) {
                    try {
                        const snapshot = await db.collection(collectionName).get();
                        console.log(`üìä Evaluaciones en ${collectionName}: ${snapshot.size} documentos`);
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            let enrichedEval;
                            
                            if (collectionName === 'evaluation_logs') {
                                // NUEVO SISTEMA UNIFICADO: Procesar evaluation_logs
                                enrichedEval = {
                                    id: doc.id,
                                    collection: 'evaluation_logs ‚ö° (Nuevo)',
                                    playerName: data.evaluatedUserName || data.playerName || 'Desconocido',
                                    evaluatorName: data.evaluatorName || data.evaluatorId || 'Sistema',
                                    matchId: data.matchId || 'N/A',
                                    timestamp: data.timestamp || Date.now(),
                                    evaluationType: data.evaluationType || 'unknown',
                                    evaluationData: data.evaluationData || {},
                                    
                                    // Calcular estad√≠sticas desde changes
                                    oldOVR: data.ovrChange?.before || 0,
                                    newOVR: data.ovrChange?.after || 0,
                                    ovrChange: data.ovrChange?.change || 0,
                                    
                                    // Cambios detallados por atributo
                                    changes: data.changes || {},
                                    attributeChanges: Object.keys(data.changes || {}).map(attr => ({
                                        attribute: attr.toUpperCase(),
                                        before: data.changes[attr]?.before || 0,
                                        after: data.changes[attr]?.after || 0,
                                        change: data.changes[attr]?.change || 0
                                    })),
                                    
                                    // Calcular stats para compatibilidad
                                    oldStats: Object.keys(data.changes || {}).reduce((stats, attr) => {
                                        stats[attr] = data.changes[attr]?.before || 0;
                                        return stats;
                                    }, {}),
                                    newStats: Object.keys(data.changes || {}).reduce((stats, attr) => {
                                        stats[attr] = data.changes[attr]?.after || 0;
                                        return stats;
                                    }, {}),
                                    
                                    ...data
                                };
                            } else {
                                // SISTEMA LEGACY: Procesar otras colecciones
                                enrichedEval = {
                                    id: doc.id,
                                    collection: collectionName,
                                    playerName: data.playerName || data.player || data.userName || 'Desconocido',
                                    matchId: data.matchId || data.match || data.gameId || 'N/A',
                                    timestamp: data.timestamp || data.date || data.createdAt || Date.now(),
                                    // Estad√≠sticas antes
                                    oldOVR: data.oldOVR || data.previousOVR || data.beforeOVR || data.before?.ovr || 0,
                                    oldStats: data.oldStats || data.previousStats || data.before || {
                                        pac: data.oldPac || 0,
                                        sho: data.oldSho || 0,
                                        pas: data.oldPas || 0,
                                        dri: data.oldDri || 0,
                                        def: data.oldDef || 0,
                                        phy: data.oldPhy || 0
                                    },
                                    // Estad√≠sticas despu√©s
                                    newOVR: data.newOVR || data.currentOVR || data.afterOVR || data.after?.ovr || data.ovr || 0,
                                    newStats: data.newStats || data.currentStats || data.after || {
                                        pac: data.newPac || data.pac || 0,
                                        sho: data.newSho || data.sho || 0,
                                        pas: data.newPas || data.pas || 0,
                                        dri: data.newDri || data.dri || 0,
                                        def: data.newDef || data.def || 0,
                                        phy: data.newPhy || data.phy || 0
                                    },
                                    ...data
                                };
                            }
                            
                            allEvaluations.push(enrichedEval);
                        });
                    } catch (err) {
                        console.warn(`Collection ${collectionName} no existe o error:`, err.message);
                    }
                }

                // Buscar en partidos que tengan evaluaciones embebidas
                console.log('üîç Buscando evaluaciones embebidas en partidos...');
                for (const match of allMatches) {
                    // Diferentes estructuras posibles de evaluaciones
                    if (match.evaluations) {
                        Object.entries(match.evaluations).forEach(([playerId, evaluation]) => {
                            allEvaluations.push({
                                id: `${match.id}_${playerId}`,
                                collection: 'embedded-evaluations',
                                matchId: match.id,
                                playerId: playerId,
                                playerName: evaluation.playerName || evaluation.name || playerId,
                                timestamp: match.timestamp || match.date,
                                oldOVR: evaluation.oldOVR || evaluation.before?.ovr || 0,
                                newOVR: evaluation.newOVR || evaluation.after?.ovr || evaluation.ovr || 0,
                                ...evaluation
                            });
                        });
                    }
                    
                    // Buscar en playerEvaluations dentro del partido
                    if (match.playerEvaluations) {
                        Object.entries(match.playerEvaluations).forEach(([playerId, evaluation]) => {
                            allEvaluations.push({
                                id: `${match.id}_pe_${playerId}`,
                                collection: 'embedded-playerEvals',
                                matchId: match.id,
                                playerId: playerId,
                                playerName: evaluation.playerName || evaluation.name || playerId,
                                timestamp: match.timestamp || match.date,
                                ...evaluation
                            });
                        });
                    }
                    
                    // Buscar en teams para evaluaciones individuales
                    if (match.teams && Array.isArray(match.teams)) {
                        match.teams.forEach((team, teamIndex) => {
                            if (team.players && Array.isArray(team.players)) {
                                team.players.forEach(player => {
                                    if (player.evaluation || player.stats) {
                                        allEvaluations.push({
                                            id: `${match.id}_t${teamIndex}_${player.id || player.name}`,
                                            collection: 'embedded-team',
                                            matchId: match.id,
                                            playerId: player.id || player.name,
                                            playerName: player.name || player.displayName || 'Jugador',
                                            timestamp: match.timestamp || match.date,
                                            oldOVR: player.oldOVR || player.previousOVR || 0,
                                            newOVR: player.newOVR || player.ovr || 0,
                                            ...(player.evaluation || player.stats || {})
                                        });
                                    }
                                });
                            }
                        });
                    }
                }

                console.log(`‚úÖ Total evaluaciones cargadas: ${allEvaluations.length}`);
                
                // Ordenar por fecha
                allEvaluations.sort((a, b) => {
                    const dateA = a.timestamp || a.date || a.createdAt || 0;
                    const dateB = b.timestamp || b.date || b.createdAt || 0;
                    return new Date(dateB) - new Date(dateA);
                });

                // Renderizar tabla
                renderEvaluationsTable();

            } catch (error) {
                console.error('Error cargando evaluaciones:', error);
                content.innerHTML = '<div style="padding: 20px; color: var(--error);">Error cargando evaluaciones: ' + error.message + '</div>';
            }
        }

        function renderEvaluationsTable() {
            const content = document.getElementById('evaluations-content');
            
            if (allEvaluations.length === 0) {
                content.innerHTML = '<div style="padding: 20px;">No se encontraron evaluaciones</div>';
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Jugador</th>
                            <th>Evaluador</th>
                            <th>Partido</th>
                            <th>Colecci√≥n</th>
                            <th>OVR Antes</th>
                            <th>OVR Despu√©s</th>
                            <th>Cambio</th>
                            <th>Detalles</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allEvaluations.map(evaluation => {
                            const date = evaluation.timestamp || evaluation.date || evaluation.createdAt;
                            const dateStr = date ? new Date(date).toLocaleDateString() : 'N/A';
                            
                            const playerName = evaluation.playerName || evaluation.player || evaluation.playerId || 'N/A';
                            const matchId = evaluation.matchId || evaluation.match || 'N/A';
                            
                            const oldOVR = evaluation.oldOVR || evaluation.previousOVR || evaluation.before?.ovr || 0;
                            const newOVR = evaluation.newOVR || evaluation.currentOVR || evaluation.after?.ovr || evaluation.ovr || 0;
                            const change = newOVR - oldOVR;
                            const changeColor = change > 0 ? 'var(--success)' : change < 0 ? 'var(--error)' : 'var(--text-secondary)';
                            
                            return `
                                <tr>
                                    <td>${dateStr}</td>
                                    <td>${playerName}</td>
                                    <td>
                                        <span style="color: var(--warning); font-weight: 500;">
                                            ${evaluation.evaluatorName || evaluation.evaluatorId || 'N/A'}
                                        </span>
                                    </td>
                                    <td>${matchId.length > 15 ? matchId.substring(0, 15) + '...' : matchId}</td>
                                    <td>
                                        <span style="background: var(--primary); color: var(--dark); padding: 2px 6px; border-radius: 4px; font-size: 10px;">
                                            ${evaluation.collection}
                                        </span>
                                    </td>
                                    <td>
                                        <span style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; color: white;">
                                            ${oldOVR.toFixed(1)}
                                        </span>
                                    </td>
                                    <td>
                                        <span style="background: var(--secondary); color: white; padding: 2px 8px; border-radius: 4px;">
                                            ${newOVR.toFixed(1)}
                                        </span>
                                    </td>
                                    <td>
                                        <span style="color: ${changeColor}; font-weight: 600; font-size: 14px;">
                                            ${change > 0 ? '+' : ''}${change.toFixed(1)}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="window.viewEvaluationDetails('${evaluation.id}', '${evaluation.collection}')" style="font-size: 12px;">
                                            <i class='bx bx-detail'></i>
                                            Ver
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-danger" onclick="window.deleteEvaluation('${evaluation.id}', '${evaluation.collection}')" style="font-size: 12px;">
                                            <i class='bx bx-trash'></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            content.innerHTML = tableHTML;
        }

        // Action Functions
        window.editPlayer = async function(playerId) {
            const player = allPlayers.find(p => p.id === playerId);
            if (!player) {
                alert('Jugador no encontrado');
                return;
            }
            
            const newName = prompt('Nuevo nombre:', player.displayName || player.name || '');
            if (newName === null) return;
            
            const newPosition = prompt('Nueva posici√≥n:', player.position || '');
            if (newPosition === null) return;
            
            const newOVR = prompt('Nuevo OVR:', player.ovr || 0);
            if (newOVR === null) return;
            
            try {
                const updates = {
                    displayName: newName,
                    position: newPosition,
                    ovr: parseInt(newOVR)
                };
                
                await db.collection('futbol_users').doc(playerId).update(updates);
                alert('Jugador actualizado exitosamente');
                loadPlayers();
                loadDashboardStats();
            } catch (error) {
                console.error('Error actualizando jugador:', error);
                alert('Error actualizando jugador: ' + error.message);
            }
        }

        window.deletePlayer = async function(playerId) {
            const player = allPlayers.find(p => p.id === playerId);
            if (!player) {
                alert('Jugador no encontrado');
                return;
            }
            
            if (confirm(`¬øEst√°s seguro de que quieres eliminar a ${player.displayName || player.name || 'este jugador'}?`)) {
                try {
                    await db.collection('futbol_users').doc(playerId).delete();
                    alert('Jugador eliminado exitosamente');
                    loadPlayers();
                    loadDashboardStats();
                } catch (error) {
                    console.error('Error eliminando jugador:', error);
                    alert('Error eliminando jugador: ' + error.message);
                }
            }
        }

        window.viewMatchDetails = function(matchId, collection) {
            const match = allMatches.find(m => m.id === matchId && m.collection === collection);
            if (!match) {
                alert('Partido no encontrado');
                return;
            }
            
            // Extraer informaci√≥n detallada de participantes
            let participantsList = [];
            let teamsInfo = '';
            
            if (match.teams && Array.isArray(match.teams)) {
                teamsInfo = '\n\nEQUIPOS:\n';
                match.teams.forEach((team, index) => {
                    teamsInfo += `\nEquipo ${index + 1}: ${team.name || `Equipo ${index + 1}`}\n`;
                    if (team.players && Array.isArray(team.players)) {
                        team.players.forEach(p => {
                            const playerName = p.name || p.displayName || 'Jugador';
                            participantsList.push(playerName);
                            teamsInfo += `  - ${playerName} (OVR: ${p.ovr || 'N/A'})\n`;
                        });
                    }
                });
            } else if (match.teamA && match.teamB) {
                teamsInfo = '\n\nEQUIPOS:\n';
                teamsInfo += `\nEquipo A:\n`;
                if (match.teamA.players) {
                    match.teamA.players.forEach(p => {
                        const playerName = p.name || p.displayName || 'Jugador';
                        participantsList.push(playerName);
                        teamsInfo += `  - ${playerName}\n`;
                    });
                }
                teamsInfo += `\nEquipo B:\n`;
                if (match.teamB.players) {
                    match.teamB.players.forEach(p => {
                        const playerName = p.name || p.displayName || 'Jugador';
                        participantsList.push(playerName);
                        teamsInfo += `  - ${playerName}\n`;
                    });
                }
            } else if (match.participants) {
                teamsInfo = '\n\nPARTICIPANTES:\n';
                match.participants.forEach(p => {
                    const playerName = p.name || p.displayName || 'Jugador';
                    participantsList.push(playerName);
                    teamsInfo += `  - ${playerName}\n`;
                });
            } else if (match.players) {
                teamsInfo = '\n\nJUGADORES:\n';
                if (typeof match.players === 'object') {
                    Object.entries(match.players).forEach(([key, p]) => {
                        const playerName = p.name || p.displayName || key;
                        participantsList.push(playerName);
                        teamsInfo += `  - ${playerName}\n`;
                    });
                }
            }
            
            const date = match.date || match.timestamp || match.createdAt;
            const dateStr = date ? new Date(date).toLocaleString() : 'N/A';
            
            // Buscar evaluaciones asociadas
            const matchEvaluations = allEvaluations.filter(e => 
                e.matchId === matchId || e.match === matchId
            );
            
            let evaluationsInfo = '';
            if (matchEvaluations.length > 0) {
                evaluationsInfo = `\n\nEVALUACIONES (${matchEvaluations.length}):\n`;
                matchEvaluations.forEach(eval => {
                    const oldOVR = eval.oldOVR || eval.previousOVR || 0;
                    const newOVR = eval.newOVR || eval.currentOVR || eval.ovr || 0;
                    const change = newOVR - oldOVR;
                    evaluationsInfo += `  - ${eval.playerName}: ${oldOVR} ‚Üí ${newOVR} (${change > 0 ? '+' : ''}${change.toFixed(1)})\n`;
                });
            }
            
            const details = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
DETALLES COMPLETOS DEL PARTIDO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìã INFORMACI√ìN GENERAL
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
T√≠tulo: ${match.title || match.name || match.type || match.matchType || 'Sin t√≠tulo'}
Fecha: ${dateStr}
ID: ${matchId}
Colecci√≥n: ${collection}
Estado: ${match.status || match.state || (match.isFinished ? 'completed' : 'pending')}
Total Participantes: ${participantsList.length}

${teamsInfo}
${evaluationsInfo}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
DATOS COMPLETOS (JSON)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
${JSON.stringify(match, null, 2)}`;
            
            alert(details);
        }

        window.deleteMatch = async function(matchId, collection) {
            const match = allMatches.find(m => m.id === matchId && m.collection === collection);
            if (!match) {
                alert('Partido no encontrado');
                return;
            }
            
            if (confirm(`¬øEst√°s seguro de que quieres eliminar el partido "${match.title || match.name || 'Sin t√≠tulo'}"?`)) {
                try {
                    await db.collection(collection).doc(matchId).delete();
                    alert('Partido eliminado exitosamente');
                    loadMatches();
                    loadDashboardStats();
                } catch (error) {
                    console.error('Error eliminando partido:', error);
                    alert('Error eliminando partido: ' + error.message);
                }
            }
        }

        window.viewEvaluationDetails = function(evaluationId, collection) {
            const evaluation = allEvaluations.find(e => e.id === evaluationId && e.collection === collection);
            if (!evaluation) {
                showError('Evaluaci√≥n no encontrada');
                return;
            }
            
            // Debug: Mostrar estructura de datos
            console.log('üîç Datos de evaluaci√≥n encontrados:', evaluation);
            console.log('üîç Colecci√≥n:', collection);
            console.log('üîç ID:', evaluationId);
            
            // Calcular cambios detallados - Nuevo sistema unificado
            const rawOldStats = evaluation.oldStats || evaluation.before || evaluation.ovrChange?.beforeStats || {};
            const rawNewStats = evaluation.newStats || evaluation.after || evaluation.ovrChange?.afterStats || {};
            const rawCurrentStats = evaluation.stats || {};
            
            // Use helper function for consistent stat extraction
            const oldStats = Object.keys(rawOldStats).length > 0 ? getPlayerStats(rawOldStats) : {};
            const newStats = Object.keys(rawNewStats).length > 0 ? getPlayerStats(rawNewStats) : {};
            const currentStats = Object.keys(rawCurrentStats).length > 0 ? getPlayerStats(rawCurrentStats) : {};
            
            // OVR calculation - mejorado para nuevo sistema
            const oldOVR = evaluation.ovrChange?.before || evaluation.oldOVR || evaluation.previousOVR || oldStats.ovr || 0;
            const newOVR = evaluation.ovrChange?.after || evaluation.newOVR || evaluation.currentOVR || newStats.ovr || evaluation.ovr || currentStats.ovr || 0;
            
            console.log('üìä OVR calculado:', { oldOVR, newOVR, ovrChange: evaluation.ovrChange });
            
            const statsChanges = {
                pac: (newStats.pac || currentStats.pac || 0) - (oldStats.pac || 0),
                sho: (newStats.sho || currentStats.sho || 0) - (oldStats.sho || 0),
                pas: (newStats.pas || currentStats.pas || 0) - (oldStats.pas || 0),
                dri: (newStats.dri || currentStats.dri || 0) - (oldStats.dri || 0),
                def: (newStats.def || currentStats.def || 0) - (oldStats.def || 0),
                phy: (newStats.phy || currentStats.phy || 0) - (oldStats.phy || 0)
            };
            
            const modalContent = `
                <div class="evaluation-full-detail">
                    <!-- Informaci√≥n General -->
                    <div class="evaluation-section">
                        <h3 class="evaluation-section-title">
                            <i class='bx bx-info-circle'></i>
                            Informaci√≥n General
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <span style="color: var(--text-secondary);">Jugador Evaluado:</span>
                                <strong style="color: var(--primary); display: block; font-size: 18px;">
                                    ${evaluation.evaluatedUserName || evaluation.playerName || evaluation.player || evaluation.playerId || evaluation.evaluatedUserId || 'N/A'}
                                </strong>
                            </div>
                            ${evaluation.evaluatorName ? `
                            <div>
                                <span style="color: var(--text-secondary);">Evaluador:</span>
                                <strong style="color: var(--warning); display: block; font-size: 16px;">
                                    ${evaluation.evaluatorName}
                                </strong>
                            </div>
                            ` : ''}
                            <div>
                                <span style="color: var(--text-secondary);">Partido:</span>
                                <strong style="display: block;">
                                    ${evaluation.matchId || evaluation.match || 'N/A'}
                                </strong>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary);">Fecha:</span>
                                <strong style="display: block;">
                                    ${evaluation.timestamp ? new Date(evaluation.timestamp).toLocaleString() : 'N/A'}
                                </strong>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary);">Sistema:</span>
                                <span style="background: ${collection.includes('evaluation_logs') ? 'var(--success)' : 'var(--primary)'}; color: var(--dark); padding: 2px 8px; border-radius: 4px; display: inline-block; margin-top: 5px;">
                                    ${collection}
                                </span>
                            </div>
                            ${evaluation.evaluationType ? `
                            <div>
                                <span style="color: var(--text-secondary);">Tipo de Evaluaci√≥n:</span>
                                <strong style="display: block; color: var(--secondary);">
                                    ${evaluation.evaluationType}
                                </strong>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${evaluation.changes ? `
                    <!-- NUEVO SISTEMA: Cambios Detallados -->
                    <div class="evaluation-section" style="border: 2px solid var(--success); background: rgba(16, 185, 129, 0.05);">
                        <h3 class="evaluation-section-title" style="color: var(--success);">
                            <i class='bx bx-transfer-alt'></i>
                            Sistema Unificado - Cambios Detallados
                        </h3>
                        <div style="display: grid; gap: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                                <span style="font-weight: 600;">Cambio Total OVR:</span>
                                <span style="color: ${(newOVR - oldOVR) > 0 ? 'var(--success)' : (newOVR - oldOVR) < 0 ? 'var(--error)' : 'var(--text-secondary)'}; font-weight: 700; font-size: 18px;">
                                    ${(newOVR - oldOVR) > 0 ? '+' : ''}${(newOVR - oldOVR).toFixed(1)}
                                </span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                                ${evaluation.attributeChanges ? evaluation.attributeChanges.map(change => `
                                    <div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px; text-align: center;">
                                        <div style="font-weight: 600; color: var(--primary); margin-bottom: 5px;">${change.attribute}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${change.before} ‚Üí ${change.after}</div>
                                        <div style="color: ${change.change > 0 ? 'var(--success)' : change.change < 0 ? 'var(--error)' : 'var(--text-secondary)'}; font-weight: 600;">
                                            ${change.change > 0 ? '+' : ''}${change.change}
                                        </div>
                                    </div>
                                `).join('') : ''}
                            </div>
                            ${evaluation.evaluationData ? `
                            <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                                <h4 style="color: var(--warning); margin-bottom: 15px;">üìä Resumen de Evaluaciones</h4>
                                <div style="display: grid; gap: 12px;">
                                    ${evaluation.evaluationData.averageRating ? `<div style="font-size: 16px;"><strong>Rating Promedio:</strong> <span style="color: var(--primary); font-weight: 700;">${evaluation.evaluationData.averageRating}/10</span></div>` : ''}
                                    ${evaluation.evaluationData.totalGoals !== undefined ? `<div><strong>Goles Totales:</strong> <span style="color: var(--secondary);">${evaluation.evaluationData.totalGoals}</span></div>` : ''}
                                    ${evaluation.evaluationData.totalEvaluators ? `<div><strong>Evaluadores Participantes:</strong> ${evaluation.evaluationData.totalEvaluators}</div>` : ''}
                                    ${evaluation.evaluationData.participationRate ? `<div><strong>Participaci√≥n:</strong> ${(evaluation.evaluationData.participationRate * 100).toFixed(1)}%</div>` : ''}
                                    ${evaluation.evaluationData.uniqueTags && evaluation.evaluationData.uniqueTags.length > 0 ? `<div><strong>Tags Aplicados:</strong> <div style="margin-top: 5px;">${evaluation.evaluationData.uniqueTags.map(tag => `<span style="background: var(--secondary); color: white; padding: 2px 6px; border-radius: 3px; margin: 2px; display: inline-block; font-size: 11px;">${tag}</span>`).join('')}</div></div>` : ''}
                                </div>
                            </div>
                            
                            ${evaluation.evaluationData.evaluationsByParticipant ? `
                            <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                                <h4 style="color: var(--warning); margin-bottom: 15px;">üë• Evaluaciones por Participante</h4>
                                <div style="display: grid; gap: 10px;">
                                    ${Object.entries(evaluation.evaluationData.evaluationsByParticipant).map(([evaluatorId, data]) => `
                                        <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; border-left: 3px solid var(--primary);">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                                <strong style="color: var(--primary);">${data.evaluatorName || evaluatorId}</strong>
                                                <span style="background: var(--success); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 600;">${data.rating}/10</span>
                                            </div>
                                            ${data.goals > 0 ? `<div style="font-size: 12px; color: var(--text-secondary);">‚öΩ Goles: ${data.goals}</div>` : ''}
                                            ${data.tags && data.tags.length > 0 ? `<div style="font-size: 12px; margin-top: 5px;">${data.tags.map(tag => `<span style="background: rgba(0,255,157,0.2); color: var(--primary); padding: 1px 4px; border-radius: 2px; margin: 1px; font-size: 10px;">${tag}</span>`).join('')}</div>` : ''}
                                            ${data.notes ? `<div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px; font-style: italic;">"${data.notes}"</div>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Comparaci√≥n de Estad√≠sticas -->
                    <div class="evaluation-section">
                        <h3 class="evaluation-section-title">
                            <i class='bx bx-transfer'></i>
                            Comparaci√≥n de Estad√≠sticas
                        </h3>
                        <div class="stats-comparison">
                            <!-- Antes -->
                            <div class="stats-before">
                                <h4 style="color: var(--text-secondary); margin-bottom: 15px;">ANTES DEL PARTIDO</h4>
                                <div class="stat-item">
                                    <span class="stat-name">OVR</span>
                                    <span class="stat-value">${oldOVR.toFixed(1)}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-name">PAC</span>
                                    <span class="stat-value">${oldStats.pac || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-name">SHO</span>
                                    <span class="stat-value">${oldStats.sho || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-name">PAS</span>
                                    <span class="stat-value">${oldStats.pas || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-name">DRI</span>
                                    <span class="stat-value">${oldStats.dri || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-name">DEF</span>
                                    <span class="stat-value">${oldStats.def || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-name">PHY</span>
                                    <span class="stat-value">${oldStats.phy || 0}</span>
                                </div>
                            </div>
                            
                            <!-- Flecha -->
                            <div class="stats-arrow">
                                <i class='bx bx-right-arrow-alt'></i>
                            </div>
                            
                            <!-- Despu√©s -->
                            <div class="stats-after">
                                <h4 style="color: var(--primary); margin-bottom: 15px;">DESPU√âS DEL PARTIDO</h4>
                                <div class="stat-item">
                                    <span class="stat-name">OVR</span>
                                    <span class="stat-value">
                                        ${newOVR.toFixed(1)}
                                        <span class="stat-change ${newOVR - oldOVR > 0 ? 'positive' : newOVR - oldOVR < 0 ? 'negative' : 'neutral'}">
                                            ${newOVR - oldOVR > 0 ? '+' : ''}${(newOVR - oldOVR).toFixed(1)}
                                        </span>
                                    </span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-name">PAC</span>
                                    <span class="stat-value">
                                        ${newStats.pac || currentStats.pac || 0}
                                        ${statsChanges.pac !== 0 ? `<span class="stat-change ${statsChanges.pac > 0 ? 'positive' : 'negative'}">${statsChanges.pac > 0 ? '+' : ''}${statsChanges.pac}</span>` : ''}
                                    </span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-name">SHO</span>
                                    <span class="stat-value">
                                        ${newStats.sho || currentStats.sho || 0}
                                        ${statsChanges.sho !== 0 ? `<span class="stat-change ${statsChanges.sho > 0 ? 'positive' : 'negative'}">${statsChanges.sho > 0 ? '+' : ''}${statsChanges.sho}</span>` : ''}
                                    </span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-name">PAS</span>
                                    <span class="stat-value">
                                        ${newStats.pas || currentStats.pas || 0}
                                        ${statsChanges.pas !== 0 ? `<span class="stat-change ${statsChanges.pas > 0 ? 'positive' : 'negative'}">${statsChanges.pas > 0 ? '+' : ''}${statsChanges.pas}</span>` : ''}
                                    </span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-name">DRI</span>
                                    <span class="stat-value">
                                        ${newStats.dri || currentStats.dri || 0}
                                        ${statsChanges.dri !== 0 ? `<span class="stat-change ${statsChanges.dri > 0 ? 'positive' : 'negative'}">${statsChanges.dri > 0 ? '+' : ''}${statsChanges.dri}</span>` : ''}
                                    </span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-name">DEF</span>
                                    <span class="stat-value">
                                        ${newStats.def || currentStats.def || 0}
                                        ${statsChanges.def !== 0 ? `<span class="stat-change ${statsChanges.def > 0 ? 'positive' : 'negative'}">${statsChanges.def > 0 ? '+' : ''}${statsChanges.def}</span>` : ''}
                                    </span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-name">PHY</span>
                                    <span class="stat-value">
                                        ${newStats.phy || currentStats.phy || 0}
                                        ${statsChanges.phy !== 0 ? `<span class="stat-change ${statsChanges.phy > 0 ? 'positive' : 'negative'}">${statsChanges.phy > 0 ? '+' : ''}${statsChanges.phy}</span>` : ''}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- An√°lisis de Rendimiento -->
                    <div class="evaluation-section">
                        <h3 class="evaluation-section-title">
                            <i class='bx bx-chart'></i>
                            An√°lisis de Rendimiento
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div class="highlight-stat">
                                <h5 style="margin: 0 0 10px 0; color: var(--primary);">C√°lculo de OVR</h5>
                                <div>Promedio de Estad√≠sticas: <strong>${(((newStats.pac || currentStats.pac || 0) + (newStats.sho || currentStats.sho || 0) + (newStats.pas || currentStats.pas || 0) + (newStats.dri || currentStats.dri || 0) + (newStats.def || currentStats.def || 0) + (newStats.phy || currentStats.phy || 0)) / 6).toFixed(2)}</strong></div>
                                <div>OVR Final: <strong style="color: var(--secondary);">${newOVR.toFixed(1)}</strong></div>
                            </div>
                            <div class="highlight-stat">
                                <h5 style="margin: 0 0 10px 0; color: var(--primary);">Rendimiento General</h5>
                                <div style="font-size: 20px; font-weight: 700; color: ${newOVR > oldOVR ? 'var(--success)' : newOVR < oldOVR ? 'var(--error)' : 'var(--text-secondary)'};">
                                    ${newOVR > oldOVR ? 'MEJORADO ‚úÖ' : newOVR < oldOVR ? 'DISMINUIDO ‚ùå' : 'MANTENIDO ‚û°Ô∏è'}
                                </div>
                                <div>Cambio Total: <strong>${newOVR - oldOVR > 0 ? '+' : ''}${(newOVR - oldOVR).toFixed(1)} puntos</strong></div>
                            </div>
                        </div>
                    </div>

                    <!-- Datos Adicionales -->
                    ${evaluation.rating || evaluation.goals || evaluation.tags || evaluation.notes ? `
                    <div class="evaluation-section">
                        <h3 class="evaluation-section-title">
                            <i class='bx bx-detail'></i>
                            Detalles de la Evaluaci√≥n
                        </h3>
                        <div style="display: grid; gap: 10px;">
                            ${evaluation.rating ? `<div><strong>Rating:</strong> ${evaluation.rating}/10</div>` : ''}
                            ${evaluation.goals ? `<div><strong>Goles:</strong> ${evaluation.goals}</div>` : ''}
                            ${evaluation.tags && evaluation.tags.length > 0 ? `<div><strong>Tags:</strong> ${evaluation.tags.join(', ')}</div>` : ''}
                            ${evaluation.notes ? `<div><strong>Notas:</strong> ${evaluation.notes}</div>` : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            try {
                // Abrir modal con el contenido
                const playerName = evaluation.evaluatedUserName || evaluation.playerName || evaluation.player || evaluation.evaluatedUserId || 'Jugador Desconocido';
                document.getElementById('modal-title').textContent = `Evaluaci√≥n de ${playerName}`;
                document.getElementById('modal-body').innerHTML = modalContent;
                document.getElementById('detail-modal').classList.add('active');
                
                console.log('‚úÖ Modal de detalles abierto exitosamente');
            } catch (error) {
                console.error('‚ùå Error abriendo modal:', error);
                showError('Error mostrando detalles: ' + error.message);
                
                // Fallback: mostrar informaci√≥n b√°sica en alerta
                alert(`DETALLES DE EVALUACI√ìN\n\nJugador: ${evaluation.evaluatedUserName || 'N/A'}\nOVR: ${oldOVR} ‚Üí ${newOVR} (+${(newOVR - oldOVR).toFixed(1)})\nFecha: ${evaluation.timestamp ? new Date(evaluation.timestamp).toLocaleString() : 'N/A'}\nPartido: ${evaluation.matchId || 'N/A'}`);
            }
        }

        window.deleteEvaluation = async function(evaluationId, collection) {
            const evaluation = allEvaluations.find(e => e.id === evaluationId && e.collection === collection);
            if (!evaluation) {
                alert('Evaluaci√≥n no encontrada');
                return;
            }
            
            if (confirm(`¬øEst√°s seguro de que quieres eliminar esta evaluaci√≥n de ${evaluation.playerName || 'jugador desconocido'}?`)) {
                try {
                    if (collection === 'embedded') {
                        alert('No se pueden eliminar evaluaciones embebidas en partidos desde aqu√≠. Elimina el partido completo si es necesario.');
                        return;
                    }
                    
                    await db.collection(collection).doc(evaluationId).delete();
                    alert('Evaluaci√≥n eliminada exitosamente');
                    loadEvaluations();
                    loadDashboardStats();
                } catch (error) {
                    console.error('Error eliminando evaluaci√≥n:', error);
                    alert('Error eliminando evaluaci√≥n: ' + error.message);
                }
            }
        }

        // Analytics Functions
        window.generateAnalytics = async function() {
            console.log('üîÑ Generando an√°lisis estad√≠stico...');
            
            try {
                // Asegurar que tenemos los datos cargados
                if (allPlayers.length === 0) await loadPlayers();
                if (allMatches.length === 0) await loadMatches();
                if (allEvaluations.length === 0) await loadEvaluations();
                
                // Generar an√°lisis general
                generateGeneralAnalytics();
                
                // Generar an√°lisis por posici√≥n
                generatePositionAnalysis();
                
                // Generar top evaluaciones
                generateTopEvaluations();
                
                // Generar historial de cambios
                generateOVRHistory();
                
                // Generar estad√≠sticas detalladas
                generateDetailedStats();
                
                console.log('‚úÖ An√°lisis estad√≠stico completado');
            } catch (error) {
                console.error('‚ùå Error generando an√°lisis:', error);
            }
        }

        function generateGeneralAnalytics() {
            // Encontrar jugador mejor valorado
            const bestPlayer = allPlayers.reduce((prev, current) => 
                (current.ovr || 0) > (prev.ovr || 0) ? current : prev, allPlayers[0]);
            
            if (bestPlayer) {
                document.getElementById('best-player').textContent = bestPlayer.displayName || bestPlayer.name || 'Sin nombre';
                document.getElementById('best-player-ovr').textContent = `OVR: ${bestPlayer.ovr || 0}`;
            }
            
            // Encontrar jugador con mayor progreso
            let mostImproved = null;
            let maxImprovement = -999;
            
            allEvaluations.forEach(eval => {
                const oldOVR = eval.oldOVR || eval.previousOVR || 0;
                const newOVR = eval.newOVR || eval.currentOVR || eval.ovr || 0;
                const improvement = newOVR - oldOVR;
                
                if (improvement > maxImprovement) {
                    maxImprovement = improvement;
                    mostImproved = eval;
                }
            });
            
            if (mostImproved) {
                document.getElementById('most-improved').textContent = mostImproved.playerName || mostImproved.player || 'Jugador desconocido';
                document.getElementById('most-improved-change').textContent = `Cambio: +${maxImprovement.toFixed(1)}`;
            }
            
            // Evaluaciones recientes (√∫ltima semana)
            const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const recentEvaluations = allEvaluations.filter(eval => {
                const evalDate = new Date(eval.timestamp || eval.date || 0);
                return evalDate > oneWeekAgo;
            });
            document.getElementById('recent-evaluations').textContent = recentEvaluations.length;
            
            // Tendencia general
            const totalChanges = allEvaluations.reduce((sum, eval) => {
                const oldOVR = eval.oldOVR || eval.previousOVR || 0;
                const newOVR = eval.newOVR || eval.currentOVR || eval.ovr || 0;
                return sum + (newOVR - oldOVR);
            }, 0);
            
            const avgChange = allEvaluations.length > 0 ? totalChanges / allEvaluations.length : 0;
            const trendElement = document.getElementById('general-trend');
            const trendDescElement = document.getElementById('trend-description');
            
            if (avgChange > 0.1) {
                trendElement.textContent = 'Mejorando';
                trendElement.className = 'stat-value trend-positive';
                trendDescElement.textContent = `+${avgChange.toFixed(2)} promedio`;
            } else if (avgChange < -0.1) {
                trendElement.textContent = 'Declinando';
                trendElement.className = 'stat-value trend-negative';
                trendDescElement.textContent = `${avgChange.toFixed(2)} promedio`;
            } else {
                trendElement.textContent = 'Estable';
                trendElement.className = 'stat-value trend-neutral';
                trendDescElement.textContent = 'Sin cambios significativos';
            }
        }

        function generatePositionAnalysis() {
            const positionData = {};
            
            // Agrupar jugadores por posici√≥n
            allPlayers.forEach(player => {
                const position = player.position || 'Sin posici√≥n';
                if (!positionData[position]) {
                    positionData[position] = {
                        players: [],
                        totalOVR: 0,
                        evaluations: []
                    };
                }
                positionData[position].players.push(player);
                positionData[position].totalOVR += player.ovr || 0;
            });
            
            // Agregar evaluaciones por posici√≥n
            allEvaluations.forEach(eval => {
                const player = allPlayers.find(p => p.displayName === eval.playerName || p.name === eval.playerName);
                if (player && player.position) {
                    const position = player.position;
                    if (positionData[position]) {
                        positionData[position].evaluations.push(eval);
                    }
                }
            });
            
            let positionHTML = '<div class="comparison-table-container"><table class="comparison-table"><thead><tr><th>Posici√≥n</th><th>Jugadores</th><th>OVR Promedio</th><th>Evaluaciones</th><th>Progreso Promedio</th></tr></thead><tbody>';
            
            Object.entries(positionData).forEach(([position, data]) => {
                const avgOVR = data.players.length > 0 ? (data.totalOVR / data.players.length).toFixed(1) : '0';
                const avgProgress = data.evaluations.length > 0 ? 
                    (data.evaluations.reduce((sum, eval) => {
                        const oldOVR = eval.oldOVR || eval.previousOVR || 0;
                        const newOVR = eval.newOVR || eval.currentOVR || eval.ovr || 0;
                        return sum + (newOVR - oldOVR);
                    }, 0) / data.evaluations.length).toFixed(2) : '0';
                
                const progressClass = parseFloat(avgProgress) > 0 ? 'trend-positive' : 
                                    parseFloat(avgProgress) < 0 ? 'trend-negative' : 'trend-neutral';
                
                positionHTML += `
                    <tr>
                        <td><strong>${position}</strong></td>
                        <td>${data.players.length}</td>
                        <td>${avgOVR}</td>
                        <td>${data.evaluations.length}</td>
                        <td class="${progressClass}">${avgProgress > 0 ? '+' : ''}${avgProgress}</td>
                    </tr>
                `;
            });
            
            positionHTML += '</tbody></table></div>';
            document.getElementById('position-analysis').innerHTML = positionHTML;
        }

        function generateTopEvaluations() {
            // Obtener las mejores evaluaciones (mayor cambio positivo)
            const topEvaluations = allEvaluations
                .map(eval => {
                    const oldOVR = eval.oldOVR || eval.previousOVR || 0;
                    const newOVR = eval.newOVR || eval.currentOVR || eval.ovr || 0;
                    const change = newOVR - oldOVR;
                    return { ...eval, change };
                })
                .filter(eval => eval.change !== 0)
                .sort((a, b) => b.change - a.change)
                .slice(0, 10);
            
            let topHTML = '';
            if (topEvaluations.length === 0) {
                topHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No hay evaluaciones con cambios registradas</div>';
            } else {
                topEvaluations.forEach((eval, index) => {
                    const changeClass = eval.change > 0 ? 'trend-positive' : 'trend-negative';
                    const changeIcon = eval.change > 0 ? 'üìà' : 'üìâ';
                    const rankEmoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                    
                    topHTML += `
                        <div class="evaluation-card">
                            <div class="evaluation-summary">
                                <div>
                                    <span style="font-size: 18px; margin-right: 8px;">${rankEmoji}</span>
                                    <span class="evaluation-player">${eval.playerName || eval.player || 'Jugador desconocido'}</span>
                                </div>
                                <div class="evaluation-change ${changeClass}">
                                    ${changeIcon} ${eval.change > 0 ? '+' : ''}${eval.change.toFixed(1)}
                                </div>
                            </div>
                            <div class="evaluation-details">
                                <div>Partido: ${eval.matchId || eval.match || 'N/A'}</div>
                                <div>Fecha: ${eval.timestamp ? new Date(eval.timestamp).toLocaleDateString() : 'N/A'}</div>
                                <div>OVR Antes: ${(eval.oldOVR || eval.previousOVR || 0).toFixed(1)}</div>
                                <div>OVR Despu√©s: ${(eval.newOVR || eval.currentOVR || eval.ovr || 0).toFixed(1)}</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('top-evaluations').innerHTML = topHTML;
        }

        function generateOVRHistory() {
            // Crear historial cronol√≥gico de cambios de OVR
            const sortedEvaluations = allEvaluations
                .filter(eval => eval.timestamp || eval.date)
                .sort((a, b) => {
                    const dateA = new Date(a.timestamp || a.date);
                    const dateB = new Date(b.timestamp || b.date);
                    return dateB - dateA;
                })
                .slice(0, 20); // √öltimas 20 evaluaciones
            
            let historyHTML = '';
            if (sortedEvaluations.length === 0) {
                historyHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No hay historial de cambios de OVR disponible</div>';
            } else {
                historyHTML = '<div class="comparison-table-container"><table class="comparison-table"><thead><tr><th>Fecha</th><th>Jugador</th><th>OVR Antes</th><th>OVR Despu√©s</th><th>Cambio</th><th>Partido</th></tr></thead><tbody>';
                
                sortedEvaluations.forEach(eval => {
                    const oldOVR = eval.oldOVR || eval.previousOVR || 0;
                    const newOVR = eval.newOVR || eval.currentOVR || eval.ovr || 0;
                    const change = newOVR - oldOVR;
                    const changeClass = change > 0 ? 'trend-positive' : change < 0 ? 'trend-negative' : 'trend-neutral';
                    const date = new Date(eval.timestamp || eval.date).toLocaleDateString();
                    
                    historyHTML += `
                        <tr>
                            <td>${date}</td>
                            <td>${eval.playerName || eval.player || 'Desconocido'}</td>
                            <td>${oldOVR.toFixed(1)}</td>
                            <td>${newOVR.toFixed(1)}</td>
                            <td class="${changeClass}">${change > 0 ? '+' : ''}${change.toFixed(1)}</td>
                            <td>${eval.matchId?.substring(0, 15) || eval.match?.substring(0, 15) || 'N/A'}${eval.matchId?.length > 15 ? '...' : ''}</td>
                        </tr>
                    `;
                });
                
                historyHTML += '</tbody></table></div>';
            }
            
            document.getElementById('ovr-history').innerHTML = historyHTML;
        }

        function generateDetailedStats() {
            // Estad√≠sticas generales
            const totalPlayers = allPlayers.length;
            const totalMatches = allMatches.length;
            const totalEvaluations = allEvaluations.length;
            
            // Calcular estad√≠sticas de OVR
            const ovrValues = allPlayers.map(p => p.ovr || 0).filter(ovr => ovr > 0);
            const avgOVR = ovrValues.length > 0 ? (ovrValues.reduce((sum, ovr) => sum + ovr, 0) / ovrValues.length) : 0;
            const maxOVR = Math.max(...ovrValues, 0);
            const minOVR = Math.min(...ovrValues, 100);
            
            // Calcular estad√≠sticas de evaluaciones
            const evaluationChanges = allEvaluations
                .map(eval => {
                    const oldOVR = eval.oldOVR || eval.previousOVR || 0;
                    const newOVR = eval.newOVR || eval.currentOVR || eval.ovr || 0;
                    return newOVR - oldOVR;
                })
                .filter(change => change !== 0);
            
            const avgChange = evaluationChanges.length > 0 ? 
                (evaluationChanges.reduce((sum, change) => sum + change, 0) / evaluationChanges.length) : 0;
            const maxIncrease = Math.max(...evaluationChanges, 0);
            const maxDecrease = Math.min(...evaluationChanges, 0);
            
            // Distribuci√≥n por posiciones
            const positionDistribution = {};
            allPlayers.forEach(player => {
                const position = player.position || 'Sin posici√≥n';
                positionDistribution[position] = (positionDistribution[position] || 0) + 1;
            });
            
            const detailedHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="highlight-stat">
                        <h5 style="margin: 0 0 10px 0; color: var(--primary);">üìä Resumen General</h5>
                        <div>Total Jugadores: <strong>${totalPlayers}</strong></div>
                        <div>Total Partidos: <strong>${totalMatches}</strong></div>
                        <div>Total Evaluaciones: <strong>${totalEvaluations}</strong></div>
                        <div>Promedio Evaluaciones por Jugador: <strong>${totalPlayers > 0 ? (totalEvaluations / totalPlayers).toFixed(1) : 0}</strong></div>
                    </div>
                    
                    <div class="highlight-stat">
                        <h5 style="margin: 0 0 10px 0; color: var(--primary);">üèÜ Estad√≠sticas de OVR</h5>
                        <div>OVR Promedio: <strong>${avgOVR.toFixed(1)}</strong></div>
                        <div>OVR M√°ximo: <strong>${maxOVR}</strong></div>
                        <div>OVR M√≠nimo: <strong>${minOVR}</strong></div>
                        <div>Rango: <strong>${maxOVR - minOVR} puntos</strong></div>
                    </div>
                    
                    <div class="highlight-stat">
                        <h5 style="margin: 0 0 10px 0; color: var(--primary);">üìà Progreso de Evaluaciones</h5>
                        <div>Cambio Promedio: <strong class="${avgChange > 0 ? 'trend-positive' : avgChange < 0 ? 'trend-negative' : 'trend-neutral'}">${avgChange > 0 ? '+' : ''}${avgChange.toFixed(2)}</strong></div>
                        <div>Mayor Aumento: <strong class="trend-positive">+${maxIncrease.toFixed(1)}</strong></div>
                        <div>Mayor Disminuci√≥n: <strong class="trend-negative">${maxDecrease.toFixed(1)}</strong></div>
                        <div>Evaluaciones con Cambio: <strong>${evaluationChanges.length}</strong></div>
                    </div>
                    
                    <div class="highlight-stat">
                        <h5 style="margin: 0 0 10px 0; color: var(--primary);">‚öΩ Distribuci√≥n por Posiciones</h5>
                        ${Object.entries(positionDistribution)
                            .sort(([,a], [,b]) => b - a)
                            .map(([position, count]) => {
                                const percentage = ((count / totalPlayers) * 100).toFixed(1);
                                return `<div>${position}: <strong>${count} jugadores (${percentage}%)</strong></div>`;
                            })
                            .join('')}
                    </div>
                </div>
                
                <div class="highlight-stat" style="margin-top: 20px;">
                    <h5 style="margin: 0 0 15px 0; color: var(--primary);">üìÖ Actividad Reciente</h5>
                    <div>Evaluaciones esta semana: <strong>${document.getElementById('recent-evaluations').textContent}</strong></div>
                    <div>√öltima evaluaci√≥n: <strong>${allEvaluations.length > 0 ? new Date(Math.max(...allEvaluations.map(e => new Date(e.timestamp || e.date || 0)))).toLocaleDateString() : 'N/A'}</strong></div>
                    <div>Partidos completados: <strong>${allMatches.filter(m => m.status === 'completed' || m.status === 'finished').length}</strong></div>
                    <div>Jugadores activos: <strong>${allPlayers.filter(p => p.lastLogin && new Date(p.lastLogin) > new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)).length}</strong> (√∫ltimo mes)</div>
                </div>
            `;
            
            document.getElementById('detailed-stats').innerHTML = detailedHTML;
        }

        // Export Functions
        window.exportPlayers = function() {
            const csv = convertToCSV(allPlayers, 'players');
            downloadCSV(csv, 'jugadores.csv');
        }

        window.exportMatches = function() {
            const csv = convertToCSV(allMatches, 'matches');
            downloadCSV(csv, 'partidos.csv');
        }

        window.exportEvaluations = function() {
            const csv = convertToCSV(allEvaluations, 'evaluations');
            downloadCSV(csv, 'evaluaciones.csv');
        }

        function convertToCSV(data, type) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]).join(',');
            const rows = data.map(item => 
                Object.values(item).map(value => 
                    typeof value === 'object' ? JSON.stringify(value) : value
                ).join(',')
            );
            
            return [headers, ...rows].join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Funci√≥n para cerrar la modal
        window.closeDetailModal = function() {
            document.getElementById('detail-modal').classList.remove('active');
        }
        
        // Cerrar modal al hacer clic fuera
        document.getElementById('detail-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDetailModal();
            }
        });
        
        // Initialize
        console.log('üîß Admin Panel inicializado');
    </script>
</body>
</html>