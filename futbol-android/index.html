<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fútbol Miércoles - BETA Test</title>
    
    <!-- Firebase Scripts - REQUIRED -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    
    <!-- Unified Evaluation System -->
    <link rel="stylesheet" href="css/evaluation-styles.css">
    <script src="js/unified-evaluation-system.js" defer></script>
    <script src="js/evaluation-ui.js" defer></script>
    <script src="js/collaborative-system-integration.js" defer></script>
    
    <!-- Enhanced Header & Footer with Notifications - Header desactivado, Footer reactivado -->
    <link rel="stylesheet" href="css/header-footer-enhanced.css?v=5.0">
    <link rel="stylesheet" href="css/variant1-header-styles.css?v=1.0">
    <link rel="stylesheet" href="css/unified-player-styles.css?v=1.0">
    <script src="js/unified-player-helpers.js?v=1.0" defer></script>
    <script src="js/header-footer-enhanced.js?v=5.1" defer></script>
    
    <!-- Partidos Grupales Enhanced V2 -->
    <link rel="stylesheet" href="css/partidos-grupales-enhanced.css">
    <script src="js/partidos-grupales-v2.js" defer></script>
    
    <!-- Team Generator Advanced -->
    <script src="js/team-generator-advanced.js" defer></script>
    
    <!-- Sistema de Diseño Unificado -->
    <link rel="stylesheet" href="css/unified-design-system.css?v=3.0">
    <script src="js/unified-teams-modal.js" defer></script>
    
    <!-- Enhanced Players View -->
    <link rel="stylesheet" href="css/players-view-enhanced.css?v=3.0">
    <script src="js/players-view-enhanced.js?v=4.0" defer></script>
    
    <!-- Profile Manager -->
    <script src="js/profile-manager.js?v=1.0" defer></script>
    
    <!-- Settings Manager -->
    <script src="js/settings-manager.js?v=1.0" defer></script>
    
    <!-- Unified Notifications System -->
    <script src="js/unified-notifications-system.js?v=1.0" defer></script>
    
    <!-- Fix CSS para notificaciones -->
    <link rel="stylesheet" href="css/unified-notifications-fix.css?v=1.1">
    
    <!-- EA SPORTS FC 24 Styles -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/collaborative-matches.css">
    <style>
        :root {
            --primary: #00ff9d;
            --secondary: #ff00e6;
            --dark: #0a0a0a;
            --darker: #050505;
            --card-bg: rgba(25, 25, 25, 0.7);
            --text-light: #e0e0e0;
            --base-font-size: 16px;
            --animation-duration: 0.3s;
        }
        
        /* Modo compacto */
        .compact-mode .player-card {
            padding: 12px !important;
            margin: 8px !important;
        }
        
        .compact-mode .settings-section {
            padding: 15px !important;
            margin-bottom: 15px !important;
        }
        
        /* Animaciones reducidas */
        .reduced-animations * {
            animation-duration: 0.1s !important;
            transition-duration: 0.1s !important;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--dark);
            color: var(--text-light);
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 255, 157, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 230, 0.1) 0%, transparent 20%),
                linear-gradient(to bottom, var(--dark), var(--darker));
            overflow-x: hidden;
        }
        
        #app {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px 15px;
            padding-bottom: 80px;
        }
        
        /* Responsive container widths */
        @media (min-width: 768px) {
            #app {
                max-width: 800px;
                padding: 20px 30px 80px;
            }
        }
        
        @media (min-width: 1024px) {
            #app {
                max-width: 1000px;
                padding: 20px 40px 80px;
            }
        }
        
        @media (min-width: 1200px) {
            #app {
                max-width: 1200px;
                padding: 20px 50px 80px;
            }
        }
        
        .screen {
            display: none;
            animation: fadeIn 0.3s ease-in;
            width: 100%;
        }
        
        /* Ancho mínimo consistente solo en desktop más grande */
        @media (min-width: 1024px) {
            .screen {
                min-width: 730px;
            }
        }
        
        /* Ancho intermedio para tablets */
        @media (min-width: 768px) and (max-width: 1023px) {
            .screen {
                min-width: 600px;
            }
        }
        
        /* Mejorar utilización de espacio en desktop */
        @media (min-width: 1024px) {
            #teams-display {
                gap: 5px !important;
                max-width: 100%;
                margin: 25px 0 !important;
            }
            
            #teams-display .team {
                min-width: 0 !important;
                flex: 1 !important;
            }
        }
        
        /* Títulos unificados - Opción B: Línea Gradient */
        .section-title {
            font-size: 2rem !important;
            font-weight: 600 !important;
            color: var(--text-light) !important;
            margin: 0 0 25px 0 !important;
            padding: 0 0 12px 0 !important;
            position: relative !important;
            display: block !important;
            line-height: 1.2 !important;
        }
        
        .section-title::after {
            content: '' !important;
            position: absolute !important;
            bottom: 0 !important;
            left: 0 !important;
            width: 80px !important;
            height: 2px !important;
            background: linear-gradient(90deg, var(--primary), var(--secondary)) !important;
            border-radius: 2px !important;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* EA SPORTS FC 24 Auth Screen */
        .auth-overlay {
            background: linear-gradient(135deg, 
                var(--dark) 0%, 
                rgba(0, 255, 157, 0.1) 50%, 
                var(--darker) 100%
            ) !important;
            backdrop-filter: blur(20px);
        }
        
        .auth-container {
            background: var(--card-bg) !important;
            backdrop-filter: blur(15px) !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7) !important;
        }
        
        .auth-header h1 {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent !important;
            text-shadow: none;
            letter-spacing: 2px;
        }
        
        .form-group input, .form-group select {
            background: rgba(30, 30, 30, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: var(--text-light) !important;
            backdrop-filter: blur(5px);
        }
        
        /* Register Form Enhanced Styles */
        #register-form input, #register-form select {
            background: var(--card-bg) !important;
            border: 2px solid rgba(255, 255, 255, 0.1) !important;
            color: var(--text-light) !important;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        #register-form input:focus, #register-form select:focus {
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 0.25rem rgba(0, 255, 157, 0.15) !important;
            outline: none;
        }
        
        #register-form input::placeholder {
            color: rgba(255, 255, 255, 0.5) !important;
        }
        
        @media (max-width: 480px) {
            #register-form .form-group {
                margin-bottom: 15px !important;
            }
            
            #register-form .form-group div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 10px !important;
                align-items: stretch !important;
            }
            
            #register-form #profile-image-preview {
                width: 50px !important;
                height: 50px !important;
                font-size: 20px !important;
                align-self: center !important;
            }
        }
        
        .form-group input:focus, .form-group select:focus {
            background: rgba(40, 40, 40, 0.8) !important;
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 0.25rem rgba(0, 255, 157, 0.25) !important;
            color: white !important;
        }
        
        .form-group label {
            color: var(--text-light) !important;
            font-weight: 500;
        }
        
        
        /* Navigation Grid 2x2 EA SPORTS */
        #main-nav {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            grid-template-rows: repeat(2, 1fr) !important;
            gap: 15px;
            margin-bottom: 30px;
            height: auto;
        }
        
        .nav-btn {
            background: var(--card-bg) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 15px 10px !important;
            min-height: 80px !important;
            color: var(--text-light) !important;
            text-decoration: none;
        }
        
        
        .nav-btn:hover {
            transform: translateY(-2px) !important;
            border-color: var(--primary) !important;
            color: var(--text-light) !important;
            text-decoration: none;
        }
        
        .nav-btn.active {
            border-color: var(--primary) !important;
            background: rgba(0, 255, 157, 0.08) !important;
        }
        
        .nav-btn i {
            font-size: 24px;
            margin-bottom: 5px;
            display: block;
            color: var(--primary);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .nav-btn:hover i {
            color: var(--primary);
            transform: translateY(-1px) scale(1.05);
        }
        
        .nav-btn.active i {
            color: var(--primary);
        }
        
        .nav-btn span {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-light);
        }
        
        /* Section Titles */
        .section-title, h2, h3 {
            font-weight: 700 !important;
            color: var(--text-light) !important;
            margin-bottom: 1.5rem !important;
            position: relative;
            display: inline-block;
            font-size: 24px !important;
            padding-bottom: 12px;
        }
        
        .section-title::after, h2::after, h3::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -2px;
            height: 2px;
            width: 40px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        
        /* Gaming Dashboard Enhanced */
        .gaming-dashboard {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px 20px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }

        .dashboard-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dashboard-title h2 {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
        }

        .dashboard-title .icon {
            font-size: 20px;
            color: var(--primary);
            animation: iconFloat 2s ease-in-out infinite alternate;
        }

        @keyframes iconFloat {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-3px); }
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 255, 157, 0.1);
            padding: 4px 8px;
            border-radius: 15px;
            border: 1px solid var(--primary);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: livePulse 1.5s ease-in-out infinite;
        }

        @keyframes livePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .live-text {
            font-size: 10px;
            color: var(--primary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Pending Evaluations Enhanced */
        .pending-evaluations-enhanced {
            background: linear-gradient(135deg, 
                rgba(0, 255, 157, 0.15) 0%, 
                rgba(255, 0, 230, 0.15) 100%
            );
            border: 1px solid rgba(0, 255, 157, 0.3);
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .pending-evaluations-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(0, 255, 157, 0.2), 
                transparent
            );
            animation: pendingShine 3s ease-in-out infinite;
        }

        @keyframes pendingShine {
            0% { left: -100%; }
            50%, 100% { left: 100%; }
        }

        .pending-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .pending-info h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .pending-info p {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
        }

        .pending-count {
            color: var(--primary);
            font-weight: 700;
        }

        .eval-btn {
            background: linear-gradient(135deg, var(--primary), #00d4ff);
            color: var(--dark);
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
        }

        .eval-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 157, 0.3);
        }

        .eval-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.4s;
        }

        .eval-btn:hover::before {
            left: 100%;
        }

        /* Stats Grid Enhanced */
        #dashboard-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: linear-gradient(135deg, 
                rgba(25, 25, 25, 0.9) 0%, 
                rgba(35, 35, 35, 0.7) 100%
            );
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 16px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            backdrop-filter: blur(10px);
        }

        .stat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
        }

        .stat-box:hover::before {
            transform: scaleX(1);
        }

        .stat-box h3 {
            font-size: 11px !important;
            font-weight: 600 !important;
            color: rgba(255, 255, 255, 0.7) !important;
            margin-bottom: 8px !important;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
            border: none !important;
            padding-bottom: 0 !important;
        }

        .stat-box h3::after {
            display: none;
        }

        .stat-box p {
            font-size: 24px !important;
            font-weight: 800 !important;
            background: linear-gradient(135deg, var(--primary), #00d4ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            line-height: 1;
            position: relative;
            z-index: 1;
            margin: 0 !important;
        }

        /* Dashboard Actions Enhanced */
        #dashboard-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        #dashboard-actions button {
            flex: 1;
            min-width: 120px;
            background: var(--card-bg) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: var(--text-light) !important;
            padding: 12px 16px !important;
            border-radius: 12px !important;
            font-size: 12px !important;
            font-weight: 600 !important;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        #dashboard-actions button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(0, 255, 157, 0.2), 
                transparent
            );
            transition: left 0.4s ease;
        }

        #dashboard-actions button:hover {
            border-color: var(--primary) !important;
            color: var(--primary) !important;
            transform: translateY(-2px);
        }

        #dashboard-actions button:hover::before {
            left: 100%;
        }
        
        /* Player Cards EA SPORTS - Grid Layout */
        #players-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .player-card {
            background: var(--card-bg);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }
        
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.7);
        }
        
        .player-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 0%,
                rgba(255, 255, 255, 0.02) 50%,
                transparent 100%
            );
            transform: rotate(45deg);
            transition: all 0.6s ease;
            pointer-events: none;
        }
        
        .player-card:hover::before {
            top: -100%;
            left: -100%;
        }
        
        .player-header {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .player-basic-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .player-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border: 2px solid var(--primary);
            box-shadow: 0 0 8px rgba(0, 255, 157, 0.3);
            overflow: hidden;
        }
        
        .player-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .player-info {
            display: flex;
            flex-direction: column;
        }
        
        .player-name {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
            margin: 0 0 4px 0;
        }
        
        .player-position {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            font-weight: 500;
            margin: 0;
        }

        /* Position-specific colors */
        .position-POR { color: #f1c40f !important; background: rgba(241, 196, 15, 0.2); padding: 2px 6px; border-radius: 4px; }
        .position-DEF { color: #3498db !important; background: rgba(52, 152, 219, 0.2); padding: 2px 6px; border-radius: 4px; }
        .position-MED { color: #e74c3c !important; background: rgba(231, 76, 60, 0.2); padding: 2px 6px; border-radius: 4px; }
        .position-DEL { color: #2ecc71 !important; background: rgba(46, 204, 113, 0.2); padding: 2px 6px; border-radius: 4px; }
        
        .player-rating-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .player-rating {
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
            position: relative;
        }
        
        /* OVR Rating Colors based on level - Reduced Glow */
        .ovr-bronze { color: #cd7f32; }
        .ovr-silver { color: #c0c0c0; }
        .ovr-gold { 
            color: var(--primary); 
            text-shadow: 
                0 0 2px var(--primary),
                0 0 4px rgba(0, 255, 157, 0.2);
            animation: ovr-glow-subtle 4s ease-in-out infinite alternate;
            font-weight: 700 !important;
        }
        .ovr-special { 
            color: var(--primary);
            text-shadow: 
                0 0 3px var(--primary),
                0 0 6px rgba(0, 255, 157, 0.3);
            animation: ovr-glow-subtle 4s ease-in-out infinite alternate;
            position: relative;
            font-weight: 800 !important;
        }

        .ovr-excellent {
            color: var(--primary);
            text-shadow: 
                0 0 2px var(--primary),
                0 0 4px rgba(0, 255, 157, 0.2);
            font-weight: 700 !important;
        }
        .ovr-low { color: #e74c3c; }
        
        @keyframes ovr-glow-subtle {
            0% { 
                text-shadow: 
                    0 0 2px var(--primary),
                    0 0 4px rgba(0, 255, 157, 0.2);
            }
            100% { 
                text-shadow: 
                    0 0 3px var(--primary),
                    0 0 6px rgba(0, 255, 157, 0.25);
            }
        }
        
        .ovr-special::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 255, 157, 0.03) 0%, transparent 70%);
            border-radius: 50%;
            animation: ovr-pulse-subtle 6s ease-in-out infinite;
            z-index: -1;
        }
        
        @keyframes ovr-pulse-subtle {
            0%, 100% { transform: scale(0.95); opacity: 0.1; }
            50% { transform: scale(1.05); opacity: 0.2; }
        }
        
        
        .expand-icon {
            font-size: 20px;
            color: var(--primary);
            transition: transform 0.3s;
        }
        
        .expand-icon.rotated {
            transform: rotate(180deg);
        }
        
        /* EA SPORTS styling for manual match inputs */
        #match-config select:focus,
        #match-config input:focus {
            outline: none !important;
            border-color: var(--primary) !important;
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.5) !important;
            background: rgba(0, 255, 157, 0.05) !important;
        }
        
        #match-config select:hover,
        #match-config input:hover {
            border-color: rgba(0, 255, 157, 0.5) !important;
        }

        /* EA SPORTS styling for evaluation screen */
        .eval-match-header {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 157, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .eval-match-title {
            font-size: 1.3em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
            margin-bottom: 8px;
            text-shadow: 0 0 5px rgba(0, 255, 157, 0.3);
        }

        .eval-match-info {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
        }

        .eval-scores-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .eval-team-score {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .eval-team-score.team-a {
            border: 2px solid var(--primary);
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.2);
        }

        .eval-team-score.team-b {
            border: 2px solid var(--secondary);
            box-shadow: 0 0 15px rgba(255, 0, 230, 0.2);
        }

        .eval-team-name {
            font-size: 1em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .eval-team-score.team-a .eval-team-name { color: var(--primary); }
        .eval-team-score.team-b .eval-team-name { color: var(--secondary); }

        .eval-score-display {
            font-size: 2.5em;
            font-weight: 800;
            margin: 10px 0;
        }

        .eval-score-controls {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .eval-score-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .eval-score-btn.plus {
            background: linear-gradient(90deg, var(--primary), #00cc7a);
            color: var(--dark);
        }

        .eval-score-btn.minus {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            color: white;
        }

        .eval-score-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .eval-system-selector {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 157, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .eval-system-title {
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .eval-system-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .eval-system-option {
            background: rgba(40, 40, 40, 0.6);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
        }

        .eval-system-option:hover {
            border-color: var(--primary);
            background: rgba(0, 255, 157, 0.05);
        }

        .eval-system-option.selected {
            border-color: var(--primary);
            background: rgba(0, 255, 157, 0.1);
        }

        .eval-system-option input[type="radio"] {
            position: absolute;
            top: 10px;
            left: 10px;
            accent-color: var(--primary);
        }

        .eval-option-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            margin-left: 25px;
        }

        .eval-option-description {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            line-height: 1.3;
            margin-left: 25px;
        }

        .eval-players-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .eval-team-players {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 18px;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .eval-team-players.team-a {
            border: 2px solid var(--primary);
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.1);
        }

        .eval-team-players.team-b {
            border: 2px solid var(--secondary);
            box-shadow: 0 0 15px rgba(255, 0, 230, 0.1);
        }

        .eval-players-title {
            font-size: 1em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            text-align: center;
        }

        .eval-team-players.team-a .eval-players-title { color: var(--primary); }
        .eval-team-players.team-b .eval-players-title { color: var(--secondary); }

        .eval-player-card {
            background: rgba(40, 40, 40, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .eval-player-card:hover {
            border-color: rgba(0, 255, 157, 0.3);
            background: rgba(0, 255, 157, 0.05);
        }

        .eval-player-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .eval-player-photo {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(60, 60, 60, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border: 2px solid rgba(0, 255, 157, 0.2);
        }

        .eval-player-info {
            flex: 1;
        }

        .eval-player-name {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .eval-player-meta {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            display: flex;
            gap: 8px;
        }

        .eval-player-ovr {
            font-weight: 700;
            font-size: 14px;
            color: var(--primary);
        }

        .eval-tags-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .eval-tag-btn {
            background: rgba(60, 60, 60, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 6px 8px;
            font-size: 9px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            align-items: center;
            gap: 4px;
            text-align: left;
            justify-content: flex-start;
            min-height: 28px;
        }

        .eval-tag-btn:hover {
            border-color: var(--primary);
            background: rgba(0, 255, 157, 0.1);
        }

        .eval-tag-btn.active,
        .eval-tag-btn.selected {
            background: linear-gradient(135deg, var(--primary) 0%, #00d48a 100%) !important;
            color: var(--dark) !important;
            border-color: var(--primary) !important;
            font-weight: 600 !important;
            box-shadow: 0 0 8px rgba(0, 255, 157, 0.4) !important;
            transform: translateY(-1px) !important;
        }

        .eval-tag-btn.active:hover,
        .eval-tag-btn.selected:hover {
            background: linear-gradient(135deg, #00d48a 0%, var(--primary) 100%) !important;
            box-shadow: 0 0 12px rgba(0, 255, 157, 0.6) !important;
        }

        .eval-tag-counter {
            display: none;
            background: linear-gradient(135deg, var(--primary) 0%, #00d48a 100%);
            color: var(--dark);
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: auto;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 255, 157, 0.3);
        }

        .eval-rating-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }

        .eval-rating-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .eval-rating-label {
            font-size: 10px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .eval-rating-input {
            background: rgba(60, 60, 60, 0.8);
            border: 1px solid rgba(0, 255, 157, 0.3);
            border-radius: 6px;
            padding: 6px;
            color: var(--text-light);
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .eval-rating-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 8px rgba(0, 255, 157, 0.3);
        }

        .eval-notes-area {
            margin-top: 8px;
        }

        .eval-notes-textarea {
            width: 100%;
            height: 40px;
            background: rgba(60, 60, 60, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 6px;
            color: var(--text-light);
            font-size: 11px;
            resize: vertical;
        }

        .eval-notes-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 8px rgba(0, 255, 157, 0.2);
        }

        /* ===== MODAL SYSTEM EA SPORTS ===== */
        .ea-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: modalFadeIn 0.3s ease;
        }

        .ea-modal-overlay.show {
            display: flex;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes modalSlideIn {
            from { 
                opacity: 0; 
                transform: scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        .ea-modal {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(0, 255, 157, 0.2);
            animation: modalSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .ea-modal-header {
            padding: 25px 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .ea-modal-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 0;
            text-align: center;
        }

        .ea-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 35px;
            height: 35px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: var(--text-light);
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .ea-modal-close:hover {
            background: rgba(255, 0, 230, 0.2);
            border-color: var(--secondary);
            color: var(--secondary);
            transform: rotate(90deg);
        }

        .ea-modal-body {
            padding: 25px;
            text-align: center;
        }

        .ea-modal-icon {
            font-size: 48px;
            margin-bottom: 20px;
            display: block;
        }

        .ea-modal-icon.success { color: var(--primary); }
        .ea-modal-icon.warning { color: #ffcc00; }
        .ea-modal-icon.danger { color: #ff073a; }
        .ea-modal-icon.info { color: #00d4ff; }

        .ea-modal-message {
            color: var(--text-light);
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .ea-modal-input {
            width: 100%;
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .ea-modal-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 157, 0.2);
            background: rgba(30, 30, 30, 0.9);
        }

        .ea-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            padding: 0 25px 25px;
        }

        .ea-modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ea-modal-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .ea-modal-btn:hover::before {
            left: 100%;
        }

        .ea-modal-btn:hover {
            transform: translateY(-2px);
        }

        .ea-modal-btn-primary {
            background: linear-gradient(135deg, var(--primary), #00cc7a);
            color: var(--dark);
            box-shadow: 0 5px 15px rgba(0, 255, 157, 0.3);
        }

        .ea-modal-btn-primary:hover {
            box-shadow: 0 8px 25px rgba(0, 255, 157, 0.5);
        }

        .ea-modal-btn-secondary {
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: var(--text-light);
        }

        .ea-modal-btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.2);
        }

        .ea-modal-btn-danger {
            background: linear-gradient(135deg, #ff073a, #cc0028);
            color: var(--text-light);
            box-shadow: 0 5px 15px rgba(255, 7, 58, 0.3);
        }

        .ea-modal-btn-danger:hover {
            box-shadow: 0 8px 25px rgba(255, 7, 58, 0.5);
        }

        /* Modal Responsive */
        @media (max-width: 768px) {
            .ea-modal {
                max-width: 380px;
                width: 85%;
                max-height: 70vh;
            }
            
            .ea-modal-header {
                padding: 20px 20px 15px;
            }
            
            .ea-modal-title {
                font-size: 18px;
            }
            
            .ea-modal-close {
                width: 30px;
                height: 30px;
                font-size: 14px;
                top: 15px;
                right: 15px;
            }
            
            .ea-modal-body {
                padding: 20px;
            }
            
            .ea-modal-icon {
                font-size: 40px;
                margin-bottom: 15px;
            }
            
            .ea-modal-message {
                font-size: 14px;
                margin-bottom: 20px;
            }
            
            .ea-modal-input {
                padding: 10px 14px;
                font-size: 14px;
            }
            
            .ea-modal-actions {
                padding: 0 20px 20px;
                flex-direction: column;
            }
            
            .ea-modal-btn {
                padding: 10px 20px;
                font-size: 13px;
            }

            /* Fix teams display for tablet */
            #teams-display {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 20px !important;
                margin: 25px 0 !important;
            }

            .team {
                padding: 18px !important;
            }

            .team h3 {
                font-size: 1.1em !important;
            }

            /* Fix match config for tablet */
            #match-config div[style*="grid-template-columns"] {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 18px !important;
            }

            #match-config {
                padding: 18px !important;
            }

            #match-config h3 {
                font-size: 1.05em !important;
            }

            #match-config label {
                font-size: 0.87em !important;
            }

            #match-config select,
            #match-config input {
                padding: 11px !important;
                font-size: 13.5px !important;
            }
        }

        @media (max-width: 480px) {
            .ea-modal {
                max-width: 320px;
                width: 90%;
            }
            
            .ea-modal-header {
                padding: 18px 18px 12px;
            }
            
            .ea-modal-body {
                padding: 18px;
            }
            
            .ea-modal-icon {
                font-size: 36px;
                margin-bottom: 12px;
            }
            
            .ea-modal-actions {
                padding: 0 18px 18px;
            }

            /* Fix teams display for mobile */
            #teams-display {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 15px !important;
                margin: 20px 0 !important;
            }

            .team {
                padding: 15px !important;
            }

            .team h3 {
                font-size: 1em !important;
                margin-bottom: 15px !important;
            }

            /* Fix match config for mobile */
            #match-config div[style*="grid-template-columns"] {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }

            #match-config {
                padding: 15px !important;
            }

            #match-config h3 {
                font-size: 1em !important;
                margin-bottom: 15px !important;
            }

            #match-config label {
                font-size: 0.85em !important;
                margin-bottom: 6px !important;
            }

            #match-config select,
            #match-config input {
                padding: 10px !important;
                font-size: 13px !important;
            }
        }

        /* Mobile responsive for evaluation screen */
        @media (max-width: 768px) {
            .eval-scores-section,
            .eval-system-options,
            .eval-players-section {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .eval-match-title {
                font-size: 1.1em;
            }

            .eval-score-display {
                font-size: 2em;
            }

            .eval-rating-controls {
                grid-template-columns: 1fr;
                gap: 6px;
            }

            .eval-tags-container {
                grid-template-columns: 1fr;
                gap: 4px;
            }

            .eval-tag-btn {
                font-size: 8px;
                padding: 4px 6px;
                min-height: 24px;
            }
        }
        
        .player-details {
            max-height: 0px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 20px;
        }
        
        .player-details.expanded {
            max-height: 400px;
            padding: 0 20px 20px;
        }
        
        .player-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .stat-label {
            text-transform: uppercase;
            font-weight: 600;
            font-size: 11px;
            width: 35px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .stat-value {
            font-weight: 700;
            font-size: 14px;
            margin-right: 8px;
            width: 25px;
            text-align: right;
        }
        
        /* Stat Values Colors based on level */
        .stat-low { color: #e74c3c; }
        .stat-medium { color: #f39c12; }
        .stat-good { color: #2ecc71; }
        .stat-excellent { 
            color: var(--primary); 
            font-weight: 800;
            text-shadow: 0 0 3px rgba(0, 255, 157, 0.3);
        }
        
        .stat-bar {
            flex: 1;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }
        
        .stat-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
            transition: width 1s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        /* Forms EA SPORTS */
        .form-control, .form-select, input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="date"], input[type="time"], input[type="file"], select, textarea {
            background-color: rgba(30, 30, 30, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: var(--text-light) !important;
            backdrop-filter: blur(5px);
        }
        
        .form-control:focus, .form-select:focus, input:focus, select:focus, textarea:focus {
            background-color: rgba(40, 40, 40, 0.8) !important;
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 0.25rem rgba(0, 255, 157, 0.25) !important;
            color: white !important;
            outline: none;
        }
        
        .form-group label, .form-label, label {
            color: var(--text-light) !important;
            font-weight: 500;
            font-size: 14px;
        }
        
        /* Buttons EA SPORTS */
        button, .btn {
            background: linear-gradient(90deg, var(--primary), var(--secondary)) !important;
            border: none !important;
            color: var(--dark) !important;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 14px;
            border-radius: 8px !important;
            padding: 10px 20px !important;
        }
        
        button:hover, .btn:hover {
            transform: translateY(-2px) !important;
            color: var(--dark) !important;
        }
        
        .btn-create, #create-match-btn {
            background: linear-gradient(90deg, var(--primary), var(--secondary)) !important;
            color: var(--dark) !important;
        }
        
        /* Match Cards */
        .match-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .match-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
        }
        
        .match-card::after {
            content: '⚽';
            position: absolute;
            bottom: -5px;
            right: -5px;
            font-size: 50px;
            opacity: 0.05;
            transform: rotate(-15deg);
        }
        
        /* Modal Styles */
        .modal {
            backdrop-filter: blur(20px);
        }
        
        .modal-content {
            background: var(--card-bg) !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Mobile Responsive */
        @media (max-width: 576px) {
            #app {
                padding: 15px 10px;
                padding-bottom: 60px;
            }
            
            .player-card {
                margin-bottom: 15px;
            }
            
            .player-header {
                padding: 15px;
            }
            
            .player-stats {
                gap: 10px;
            }
            
            .nav-btn {
                min-height: 70px !important;
                padding: 12px 8px !important;
            }
            
            .nav-btn span:first-child {
                font-size: 20px !important;
            }
            
            .nav-btn span:last-child {
                font-size: 11px !important;
            }
        }

        /* Match History Styles */
        .match-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 157, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
        }

        .match-card:hover {
            border-color: var(--primary);
            box-shadow: 0 6px 20px rgba(0, 255, 157, 0.2);
        }

        .match-card.edit-mode .match-checkbox {
            display: block !important;
        }

        .match-checkbox {
            display: none;
            position: absolute;
            top: 15px;
            left: 15px;
        }

        .match-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .match-date-display {
            color: var(--text-light);
            font-weight: 500;
        }

        .match-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .match-status.pending {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
            border: 1px solid #ffa500;
        }

        .match-status.completed {
            background: rgba(0, 255, 157, 0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .match-teams-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .match-team-info {
            text-align: center;
        }

        .match-team-name {
            color: var(--text-light);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .match-team-ovr {
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
        }

        .match-vs {
            color: var(--secondary);
            font-weight: 700;
            font-size: 18px;
        }

        .match-result-display {
            text-align: center;
            margin-bottom: 15px;
        }

        .match-score {
            color: var(--primary);
            font-size: 20px;
            font-weight: 700;
        }

        .match-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .match-finish-btn {
            background: linear-gradient(135deg, var(--primary), #00cc7a);
            color: var(--dark);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .match-finish-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 157, 0.3);
        }

        .match-delete-btn {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .match-delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
        }

        /* Estilos para el modal de evaluación y tooltips */
        #evaluation-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        #evaluation-modal .modal-content {
            background: linear-gradient(135deg, #1a1f2e, #0f141e);
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid var(--primary);
            box-shadow: 0 20px 60px rgba(0, 255, 157, 0.3);
        }

        /* Lista de etiquetas estilo mobile-friendly */
        .tag-list-item {
            position: relative !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .tag-list-item:hover {
            border-color: rgba(0, 255, 157, 0.5) !important;
            background: rgba(26, 31, 46, 0.9) !important;
            transform: translateX(5px);
        }

        .tag-list-item.selected {
            border-color: var(--primary) !important;
            background: linear-gradient(135deg, rgba(0, 255, 157, 0.15), rgba(255, 0, 230, 0.08)) !important;
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.3);
            transform: translateX(5px);
        }

        /* Scroll personalizado para la lista */
        .tags-list::-webkit-scrollbar {
            width: 6px;
        }

        .tags-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .tags-list::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            border-radius: 10px;
        }

        /* Contador de tags mejorado */
        #tag-counter {
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            .performance-tags-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            #evaluation-modal .modal-content {
                padding: 20px;
                width: 95%;
            }
        }
        
        /* Profile Manager Animations */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        #profile-photo-display {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        #profile-photo-display:hover {
            transform: scale(1.05);
            box-shadow: 0 0 12px rgba(0, 255, 157, 0.5) !important;
        }
        
        #profile-name-input {
            transition: border-color 0.3s ease;
        }
        
        #profile-name-input:focus {
            outline: none;
            border-color: var(--secondary) !important;
            box-shadow: 0 0 8px rgba(0, 255, 157, 0.3);
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Authentication Screen -->
        <div id="auth-screen" class="auth-overlay" style="
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            backdrop-filter: blur(10px);
            display: flex; 
            align-items: center; 
            justify-content: center;
            z-index: 99999;
        ">
            <div class="auth-container" style="
                background: white; 
                padding: 40px; 
                border-radius: 20px; 
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 400px;
                width: 90%;
                text-align: center;
            ">
                <div class="auth-header" style="margin-bottom: 30px;">
                    <h1 style="color: #333; margin: 0 0 10px 0; font-size: 28px;">⚽ Fútbol Stats</h1>
                    <p style="color: var(--text-secondary); margin: 0; font-size: 16px;">BETA test Fútbol Miércoles</p>
                </div>

                <!-- Login Form -->
                <div id="login-form" class="auth-form">
                    <h2 style="color: #333; margin: 0 0 25px 0; font-size: 22px;">Iniciar Sesión</h2>
                    
                    <div class="form-group" style="margin-bottom: 20px; text-align: left;">
                        <label style="display: block; margin-bottom: 5px; color: var(--text-light); font-weight: 500;">Email:</label>
                        <input type="email" id="login-email" placeholder="tu@email.com" style="
                            width: 100%; 
                            padding: 12px 15px; 
                            border: 2px solid #e1e1e1; 
                            border-radius: 10px; 
                            font-size: 16px;
                            box-sizing: border-box;
                        " required>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 25px; text-align: left;">
                        <label style="display: block; margin-bottom: 5px; color: var(--text-light); font-weight: 500;">Contraseña:</label>
                        <input type="password" id="login-password" placeholder="••••••••" style="
                            width: 100%; 
                            padding: 12px 15px; 
                            border: 2px solid #e1e1e1; 
                            border-radius: 10px; 
                            font-size: 16px;
                            box-sizing: border-box;
                        " required>
                    </div>
                    
                    <button onclick="AuthSystem.login()" style="
                        width: 100%; 
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                        color: white; 
                        padding: 12px 20px; 
                        border: none; 
                        border-radius: 10px; 
                        font-size: 16px; 
                        font-weight: 600; 
                        cursor: pointer; 
                        margin-bottom: 15px;
                    " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                        🔑 Iniciar Sesión
                    </button>
                    
                    <p style="margin: 0; color: var(--text-secondary);">
                        ¿No tienes cuenta? 
                        <a href="#" onclick="AuthSystem.showRegister()" style="color: #667eea; text-decoration: none; font-weight: 600;">
                            Regístrate aquí
                        </a>
                    </p>
                </div>

                <!-- Register Form -->
                <div id="register-form" class="auth-form" style="display: none;">
                    <h2 style="color: var(--text-light); margin: 0 0 25px 0; font-size: 22px; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; background-clip: text; color: transparent;">Crear Cuenta</h2>
                    
                    <div class="form-group" style="margin-bottom: 20px; text-align: left;">
                        <label style="display: block; margin-bottom: 5px; color: var(--text-light); font-weight: 500;">Nombre Completo:</label>
                        <input type="text" id="register-name" placeholder="Juan Pérez" style="
                            width: 100%; 
                            padding: 12px 15px; 
                            border: 2px solid #e1e1e1; 
                            border-radius: 10px; 
                            font-size: 16px;
                            box-sizing: border-box;
                        " required>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px; text-align: left;">
                        <label style="display: block; margin-bottom: 5px; color: var(--text-light); font-weight: 500;">Email:</label>
                        <input type="email" id="register-email" placeholder="tu@email.com" style="
                            width: 100%; 
                            padding: 12px 15px; 
                            border: 2px solid #e1e1e1; 
                            border-radius: 10px; 
                            font-size: 16px;
                            box-sizing: border-box;
                        " required>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px; text-align: left;">
                        <label style="display: block; margin-bottom: 5px; color: var(--text-light); font-weight: 500;">Posición Preferida:</label>
                        <select id="register-position" style="
                            width: 100%; 
                            padding: 12px 15px; 
                            border: 2px solid #e1e1e1; 
                            border-radius: 10px; 
                            font-size: 16px;
                            box-sizing: border-box;
                        " required>
                            <option value="">Seleccionar posición</option>
                            <option value="POR">🧤 POR (Portero)</option>
                            <option value="DEF">🛡️ DEF (Defensor)</option>
                            <option value="MED">⚽ MED (Mediocampista)</option>
                            <option value="DEL">🎯 DEL (Delantero)</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px; text-align: left;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-light); font-weight: 500;">Imagen de Perfil (opcional - máximo 500KB):</label>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div id="profile-image-preview" style="
                                width: 60px; 
                                height: 60px; 
                                border-radius: 50%; 
                                background: var(--card-bg); 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                border: 2px solid var(--primary);
                                font-size: 24px;
                                backdrop-filter: blur(10px);
                            ">👤</div>
                            <input type="file" id="register-image" accept="image/*" style="
                                flex: 1;
                                padding: 12px 15px; 
                                border: 2px solid #e1e1e1; 
                                border-radius: 10px; 
                                font-size: 14px;
                                box-sizing: border-box;
                                cursor: pointer;
                            ">
                        </div>
                        <p style="font-size: 12px; color: var(--text-secondary); margin: 8px 0 0 0;">JPG, PNG o GIF. Máximo 2MB.</p>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 25px; text-align: left;">
                        <label style="display: block; margin-bottom: 5px; color: var(--text-light); font-weight: 500;">Contraseña:</label>
                        <input type="password" id="register-password" placeholder="••••••••" style="
                            width: 100%; 
                            padding: 12px 15px; 
                            border: 2px solid #e1e1e1; 
                            border-radius: 10px; 
                            font-size: 16px;
                            box-sizing: border-box;
                        " required>
                    </div>
                    
                    <button onclick="AuthSystem.register()" style="
                        width: 100%; 
                        background: linear-gradient(135deg, var(--primary), var(--secondary)); 
                        color: var(--dark); 
                        padding: 12px 20px; 
                        border: none; 
                        border-radius: 10px; 
                        font-size: 16px; 
                        font-weight: 600; 
                        cursor: pointer; 
                        margin-bottom: 15px;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 15px rgba(0, 255, 157, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        ⚽ Crear Cuenta y Empezar
                    </button>
                    
                    <p style="margin: 0; color: var(--text-secondary);">
                        ¿Ya tienes cuenta? 
                        <a href="#" onclick="AuthSystem.showLogin()" style="color: #667eea; text-decoration: none; font-weight: 600;">
                            Inicia sesión aquí
                        </a>
                    </p>
                </div>

                <!-- Demo Mode -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e1e1e1;">
                    <button onclick="AuthSystem.enterDemoMode()" style="
                        background: transparent; 
                        color: #999; 
                        border: 1px solid #ddd; 
                        padding: 8px 16px; 
                        border-radius: 5px; 
                        font-size: 14px; 
                        cursor: pointer;
                    ">
                        🔍 Modo Demo (sin registro)
                    </button>
                </div>

                <!-- Loading/Error Messages -->
                <div id="auth-message" style="
                    margin-top: 15px; 
                    padding: 10px; 
                    border-radius: 8px; 
                    display: none;
                "></div>
            </div>
        </div>

        <!-- Group Selector -->
        <div id="group-selector" class="login-overlay" style="display:none;">
            <div class="login-container">
                <h2>Seleccionar Grupo</h2>
                <div id="groups-list" class="groups-list">
                    <p>Cargando grupos...</p>
                </div>
                <button onclick="TestApp.skipGroupSelection()">Saltar Grupo</button>
            </div>
        </div>


        <!-- Navigation -->
        <nav id="main-nav">
            <button class="nav-btn" data-screen="collaborative">
                <i class="bx bx-football" style="font-size: 24px; margin-bottom: 5px;"></i>
                <span>Partidos Grupales</span>
            </button>
            <button class="nav-btn" data-screen="players">
                <i class="bx bx-group" style="font-size: 24px; margin-bottom: 5px;"></i>
                <span>Jugadores</span>
            </button>
            <button class="nav-btn" data-screen="matches">
                <i class="bx bx-football" style="font-size: 24px; margin-bottom: 5px;"></i>
                <span>Partidos Manuales</span>
            </button>
            <button class="nav-btn" data-screen="evaluations">
                <i class="bx bx-star" style="font-size: 24px; margin-bottom: 5px;"></i>
                <span>Evaluaciones</span>
                <span class="badge" id="evaluations-badge" style="display: none;"></span>
            </button>
        </nav>

        <!-- Main Content Area -->
        <main id="main-content">
            <!-- Collaborative Matches Screen -->
            <div id="collaborative-screen" class="screen">
                <h2 class="section-title">Partidos Grupales</h2>
                <p class="subtitle">
                    Únete a partidos organizados por otros jugadores o crea uno nuevo
                </p>
                
                <!-- Create Match Button -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <button id="create-match-btn" class="btn-create">
                        ⚽ Crear Nuevo Partido
                    </button>
                </div>
                
                <!-- Unified Matches Panel -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #333; font-size: 24px; margin-bottom: 20px;">
                        ⚽ Partidos
                    </h3>
                    <div id="all-matches" style="margin-top: 15px;">
                        <p style="color: var(--text-secondary); text-align: center; padding: 40px; background: rgba(255,255,255,0.9); border-radius: 10px;">
                            Cargando partidos...
                        </p>
                    </div>
                </div>
                
                <!-- Keep legacy containers hidden for backward compatibility -->
                <div id="available-matches" style="display: none;"></div>
                <div id="user-matches" style="display: none;"></div>
            </div>

            <!-- Evaluations Screen -->
            <div id="evaluations-screen" class="screen">
                <h2 class="section-title">Evaluaciones</h2>
                <div id="evaluations-section">
                    <!-- Content will be rendered by evaluation-ui.js -->
                </div>
            </div>

            <!-- Dashboard Screen -->
            <div id="dashboard-screen" class="screen active">
                <div class="gaming-dashboard">
                    <div class="dashboard-header">
                        <div class="dashboard-title">
                            <i class="bx bx-dashboard icon"></i>
                            <h2>Control Center</h2>
                        </div>
                        <div class="live-indicator">
                            <div class="live-dot"></div>
                            <span class="live-text">Live</span>
                        </div>
                    </div>

                    <!-- Enhanced Pending Evaluations -->
                    <div id="pending-evaluations-enhanced" class="pending-evaluations-enhanced" style="display: block;">
                        <div class="pending-content">
                            <div class="pending-info">
                                <h3>📋 Evaluaciones Pendientes</h3>
                                <p>Tienes <span class="pending-count" id="pending-count-new">3</span> evaluaciones por completar</p>
                            </div>
                            <button class="eval-btn" onclick="TestApp.showScreen('evaluations')">Evaluar Ahora →</button>
                        </div>
                    </div>

                    <!-- Enhanced Stats Grid -->
                    <div id="dashboard-stats">
                        <div class="stat-box">
                            <h3>Total Jugadores</h3>
                            <p id="total-players">0</p>
                        </div>
                        <div class="stat-box">
                            <h3>Total Partidos</h3>
                            <p id="total-matches">0</p>
                        </div>
                        <div class="stat-box">
                            <h3>Promedio OVR</h3>
                            <p id="average-ovr">0</p>
                        </div>
                        <div class="stat-box">
                            <h3>Grupo Activo</h3>
                            <p id="active-group-name">Ninguno</p>
                        </div>
                    </div>

                    <!-- Enhanced Actions -->
                    <div id="dashboard-actions">
                        <button onclick="TestApp.loadPlayers()">Cargar Jugadores</button>
                        <button onclick="TestApp.testFirebase()">Probar Firebase</button>
                    </div>
                </div>
                
                <!-- Legacy Pending Evaluations (hidden) -->
                <div id="pending-evaluations-card" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0 0 5px 0;">📋 Evaluaciones Pendientes</h3>
                            <p style="margin: 0; opacity: 0.9;">Tienes <span id="pending-count">0</span> evaluaciones por completar</p>
                        </div>
                        <button onclick="TestApp.showScreen('evaluations')" style="background: white; color: #667eea; padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Evaluar Ahora →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Evaluation Section -->
            <div id="evaluation-section" style="display: none; margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h3>📝 Evaluaciones Pendientes</h3>
                <div id="pending-evaluations" style="margin-top: 20px;">
                    <!-- Evaluations will be loaded here -->
                </div>
            </div>

            <!-- Players Screen -->
            <div id="players-screen" class="screen">
                <h2 class="section-title">Gestión de Jugadores</h2>
                <div id="players-actions" style="margin-bottom: 30px;">
                    <button onclick="TestApp.showAddPlayerForm()">Agregar Jugador</button>
                    <button onclick="TestApp.refreshPlayers()">Actualizar</button>
                </div>
                
                <!-- Add/Edit Player Form -->
                <div id="add-player-form" style="display:none;">
                    <h3 id="player-form-title">Agregar Nuevo Jugador</h3>
                    <form id="player-form">
                        <input type="hidden" id="player-id">
                        
                        <!-- Basic Info -->
                        <div class="form-section">
                            <h4>Información Básica</h4>
                            <input type="text" id="player-name" placeholder="Nombre" required>
                            <select id="player-position" required>
                                <option value="">Seleccionar Posición</option>
                                <option value="POR">POR (Portero)</option>
                                <option value="DEF">DEF (Defensor)</option>
                                <option value="MED">MED (Mediocampista)</option>
                                <option value="DEL">DEL (Delantero)</option>
                            </select>
                        </div>
                        
                        <!-- Photo Upload -->
                        <div class="form-section">
                            <h4>Foto</h4>
                            <div id="photo-preview" style="width: 100px; height: 100px; border: 2px dashed #ccc; margin: 10px 0; display: flex; align-items: center; justify-content: center;">
                                <span style="color: #999;">Sin foto</span>
                            </div>
                            <input type="file" id="player-photo" accept="image/*" onchange="TestApp.previewPhoto(event)">
                            <button type="button" onclick="TestApp.clearPhoto()">Limpiar Foto</button>
                        </div>
                        
                        <!-- Attributes -->
                        <div class="form-section">
                            <h4>Atributos (1-99)</h4>
                            <div class="attributes-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label for="player-pac">PAC (Ritmo)</label>
                                    <input type="number" id="player-pac" min="1" max="99" value="70" required>
                                </div>
                                <div>
                                    <label for="player-sho">SHO (Tiro)</label>
                                    <input type="number" id="player-sho" min="1" max="99" value="70" required>
                                </div>
                                <div>
                                    <label for="player-pas">PAS (Pase)</label>
                                    <input type="number" id="player-pas" min="1" max="99" value="70" required>
                                </div>
                                <div>
                                    <label for="player-dri">DRI (Regate)</label>
                                    <input type="number" id="player-dri" min="1" max="99" value="70" required>
                                </div>
                                <div>
                                    <label for="player-def">DEF (Defensa)</label>
                                    <input type="number" id="player-def" min="1" max="99" value="70" required>
                                </div>
                                <div>
                                    <label for="player-phy">PHY (Físico)</label>
                                    <input type="number" id="player-phy" min="1" max="99" value="70" required>
                                </div>
                            </div>
                            <div style="margin-top: 10px;">
                                <label for="player-ovr">OVR (General) - Auto-calculado</label>
                                <input type="number" id="player-ovr" min="1" max="99" readonly style="background: #f0f0f0;">
                                <button type="button" onclick="TestApp.calculateOVR()">Calcular OVR</button>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" id="submit-player-btn">Agregar Jugador</button>
                            <button type="button" onclick="TestApp.hideAddPlayerForm()">Cancelar</button>
                        </div>
                    </form>
                </div>
                
                <!-- Players List -->
                <div id="players-list">
                    <p>No hay jugadores cargados</p>
                </div>
            </div>

            <!-- Matches Screen -->
            <div id="matches-screen" class="screen">
                <h2 class="section-title">Partidos Manuales</h2>
                
                <!-- Match Configuration - HIDDEN: Now handled by Create Match Modal -->
                <div id="match-config" style="
                    display: none;
                    background: var(--card-bg); 
                    backdrop-filter: blur(10px); 
                    border: 1px solid rgba(0, 255, 157, 0.1); 
                    border-radius: 12px; 
                    padding: 20px; 
                    margin-bottom: 20px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                ">
                    <h3 style="
                        margin: 0 0 20px 0; 
                        color: var(--primary); 
                        text-transform: uppercase; 
                        letter-spacing: 1px; 
                        font-size: 1.1em;
                        text-align: center;
                    ">⚙️ Configuración del Partido</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <div>
                            <label style="
                                font-weight: 600; 
                                display: block; 
                                margin-bottom: 8px; 
                                color: var(--text-light);
                                font-size: 0.9em;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            ">Formato del Partido:</label>
                            <select id="match-format" style="
                                width: 100%; 
                                padding: 12px; 
                                background: rgba(40, 40, 40, 0.8);
                                border: 1px solid rgba(0, 255, 157, 0.3); 
                                border-radius: 8px;
                                color: var(--text-light);
                                font-size: 14px;
                                cursor: pointer;
                                transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                            ">
                                <option value="5v5">5 vs 5</option>
                                <option value="7v7">7 vs 7</option>
                                <option value="11v11">11 vs 11</option>
                            </select>
                        </div>
                        <div>
                            <label style="
                                font-weight: 600; 
                                display: block; 
                                margin-bottom: 8px; 
                                color: var(--text-light);
                                font-size: 0.9em;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            ">Fecha del Partido:</label>
                            <input type="date" id="match-date" style="
                                width: 100%; 
                                padding: 12px; 
                                background: rgba(40, 40, 40, 0.8);
                                border: 1px solid rgba(0, 255, 157, 0.3); 
                                border-radius: 8px;
                                color: var(--text-light);
                                font-size: 14px;
                                transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                            ">
                        </div>
                        <div>
                            <label style="
                                font-weight: 600; 
                                display: block; 
                                margin-bottom: 8px; 
                                color: var(--text-light);
                                font-size: 0.9em;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            ">Hora del Partido:</label>
                            <input type="time" id="match-time" style="
                                width: 100%; 
                                padding: 12px; 
                                background: rgba(40, 40, 40, 0.8);
                                border: 1px solid rgba(0, 255, 157, 0.3); 
                                border-radius: 8px;
                                color: var(--text-light);
                                font-size: 14px;
                                transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                            ">
                        </div>
                    </div>
                </div>
                
                <div id="matches-actions" style="
                    display: flex; 
                    flex-wrap: wrap; 
                    gap: 15px; 
                    justify-content: center; 
                    margin-bottom: 25px;
                ">
                    <button onclick="TestApp.showCreateManualMatchModal()" style="
                        background: linear-gradient(90deg, var(--accent), var(--primary));
                        color: var(--dark);
                        padding: 15px 30px;
                        border: none;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        cursor: pointer;
                        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                        box-shadow: 0 0 15px rgba(0, 212, 255, 0.4);
                    " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 0 20px rgba(0, 212, 255, 0.6)';" 
                       onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 0 15px rgba(0, 212, 255, 0.4)';">
                        ➕ Crear Nuevo Partido
                    </button>
                    <!-- Botón Ver Historial ocultado según solicitud del usuario -->
                    <!--
                    <button onclick="TestApp.displayMatchHistory()" style="display: none;">
                        📋 Ver Historial
                    </button>
                    -->
                </div>
                
                <!-- Teams Display Container (for generated teams) -->
                <div id="teams-display" style="display: none; margin: 20px 0;">
                    <!-- Teams will be displayed here when generated -->
                </div>
                
                <!-- Match Actions (appears after generating teams) -->
                <div id="match-actions-generated" style="display: none; margin-top: 25px;">
                    <!-- Actions will be dynamically added here -->
                </div>
                
                <!-- Match History Container -->
                <div id="match-history-container" style="margin-top: 30px;">
                    <h3 style="color: var(--text-light); margin-bottom: 20px; font-size: 1.4rem;">📋 Historial de Partidos</h3>
                    <div id="match-history-list">
                        <!-- Matches will be loaded here -->
                        <p style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px;">
                            No hay partidos en el historial
                        </p>
                    </div>
                </div>
                
                <!-- Match Actions (appears after generating teams) -->
                <div id="match-actions-generated" style="
                    display: none; 
                    margin-top: 25px; 
                    padding: 20px; 
                    background: var(--card-bg); 
                    backdrop-filter: blur(10px); 
                    border-radius: 12px;
                    border: 1px solid rgba(0, 255, 157, 0.1);
                    text-align: center;
                ">
                    <h4 style="
                        color: var(--primary);
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        margin-bottom: 15px;
                        font-size: 1.1em;
                    ">⚡ Acciones del Partido</h4>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="TestApp.saveMatch()" style="
                            background: linear-gradient(90deg, #27ae60, #2ecc71);
                            color: white;
                            padding: 12px 20px;
                            border: none;
                            border-radius: 8px;
                            font-size: 14px;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            cursor: pointer;
                            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                            box-shadow: 0 0 10px rgba(46, 204, 113, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 0 15px rgba(46, 204, 113, 0.5)';" 
                           onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 0 10px rgba(46, 204, 113, 0.3)';">
                            💾 Guardar Partido
                        </button>
                        <button onclick="TestApp.generateTeams()" style="
                            background: rgba(40, 40, 40, 0.8);
                            color: var(--text-light);
                            border: 1px solid var(--primary);
                            padding: 12px 20px;
                            border-radius: 8px;
                            font-size: 14px;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            cursor: pointer;
                            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                            backdrop-filter: blur(5px);
                        " onmouseover="this.style.background='rgba(0, 255, 157, 0.1)'; this.style.borderColor='var(--secondary)';" 
                           onmouseout="this.style.background='rgba(40, 40, 40, 0.8)'; this.style.borderColor='var(--primary)';">
                            🔄 Re-generar
                        </button>
                    </div>
                </div>
            </div>


            <!-- Evaluate Screen -->
            <div id="evaluate-screen" class="screen">
                <h2 class="section-title">Evaluar Partidos</h2>
                
                <!-- Load Pending Matches Button -->
                <div id="evaluate-actions" style="
                    text-align: center; 
                    margin-bottom: 25px;
                ">
                    <button onclick="TestApp.loadPendingMatches()" style="
                        background: linear-gradient(90deg, var(--primary), var(--secondary));
                        color: var(--dark);
                        padding: 12px 25px;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        cursor: pointer;
                        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                        box-shadow: 0 0 10px rgba(0, 255, 157, 0.3);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 0 15px rgba(0, 255, 157, 0.5)';" 
                       onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 0 10px rgba(0, 255, 157, 0.3)';">
                        🔄 Cargar Partidos Pendientes
                    </button>
                </div>
                
                <!-- Pending Matches List -->
                <div id="pending-matches" style="
                    background: var(--card-bg); 
                    backdrop-filter: blur(10px); 
                    border: 1px solid rgba(0, 255, 157, 0.1); 
                    border-radius: 12px; 
                    padding: 20px; 
                    margin-bottom: 25px;
                ">
                    <h3 style="
                        color: var(--primary); 
                        text-transform: uppercase; 
                        letter-spacing: 1px; 
                        font-size: 1.1em; 
                        margin-bottom: 15px; 
                        text-align: center;
                    ">📋 Evaluaciones Pendientes</h3>
                    <div id="pending-matches-list" style="margin-top: 15px;">
                        <p style="
                            color: rgba(255, 255, 255, 0.7); 
                            text-align: center; 
                            padding: 20px;
                            font-style: italic;
                        ">Haz clic en "Cargar Partidos Pendientes" para ver los partidos listos para evaluar</p>
                    </div>
                </div>
                
                <!-- Evaluation Form -->
                <div id="evaluation-form" style="display:none;">
                    <!-- Match Header will be inserted here -->
                    <div id="match-details"></div>
                    
                    <!-- Score Section will be inserted here -->
                    <div id="score-section"></div>
                    
                    <!-- Evaluation System Selector will be inserted here -->
                    <div id="evaluation-system-selector"></div>
                    
                    <!-- Player Evaluations will be inserted here -->
                    <div id="evaluation-inputs"></div>
                    
                    <!-- Action Buttons -->
                    <div style="
                        display: flex; 
                        gap: 15px; 
                        justify-content: center; 
                        margin-top: 30px; 
                        flex-wrap: wrap;
                    ">
                        <button onclick="TestApp.submitEvaluation()" style="
                            background: linear-gradient(90deg, var(--primary), #00cc7a);
                            color: var(--dark);
                            padding: 15px 25px;
                            border: none;
                            border-radius: 8px;
                            font-size: 14px;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            cursor: pointer;
                            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                            min-width: 160px;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 0 15px rgba(0, 255, 157, 0.4)';" 
                           onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='none';">
                            💾 Guardar Evaluación
                        </button>
                        <button onclick="TestApp.cancelEvaluation()" style="
                            background: rgba(40, 40, 40, 0.8);
                            color: var(--text-light);
                            border: 1px solid var(--primary);
                            padding: 15px 25px;
                            border-radius: 8px;
                            font-size: 14px;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            cursor: pointer;
                            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                            backdrop-filter: blur(5px);
                            min-width: 160px;
                        " onmouseover="this.style.background='rgba(0, 255, 157, 0.1)'; this.style.borderColor='var(--secondary)';" 
                           onmouseout="this.style.background='rgba(40, 40, 40, 0.8)'; this.style.borderColor='var(--primary)';">
                            ❌ Cancelar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Screen -->
            <div id="stats-screen" class="screen">
                <h2>📈 Estadísticas</h2>
                <div id="stats-content">
                    <p>Las estadísticas se mostrarán aquí</p>
                </div>
            </div>

            <!-- Profile Screen -->
            <div id="profile-screen" class="screen">
                <h2>👤 Mi Perfil</h2>
                <div id="profile-content" style="max-width: 600px; margin: 0 auto;">
                    <!-- Profile info will be loaded here -->
                    <div id="profile-view" style="background: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); padding: 30px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);">
                        <div id="profile-photo-container" style="text-align: center; margin-bottom: 20px;">
                            <div id="profile-photo-display" style="width: 100px; height: 100px; margin: 0 auto; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; font-size: 48px; border: 2px solid var(--primary); box-shadow: 0 0 8px rgba(0, 255, 157, 0.3);">
                                👤
                            </div>
                        </div>
                        
                        <div id="profile-info" style="margin-bottom: 20px;">
                            <h3 style="text-align: center; margin: 10px 0; color: white; font-weight: 600;">
                                <span id="profile-name">-</span>
                            </h3>
                            <p style="text-align: center; color: rgba(255, 255, 255, 0.7);">
                                <span id="profile-email">-</span>
                            </p>
                        </div>
                        
                        <div id="profile-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">
                            <div style="background: rgba(40, 40, 40, 0.8); backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--primary); text-shadow: 0 0 4px rgba(0, 255, 157, 0.2);">
                                    <span id="profile-ovr">50</span>
                                </div>
                                <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">OVR</div>
                            </div>
                            <div style="background: rgba(40, 40, 40, 0.8); backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--secondary);">
                                    <span id="profile-position">MED</span>
                                </div>
                                <div style="color: rgba(255, 255, 255, 0.7); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Posición</div>
                            </div>
                        </div>
                        
                        <div id="profile-attributes" style="background: rgba(40, 40, 40, 0.8); backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <h4 style="margin: 0 0 15px 0; color: white; text-transform: uppercase; letter-spacing: 1px; font-size: 14px;">Atributos</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                <div style="color: rgba(255, 255, 255, 0.9); font-size: 13px;">PAC: <strong id="profile-pac" style="color: var(--primary);">50</strong></div>
                                <div style="color: rgba(255, 255, 255, 0.9); font-size: 13px;">SHO: <strong id="profile-sho" style="color: var(--primary);">50</strong></div>
                                <div style="color: rgba(255, 255, 255, 0.9); font-size: 13px;">PAS: <strong id="profile-pas" style="color: var(--primary);">50</strong></div>
                                <div style="color: rgba(255, 255, 255, 0.9); font-size: 13px;">DRI: <strong id="profile-dri" style="color: var(--primary);">50</strong></div>
                                <div style="color: rgba(255, 255, 255, 0.9); font-size: 13px;">DEF: <strong id="profile-def" style="color: var(--primary);">50</strong></div>
                                <div style="color: rgba(255, 255, 255, 0.9); font-size: 13px;">PHY: <strong id="profile-phy" style="color: var(--primary);">50</strong></div>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="editProfileWithStats()" style="
                                background: linear-gradient(90deg, var(--primary), var(--secondary));
                                color: var(--dark);
                                padding: 12px 30px;
                                border: none;
                                border-radius: 8px;
                                font-size: 16px;
                                cursor: pointer;
                                transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                                text-transform: uppercase;
                                letter-spacing: 1px;
                                font-weight: 600;
                                box-shadow: 0 0 8px rgba(0, 255, 157, 0.3);
                            ">
                                ✏️ Editar Perfil
                            </button>
                        </div>
                    </div>
                    
                    <!-- Profile edit form (hidden by default) -->
                    <div id="profile-edit" style="display: none; background: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);">
                        <h3 style="margin: 0 0 20px 0; color: white; font-weight: 600;">Editar Perfil</h3>
                        <form id="profile-edit-form" onsubmit="saveProfileWithStats(event); return false;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; color: var(--text-light); font-weight: 500;">Nombre:</label>
                                <input type="text" id="edit-profile-name" required style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid rgba(255, 255, 255, 0.1);
                                    border-radius: 5px;
                                    font-size: 16px;
                                    background: rgba(30, 30, 30, 0.8);
                                    color: var(--text-light);
                                    backdrop-filter: blur(5px);
                                ">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; color: var(--text-light); font-weight: 500;">Posición:</label>
                                <select id="edit-profile-position" required style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid rgba(255, 255, 255, 0.1);
                                    border-radius: 5px;
                                    font-size: 16px;
                                    background: rgba(30, 30, 30, 0.8);
                                    color: var(--text-light);
                                    backdrop-filter: blur(5px);
                                ">
                                    <option value="POR">POR (Portero)</option>
                                    <option value="DEF">DEF (Defensa)</option>
                                    <option value="MED">MED (Mediocampista)</option>
                                    <option value="DEL">DEL (Delantero)</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; color: var(--text-light); font-weight: 500;">Imagen de Perfil:</label>
                                <input type="file" id="edit-profile-image" accept="image/*" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid rgba(255, 255, 255, 0.1);
                                    border-radius: 5px;
                                    font-size: 16px;
                                    background: rgba(30, 30, 30, 0.8);
                                    color: var(--text-light);
                                    backdrop-filter: blur(5px);
                                ">
                                <small style="color: rgba(255, 255, 255, 0.6);">Máximo 500KB</small>
                            </div>
                            
                            <!-- Attributes Section -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: white; text-transform: uppercase; letter-spacing: 1px; font-size: 14px; margin-bottom: 15px; border-bottom: 1px solid var(--primary); padding-bottom: 8px;">Atributos (1-99)</h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: var(--text-light); font-weight: 500;">PAC (Ritmo):</label>
                                        <input type="number" id="edit-profile-pac" min="1" max="99" required style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 1px solid rgba(255, 255, 255, 0.1);
                                            border-radius: 5px;
                                            font-size: 16px;
                                            background: rgba(30, 30, 30, 0.8);
                                            color: var(--text-light);
                                            backdrop-filter: blur(5px);
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: var(--text-light); font-weight: 500;">SHO (Tiro):</label>
                                        <input type="number" id="edit-profile-sho" min="1" max="99" required style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 1px solid rgba(255, 255, 255, 0.1);
                                            border-radius: 5px;
                                            font-size: 16px;
                                            background: rgba(30, 30, 30, 0.8);
                                            color: var(--text-light);
                                            backdrop-filter: blur(5px);
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: var(--text-light); font-weight: 500;">PAS (Pase):</label>
                                        <input type="number" id="edit-profile-pas" min="1" max="99" required style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 1px solid rgba(255, 255, 255, 0.1);
                                            border-radius: 5px;
                                            font-size: 16px;
                                            background: rgba(30, 30, 30, 0.8);
                                            color: var(--text-light);
                                            backdrop-filter: blur(5px);
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: var(--text-light); font-weight: 500;">DRI (Regate):</label>
                                        <input type="number" id="edit-profile-dri" min="1" max="99" required style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 1px solid rgba(255, 255, 255, 0.1);
                                            border-radius: 5px;
                                            font-size: 16px;
                                            background: rgba(30, 30, 30, 0.8);
                                            color: var(--text-light);
                                            backdrop-filter: blur(5px);
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: var(--text-light); font-weight: 500;">DEF (Defensa):</label>
                                        <input type="number" id="edit-profile-def" min="1" max="99" required style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 1px solid rgba(255, 255, 255, 0.1);
                                            border-radius: 5px;
                                            font-size: 16px;
                                            background: rgba(30, 30, 30, 0.8);
                                            color: var(--text-light);
                                            backdrop-filter: blur(5px);
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: var(--text-light); font-weight: 500;">PHY (Físico):</label>
                                        <input type="number" id="edit-profile-phy" min="1" max="99" required style="
                                            width: 100%;
                                            padding: 10px;
                                            border: 1px solid rgba(255, 255, 255, 0.1);
                                            border-radius: 5px;
                                            font-size: 16px;
                                            background: rgba(30, 30, 30, 0.8);
                                            color: var(--text-light);
                                            backdrop-filter: blur(5px);
                                        ">
                                    </div>
                                </div>
                                <div style="margin-top: 10px; text-align: center;">
                                    <button type="button" onclick="calculateProfileOVR()" style="
                                        background: rgba(40, 40, 40, 0.8);
                                        color: var(--primary);
                                        border: 1px solid var(--primary);
                                        padding: 8px 16px;
                                        border-radius: 5px;
                                        font-size: 14px;
                                        cursor: pointer;
                                        text-transform: uppercase;
                                        letter-spacing: 1px;
                                        font-weight: 500;
                                    ">
                                        🧮 Calcular OVR
                                    </button>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button type="submit" style="
                                    flex: 1;
                                    background: linear-gradient(90deg, var(--primary), var(--secondary));
                                    color: var(--dark);
                                    padding: 12px;
                                    border: none;
                                    border-radius: 8px;
                                    font-size: 16px;
                                    cursor: pointer;
                                    text-transform: uppercase;
                                    letter-spacing: 1px;
                                    font-weight: 600;
                                    box-shadow: 0 0 8px rgba(0, 255, 157, 0.3);
                                ">
                                    💾 Guardar Cambios
                                </button>
                                <button type="button" onclick="TestApp.cancelEditProfile()" style="
                                    flex: 1;
                                    background: rgba(60, 60, 60, 0.8);
                                    color: var(--text-light);
                                    padding: 12px;
                                    border: 1px solid rgba(255, 255, 255, 0.1);
                                    border-radius: 8px;
                                    font-size: 16px;
                                    cursor: pointer;
                                    text-transform: uppercase;
                                    letter-spacing: 1px;
                                    font-weight: 500;
                                    backdrop-filter: blur(5px);
                                ">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Settings Screen -->
            <div id="settings-screen" class="screen">
                <h2>Configuración y Debug</h2>
                <div id="settings-content">
                    <h3>Gestión de Usuarios</h3>
                    <button onclick="TestApp.createTestUser()">Crear Usuario de Prueba</button>
                    <button onclick="TestApp.listUsers()">Listar Todos los Usuarios</button>
                    
                    <h3>Gestión de Grupos</h3>
                    <button onclick="TestApp.createTestGroup()">Crear Grupo de Prueba</button>
                    <button onclick="TestApp.listGroups()">Listar Todos los Grupos</button>
                    
                    <h3>Gestión de Datos</h3>
                    <button onclick="TestApp.clearCache()">Limpiar Caché</button>
                    <button onclick="TestApp.reloadApp()">Recargar App</button>
                    
                    <h3>Estado de Firebase</h3>
                    <div id="firebase-status">
                        <p>Estado: <span id="fb-status">Desconocido</span></p>
                        <p>Conexión: <span id="fb-connection">Desconocida</span></p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Console/Debug Area - COMMENTED FOR PRODUCTION -->
        <!-- 
        <div id="debug-console">
            <h3>Consola de Debug</h3>
            <div id="console-output"></div>
            <button onclick="TestApp.clearConsole()">Limpiar</button>
        </div>
        -->
    </div>

    <!-- Create Match Modal -->
    <div id="create-match-modal" class="modal hidden" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    ">
        <div class="modal-content" style="
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
            <button id="close-modal" style="
                position: absolute;
                top: 15px;
                right: 15px;
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: var(--text-secondary);
            ">&times;</button>
            
            <h3 style="margin-bottom: 25px; color: #333; text-align: center;">⚽ Crear Nuevo Partido</h3>
            
            <form id="create-match-form">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-light);">
                        Título del Partido *
                    </label>
                    <input 
                        type="text" 
                        name="match-title" 
                        required 
                        placeholder="Ej: Fútbol de los Miércoles"
                        style="
                            width: 100%;
                            padding: 12px;
                            border: 2px solid #e1e1e1;
                            border-radius: 8px;
                            font-size: 16px;
                            transition: border-color 0.3s;
                        "
                    >
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-light);">
                            Fecha *
                        </label>
                        <input 
                            type="date" 
                            name="match-date" 
                            required 
                            style="
                                width: 100%;
                                padding: 12px;
                                border: 2px solid #e1e1e1;
                                border-radius: 8px;
                                font-size: 16px;
                            "
                        >
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-light);">
                            Hora *
                        </label>
                        <input 
                            type="time" 
                            name="match-time" 
                            required 
                            style="
                                width: 100%;
                                padding: 12px;
                                border: 2px solid #e1e1e1;
                                border-radius: 8px;
                                font-size: 16px;
                            "
                        >
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-light);">
                        Ubicación *
                    </label>
                    <input 
                        type="text" 
                        name="match-location" 
                        required 
                        placeholder="Ej: Complejo Deportivo Sur"
                        style="
                            width: 100%;
                            padding: 12px;
                            border: 2px solid #e1e1e1;
                            border-radius: 8px;
                            font-size: 16px;
                        "
                    >
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-light);">
                        Máximo de Jugadores
                    </label>
                    <select 
                        name="max-players" 
                        style="
                            width: 100%;
                            padding: 12px;
                            border: 2px solid #e1e1e1;
                            border-radius: 8px;
                            font-size: 16px;
                        "
                    >
                        <option value="10" selected>10 jugadores (5 vs 5)</option>
                        <option value="14">14 jugadores (7 vs 7)</option>
                        <option value="22">22 jugadores (11 vs 11)</option>
                    </select>
                </div>

                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-light);">
                        Descripción (opcional)
                    </label>
                    <textarea 
                        name="match-description" 
                        rows="3"
                        placeholder="Información adicional sobre el partido..."
                        style="
                            width: 100%;
                            padding: 12px;
                            border: 2px solid #e1e1e1;
                            border-radius: 8px;
                            font-size: 16px;
                            resize: vertical;
                        "
                    ></textarea>
                </div>

                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button 
                        type="button" 
                        id="cancel-create-match"
                        onclick="collaborativeSystem.closeCreateMatchModal()"
                        style="
                            padding: 12px 24px;
                            border: 2px solid #ddd;
                            background: white;
                            color: var(--text-secondary);
                            border-radius: 8px;
                            font-size: 16px;
                            cursor: pointer;
                            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                        "
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit"
                        style="
                            padding: 12px 24px;
                            border: none;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: transform 0.2s;
                        "
                        onmouseover="this.style.transform='translateY(-1px)'" 
                        onmouseout="this.style.transform='translateY(0px)'"
                    >
                        🚀 Crear Partido
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="js/firebase-simple.js"></script>
    <script src="js/session-manager.js"></script>
    <script src="js/auth-system.js"></script>
    <script src="js/new-header-manager.js"></script>
    <script src="js/clean-header.js"></script>
    <script src="js/logout-handler.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/match-manager.js"></script>
    <script src="js/collaborative-system.js?v=12.0&force=20250901"></script>
    <script src="js/collaborative-match-renderer.js"></script>
    <script>
        // Check if collaborative system loaded
        console.log('🔍 After loading collaborative-system.js, CollaborativeSystem class:', typeof CollaborativeSystem);
        console.log('🔍 collaborativeSystem instance:', typeof collaborativeSystem);
        
        // Force replace fallback with real instance if needed
        if (typeof CollaborativeSystem !== 'undefined' && window.collaborativeSystem) {
            const currentInstance = window.collaborativeSystem;
            // Check if it's the fallback by checking for specific methods
            if (!currentInstance.closeInviteModal) {
                console.log('🔄 Replacing fallback with real CollaborativeSystem...');
                window.collaborativeSystem = new CollaborativeSystem();
                // Copy state from fallback
                if (currentInstance.currentUser) {
                    window.collaborativeSystem.setCurrentUser(currentInstance.currentUser);
                }
                if (currentInstance.availableMatches) {
                    currentInstance.availableMatches.forEach(match => {
                        window.collaborativeSystem.addMatch(match, true);
                    });
                }
                console.log('✅ Real CollaborativeSystem instance installed');
            }
        }
        
        // Debug function to check collaborative system status
        window.debugCollaborativeSystem = function() {
            console.log('🔍 COLLABORATIVE SYSTEM DEBUG:');
            console.log('   CollaborativeSystem class:', typeof CollaborativeSystem);
            console.log('   collaborativeSystem instance:', typeof collaborativeSystem);
            console.log('   Current user:', collaborativeSystem?.currentUser);
            console.log('   Available matches:', collaborativeSystem?.availableMatches?.length || 0);
            console.log('   Has showInviteGuestsModal?:', typeof collaborativeSystem?.showInviteGuestsModal);
            console.log('   Has closeInviteModal?:', typeof collaborativeSystem?.closeInviteModal);
            console.log('   Has saveInvitedPlayers?:', typeof collaborativeSystem?.saveInvitedPlayers);
            console.log('   Instance constructor:', collaborativeSystem?.constructor?.name);
            console.log('   Create button:', document.getElementById('create-match-btn'));
            console.log('   Modal element:', document.getElementById('create-match-modal'));
            console.log('   Collaborative screen:', document.getElementById('collaborative-screen'));
            console.log('   Available matches container:', document.getElementById('available-matches'));
            
            // Test button click
            const btn = document.getElementById('create-match-btn');
            if (btn) {
                console.log('   Button event listeners:', btn.onclick, btn._listeners);
            }
            
            // Test rendering manually
            if (collaborativeSystem && typeof collaborativeSystem.renderAvailableMatches === 'function') {
                console.log('🎨 Testing manual render...');
                collaborativeSystem.renderAvailableMatches();
            }
        };
        
        // Create a test match for debugging
        window.createTestMatch = async function() {
            if (!collaborativeSystem) {
                console.error('❌ No collaborative system available');
                return;
            }
            
            const testMatch = {
                id: 'test_match_' + Date.now(),
                title: 'Partido de Prueba DEBUG',
                date: new Date().toISOString().split('T')[0],
                time: '20:00',
                location: 'Cancha Test',
                maxPlayers: 10,
                status: 'open',
                organizer: {
                    uid: 'debug_user',
                    displayName: 'Debug User',
                    email: 'debug@test.com'
                },
                registeredPlayers: [
                    {
                        uid: 'debug_user',
                        displayName: 'Debug User',
                        position: 'MED',
                        ovr: 75,
                        isGuest: false
                    },
                    {
                        uid: 'guest_123',
                        displayName: 'Test Guest',
                        position: 'DEL',
                        ovr: 80,
                        isGuest: true
                    }
                ],
                createdAt: new Date().toISOString(),
                description: 'Partido creado para debug'
            };
            
            // Add to collaborative system
            if (!collaborativeSystem.availableMatches) {
                collaborativeSystem.availableMatches = [];
            }
            collaborativeSystem.availableMatches.push(testMatch);
            
            // Try to save to Firebase
            try {
                if (typeof db !== 'undefined' && db) {
                    await db.collection('collaborative_matches').doc(testMatch.id).set(testMatch);
                    console.log('✅ Test match saved to Firebase');
                } else {
                    console.log('⚠️ No Firebase, test match only in memory');
                }
            } catch (error) {
                console.log('⚠️ Could not save to Firebase:', error.message);
            }
            
            // Force render
            if (typeof collaborativeSystem.renderAvailableMatches === 'function') {
                collaborativeSystem.renderAvailableMatches();
                console.log('🎨 Test match added and rendered');
            } else {
                console.error('❌ renderAvailableMatches function not found');
            }
        };
        
        // Force use of original collaborative system if available, otherwise use fallback
        if (typeof CollaborativeSystem !== 'undefined') {
            console.log('✅ Using original CollaborativeSystem from collaborative-system.js');
            if (!window.collaborativeSystem) {
                window.collaborativeSystem = new CollaborativeSystem();
                console.log('✅ Created new CollaborativeSystem instance from class');
            }
        } else {
            console.log('⚠️ CollaborativeSystem class not found, creating fallback...');
            
            // Simple fallback collaborative system
            window.CollaborativeSystem = class {
                constructor() {
                    console.log('🏗️ Creating fallback CollaborativeSystem...');
                    this.currentUser = null;
                    this.availableMatches = [];
                    this.userMatches = [];
                    this.attachEventListeners();
                }
                
                attachEventListeners() {
                    console.log('🔗 Fallback: Attaching event listeners...');
                    
                    const createMatchBtn = document.getElementById('create-match-btn');
                    console.log('Fallback: Create match button found:', createMatchBtn);
                    
                    if (createMatchBtn) {
                        createMatchBtn.addEventListener('click', () => {
                            console.log('🖱️ Fallback: Create match button clicked!');
                            this.showCreateMatchModal();
                        });
                        console.log('✅ Fallback: Event listener attached');
                    }
                    
                    // Modal close button
                    const closeModal = document.getElementById('close-modal');
                    if (closeModal) {
                        closeModal.addEventListener('click', () => this.closeCreateMatchModal());
                    }

                    // Create match form
                    const createMatchForm = document.getElementById('create-match-form');
                    if (createMatchForm) {
                        createMatchForm.addEventListener('submit', (e) => this.handleCreateMatch(e));
                    }
                }
                
                showCreateMatchModal() {
                    console.log('🎯 Fallback: Showing create match modal...');
                    const modal = document.getElementById('create-match-modal');
                    if (modal) {
                        modal.classList.remove('hidden');
                        console.log('✅ Fallback: Modal shown');
                    } else {
                        console.log('❌ Fallback: Modal not found');
                    }
                }
                
                closeCreateMatchModal() {
                    const modal = document.getElementById('create-match-modal');
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                    // Reset form
                    const form = document.getElementById('create-match-form');
                    if (form) {
                        form.reset();
                    }
                }
                
                async handleCreateMatch(e) {
                    e.preventDefault();
                    
                    console.log('🏗️ Fallback: Creating match...');
                    
                    // Prevent double submissions
                    if (this._creatingMatch) {
                        console.log('⏳ Already creating a match, ignoring duplicate submission');
                        return;
                    }
                    this._creatingMatch = true;
                    
                    if (!this.currentUser) {
                        this._creatingMatch = false;
                        if (window.notificationsSystem) {
                            window.notificationsSystem.showModal({
                                title: '🔒 Autenticación Requerida',
                                message: 'Debes estar autenticado para crear un partido',
                                type: 'warning'
                            });
                        } else {
                            alert('Debes estar autenticado para crear un partido');
                        }
                        return;
                    }

                    const formData = new FormData(e.target);
                    const matchData = {
                        id: this.generateMatchId(),
                        organizer: {
                            uid: this.currentUser.uid,
                            displayName: this.currentUser.displayName,
                            email: this.currentUser.email
                        },
                        title: formData.get('match-title'),
                        date: formData.get('match-date'),
                        time: formData.get('match-time'),
                        location: formData.get('match-location'),
                        maxPlayers: parseInt(formData.get('max-players') || '10'),
                        description: formData.get('match-description') || '',
                        registeredPlayers: [],
                        status: 'open',
                        createdAt: new Date().toISOString(),
                        groupId: 'o8ZOD6N0KEHrvweFfTAd'
                    };

                    try {
                        if (typeof db !== 'undefined' && db) {
                            await db.collection('collaborative_matches').doc(matchData.id).set(matchData);
                        }
                        
                        this.closeCreateMatchModal();
                        this.showSuccessMessage('¡Partido creado exitosamente!');
                        
                        // Add the new match directly to avoid reload issues
                        this.availableMatches.unshift(matchData);
                        this.renderAvailableMatches();
                        
                    } catch (error) {
                        console.error('Error creating match:', error);
                        if (window.notificationsSystem) {
                            window.notificationsSystem.showModal({
                                title: '❌ Error',
                                message: 'Error al crear el partido. Intenta de nuevo.',
                                type: 'error'
                            });
                        } else {
                            alert('Error al crear el partido. Intenta de nuevo.');
                        }
                    } finally {
                        this._creatingMatch = false;
                        console.log('✅ Match creation completed');
                    }
                }
                
                generateMatchId() {
                    return 'match_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                }
                
                showSuccessMessage(message) {
                    if (window.notificationsSystem) {
                        window.notificationsSystem.showToast(message, 'success');
                    } else {
                        alert(message);
                    }
                }
                
                // Debug function to clean duplicates
                async cleanupDuplicateMatches() {
                    console.log('🧹 Cleaning up duplicate matches...');
                    try {
                        if (typeof db !== 'undefined' && db) {
                            const snapshot = await db.collection('collaborative_matches').get();
                            let deletedCount = 0;
                            
                            for (const doc of snapshot.docs) {
                                await doc.ref.delete();
                                deletedCount++;
                                console.log('🗑️ Deleted:', doc.id);
                            }
                            
                            console.log(`✅ Deleted ${deletedCount} matches`);
                            this.availableMatches = [];
                            this.renderAvailableMatches();
                        }
                    } catch (error) {
                        console.error('Error cleaning matches:', error);
                    }
                }
                
                setCurrentUser(user) {
                    console.log('👤 Fallback: Setting user:', user);
                    this.currentUser = user;
                }
                
                reinitializeEventListeners() {
                    console.log('🔄 Fallback: Reinitializing event listeners');
                    this.attachEventListeners();
                }
                
                // Support functions for rendering
                getJoinButtonText(match) {
                    if (!this.currentUser) return '🔐 Inicia sesión';
                    
                    if (match.registeredPlayers.length >= match.maxPlayers) {
                        return '👥 Completo';
                    }
                    
                    const isUserInMatch = match.registeredPlayers.some(p => 
                        p.uid === this.currentUser.uid || p.uid === this.currentUser.id
                    );
                    
                    if (isUserInMatch) {
                        return '✅ Ya anotado';
                    }
                    
                    return '🏃‍♂️ Anotarse';
                }
                
                formatDate(dateString) {
                    if (!dateString) return 'Fecha no definida';
                    
                    try {
                        const date = new Date(dateString);
                        return date.toLocaleDateString('es-ES', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    } catch (error) {
                        return dateString;
                    }
                }
                
                getStatusText(status) {
                    const statusMap = {
                        'open': 'Abierto',
                        'full': 'Completo',
                        'closed': 'Cerrado',
                        'cancelled': 'Cancelado'
                    };
                    return statusMap[status] || status;
                }
                
                async loadMatches() {
                    console.log('📋 Fallback: Loading matches...');
                    console.log('🔄 Current matches before loading:', this.availableMatches.length);
                    
                    // Prevent multiple simultaneous loads
                    if (this._loadingMatches) {
                        console.log('⏳ Already loading matches, skipping...');
                        return;
                    }
                    this._loadingMatches = true;
                    
                    try {
                        if (typeof db !== 'undefined' && db) {
                            // Simplified query without orderBy to avoid index requirement
                            const snapshot = await db.collection('collaborative_matches')
                                .where('status', 'in', ['open', 'full'])
                                .get();
                            
                            this.availableMatches = snapshot.docs
                                .map(doc => ({ id: doc.id, ...doc.data() }))
                                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Sort in memory
                        }
                        this.renderAvailableMatches();
                        await this.loadPendingEvaluations();
                    } catch (error) {
                        console.error('Error loading matches:', error);
                        // Show a fallback message
                        const container = document.getElementById('available-matches');
                        if (container) {
                            container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">Error cargando partidos. Intenta recargar la página.</p>';
                        }
                    } finally {
                        this._loadingMatches = false;
                        console.log('✅ Loading matches completed');
                    }
                }
                
                renderAvailableMatches() {
                    console.log('🎨 Fallback: Rendering matches...');
                    console.log('📊 Total matches to render:', this.availableMatches.length);
                    console.log('📋 Matches:', this.availableMatches.map(m => m.id));
                    
                    const availableContainer = document.getElementById('available-matches');
                    const userContainer = document.getElementById('user-matches');
                    
                    if (!availableContainer || !userContainer) return;
                    
                    // Remove duplicates by ID before rendering
                    const uniqueMatches = [];
                    const seenIds = new Set();
                    
                    for (const match of this.availableMatches) {
                        if (!seenIds.has(match.id)) {
                            seenIds.add(match.id);
                            uniqueMatches.push(match);
                        }
                    }
                    
                    console.log('✅ Unique matches after deduplication:', uniqueMatches.length);
                    
                    // Separate matches between available and user matches
                    const availableMatches = [];
                    const userMatches = [];
                    
                    uniqueMatches.forEach(match => {
                        const isUserInMatch = this.currentUser && 
                                             match.registeredPlayers.some(p => 
                                                 p.uid === this.currentUser.uid || 
                                                 p.uid === this.currentUser.id
                                             );
                        
                        if (isUserInMatch) {
                            userMatches.push(match);
                        } else {
                            availableMatches.push(match);
                        }
                    });
                    
                    // Render available matches
                    this.renderMatchList(availableMatches, availableContainer, 'available');
                    
                    // Render user matches
                    this.renderMatchList(userMatches, userContainer, 'user');
                }
                
                renderMatchList(matches, container, type) {
                    if (matches.length === 0) {
                        const message = type === 'available' ? 
                            'No hay partidos disponibles' : 
                            'No estás anotado en ningún partido';
                        container.innerHTML = `<p style="color: var(--text-secondary); text-align: center; padding: 20px;">${message}</p>`;
                        return;
                    }
                    
                    let html = '';
                    matches.forEach(match => {
                        // Separate registered players by type
                        const authenticatedPlayers = match.registeredPlayers.filter(p => !p.isGuest) || [];
                        const guestPlayers = match.registeredPlayers.filter(p => p.isGuest) || [];
                        
                        const isUserInMatch = this.currentUser && 
                                             match.registeredPlayers.some(p => 
                                                 p.uid === this.currentUser.uid || 
                                                 p.uid === this.currentUser.id
                                             );
                        
                        const isOrganizer = this.currentUser && 
                                           (match.organizer.uid === this.currentUser.uid || 
                                            match.organizer.uid === this.currentUser.id);
                        
                        html += `
                            <div class="match-card">
                                <h3>${match.title} ${isOrganizer ? '<span style="color: #007bff; font-size: 0.8em;">(Organizador)</span>' : ''}</h3>
                                <p>📅 ${match.date} a las ${match.time}</p>
                                <p>📍 ${match.location}</p>
                                <p>👥 ${match.registeredPlayers.length}/${match.maxPlayers} jugadores 
                                   ${guestPlayers.length > 0 ? `(${guestPlayers.length} invitados)` : ''}
                                </p>
                                
                                ${match.registeredPlayers.length > 0 ? `
                                    <details style="margin: 10px 0;">
                                        <summary style="cursor: pointer; font-weight: 600; color: var(--text-secondary);">Ver jugadores anotados</summary>
                                        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                            ${authenticatedPlayers.length > 0 ? `
                                                <p><strong>👤 Usuarios registrados:</strong></p>
                                                <ul style="margin: 5px 0 10px 20px;">
                                                    ${authenticatedPlayers.map(p => `<li>${p.displayName} (${p.position}) - OVR ${p.ovr}</li>`).join('')}
                                                </ul>
                                            ` : ''}
                                            ${guestPlayers.length > 0 ? `
                                                <p><strong>🎭 Invitados:</strong></p>
                                                <ul style="margin: 5px 0 10px 20px;">
                                                    ${guestPlayers.map(p => `<li>${p.displayName} (${p.position}) - OVR ${p.ovr} <em style="color: var(--text-secondary);">- invitado</em></li>`).join('')}
                                                </ul>
                                            ` : ''}
                                        </div>
                                    </details>
                                ` : ''}
                                
                                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                                    ${type === 'available' ? `
                                        <button onclick="collaborativeSystem.joinMatch('${match.id}')" 
                                                style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; flex: 1; min-width: 120px;">
                                            ${this.getJoinButtonText(match)}
                                        </button>
                                    ` : `
                                        <button onclick="collaborativeSystem.leaveMatch('${match.id}')" 
                                                style="background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; flex: 1; min-width: 120px;">
                                            🚪 Desanotarse
                                        </button>
                                        
                                        ${match.status === 'full' && match.teams ? `
                                            <button onclick="collaborativeSystem.showTeamsModal('${match.id}')" 
                                                    style="background: #17a2b8; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">
                                                ⚽ Ver Equipos
                                            </button>
                                        ` : ''}
                                    `}
                                    
                                    <!-- Botón Invitar siempre visible -->
                                    <button onclick="collaborativeSystem.showInviteGuestsModal('${match.id}')" 
                                            style="background: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">
                                        🎭 Invitar
                                    </button>
                                    
                                    <!-- Botón Borrar solo para organizador -->
                                    ${isOrganizer ? `
                                        <button onclick="collaborativeSystem.deleteMatch('${match.id}')" 
                                                style="background: #e74c3c; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">
                                            🗑️ Borrar
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                }
                
                // Action methods for collaborative matches
                async joinMatch(matchId) {
                    console.log('🏃‍♂️ Fallback: Joining match:', matchId);
                    
                    if (!this.currentUser) {
                        if (window.notificationsSystem) {
                            window.notificationsSystem.showModal({
                                title: '🔒 Autenticación Requerida',
                                message: 'Debes iniciar sesión para anotarte',
                                type: 'warning'
                            });
                        } else {
                            alert('Debes iniciar sesión para anotarte');
                        }
                        return;
                    }
                    
                    try {
                        // Find the match
                        const match = this.availableMatches.find(m => m.id === matchId);
                        if (!match) {
                            if (window.notificationsSystem) {
                                window.notificationsSystem.showModal({
                                    title: '❌ Error',
                                    message: 'Partido no encontrado',
                                    type: 'error'
                                });
                            } else {
                                alert('Partido no encontrado');
                            }
                            return;
                        }
                        
                        // Check if already in match
                        const alreadyInMatch = match.registeredPlayers.some(p => 
                            p.uid === this.currentUser.uid || p.uid === this.currentUser.id
                        );
                        
                        if (alreadyInMatch) {
                            if (window.notificationsSystem) {
                                window.notificationsSystem.showModal({
                                    title: '⚠️ Ya Registrado',
                                    message: 'Ya estás anotado en este partido',
                                    type: 'info'
                                });
                            } else {
                                alert('Ya estás anotado en este partido');
                            }
                            return;
                        }
                        
                        // Check if match is full
                        if (match.registeredPlayers.length >= match.maxPlayers) {
                            if (window.notificationsSystem) {
                                window.notificationsSystem.showModal({
                                    title: '⚠️ Partido Lleno',
                                    message: 'El partido está completo',
                                    type: 'warning'
                                });
                            } else {
                                alert('El partido está completo');
                            }
                            return;
                        }
                        
                        // Add user to match
                        const playerData = {
                            uid: this.currentUser.uid || this.currentUser.id,
                            displayName: this.currentUser.displayName || this.currentUser.name,
                            email: this.currentUser.email,
                            position: this.currentUser.position || 'MED',
                            ovr: this.currentUser.ovr || 70,
                            joinedAt: new Date().toISOString(),
                            isGuest: false
                        };
                        
                        match.registeredPlayers.push(playerData);
                        
                        // Update match status if full
                        if (match.registeredPlayers.length >= match.maxPlayers) {
                            match.status = 'full';
                        }
                        
                        // Save to Firebase
                        if (typeof db !== 'undefined' && db) {
                            await db.collection('collaborative_matches').doc(matchId).update({
                                registeredPlayers: match.registeredPlayers,
                                status: match.status
                            });
                        }
                        
                        console.log('✅ Successfully joined match');
                        if (window.notificationsSystem) {
                            window.notificationsSystem.showToast('¡Te anotaste correctamente! ✅', 'success');
                        } else {
                            alert('¡Te anotaste correctamente!');
                        }
                        
                        // Refresh display
                        this.renderAvailableMatches();
                        
                    } catch (error) {
                        console.error('Error joining match:', error);
                        if (window.notificationsSystem) {
                            window.notificationsSystem.showModal({
                                title: '❌ Error',
                                message: 'Error al anotarse: ' + error.message,
                                type: 'error'
                            });
                        } else {
                            alert('Error al anotarse: ' + error.message);
                        }
                    }
                }
                
                async leaveMatch(matchId) {
                    console.log('🚪 Fallback: Leaving match:', matchId);
                    
                    if (!this.currentUser) return;
                    
                    if (!confirm('¿Estás seguro de que quieres desanotarte de este partido?')) {
                        return;
                    }
                    
                    try {
                        // Find the match in userMatches or availableMatches
                        let match = this.userMatches?.find(m => m.id === matchId);
                        if (!match) {
                            match = this.availableMatches.find(m => m.id === matchId);
                        }
                        
                        if (!match) {
                            if (window.notificationsSystem) {
                                window.notificationsSystem.showModal({
                                    title: '❌ Error',
                                    message: 'Partido no encontrado',
                                    type: 'error'
                                });
                            } else {
                                alert('Partido no encontrado');
                            }
                            return;
                        }
                        
                        // Remove user from match
                        match.registeredPlayers = match.registeredPlayers.filter(p => 
                            p.uid !== this.currentUser.uid && p.uid !== this.currentUser.id
                        );
                        
                        // Update match status
                        match.status = match.registeredPlayers.length >= match.maxPlayers ? 'full' : 'open';
                        
                        // Save to Firebase
                        if (typeof db !== 'undefined' && db) {
                            await db.collection('collaborative_matches').doc(matchId).update({
                                registeredPlayers: match.registeredPlayers,
                                status: match.status
                            });
                        }
                        
                        console.log('✅ Successfully left match');
                        if (window.notificationsSystem) {
                            window.notificationsSystem.showToast('Te desanotaste correctamente ✅', 'success');
                        } else {
                            alert('Te desanotaste correctamente');
                        }
                        
                        // Refresh display
                        this.renderAvailableMatches();
                        
                    } catch (error) {
                        console.error('Error leaving match:', error);
                        if (window.notificationsSystem) {
                            window.notificationsSystem.showModal({
                                title: '❌ Error',
                                message: 'Error al desanotarse: ' + error.message,
                                type: 'error'
                            });
                        } else {
                            alert('Error al desanotarse: ' + error.message);
                        }
                    }
                }
                
                // Delegate to the real implementation in collaborative-system.js
                async showInviteGuestsModal(matchId) {
                    console.log('🔄 Trying to show invite modal for:', matchId);
                    
                    // Try to get the match
                    const match = this.availableMatches.find(m => m.id === matchId) || 
                                 this.userMatches?.find(m => m.id === matchId);
                    
                    if (!match) {
                        if (window.notificationsSystem) {
                            window.notificationsSystem.showModal({
                                title: '❌ Error',
                                message: 'No se pudo encontrar el partido',
                                type: 'error'
                            });
                        } else {
                            alert('❌ Error: No se pudo encontrar el partido');
                        }
                        return;
                    }
                    
                    // Get all players from storage
                    const allPlayers = Storage.getPlayers() || [];
                    console.log('📋 All players from storage:', allPlayers);
                    
                    // Get already registered player IDs
                    const registeredIds = match.registeredPlayers.map(p => p.uid || p.id);
                    
                    // Filter available players
                    const availablePlayers = allPlayers.filter(player => {
                        return !registeredIds.includes(player.id) && 
                               !registeredIds.includes(player.uid) &&
                               player.name && player.name !== 'Nuevo Jugador';
                    });
                    
                    // Calculate current capacity
                    const currentCount = match.registeredPlayers.length;
                    const maxCapacity = match.maxTotal || match.maxPlayers || 10;
                    const spotsAvailable = maxCapacity - currentCount;
                    
                    // Create and show the modal
                    this.createInviteModal(match, availablePlayers, spotsAvailable, maxCapacity, currentCount, matchId);
                }
                
                createInviteModal(match, availablePlayers, spotsAvailable, maxCapacity, currentCount, matchId) {
                    // Remove existing modal if any
                    const existingModal = document.getElementById('invite-players-modal');
                    if (existingModal) existingModal.remove();
                    
                    const modalHtml = `
                        <div id="invite-players-modal" style="
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0, 0, 0, 0.9);
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            z-index: 10000;
                            backdrop-filter: blur(5px);
                        ">
                            <div style="
                                background: var(--card-bg);
                                backdrop-filter: blur(10px);
                                border: 1px solid rgba(255, 255, 255, 0.1);
                                padding: 25px;
                                border-radius: 15px;
                                max-width: 650px;
                                width: 95%;
                                max-height: 85vh;
                                overflow-y: auto;
                                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                                    <h2 style="margin: 0; color: var(--primary); font-size: 24px; font-weight: 700; text-shadow: 0 0 10px rgba(0, 255, 157, 0.3);">🎭 Invitar Jugadores</h2>
                                    <button onclick="document.getElementById('invite-players-modal').remove()" style="
                                        background: rgba(255, 107, 107, 0.1);
                                        border: 1px solid rgba(255, 107, 107, 0.3);
                                        border-radius: 50%;
                                        width: 40px;
                                        height: 40px;
                                        font-size: 20px;
                                        cursor: pointer;
                                        color: #ff6b6b;
                                        transition: all 0.3s ease;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                    " onmouseover="this.style.background='rgba(255, 107, 107, 0.2)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(255, 107, 107, 0.1)'; this.style.transform='scale(1)'">✕</button>
                                </div>
                                
                                <div style="
                                    background: rgba(40, 40, 40, 0.8);
                                    backdrop-filter: blur(5px);
                                    border: 1px solid var(--primary);
                                    padding: 20px;
                                    border-radius: 12px;
                                    margin-bottom: 25px;
                                    box-shadow: 0 4px 15px rgba(0, 255, 157, 0.1);
                                ">
                                    <h3 style="margin: 0 0 15px 0; color: var(--primary); font-size: 20px; font-weight: 600;">${match.title}</h3>
                                    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 10px;">
                                        <span style="color: rgba(255, 255, 255, 0.9); display: flex; align-items: center; gap: 8px;">
                                            <i class='bx bx-calendar' style="font-size: 18px; color: var(--primary);"></i>
                                            ${match.date}
                                        </span>
                                        <span style="color: rgba(255, 255, 255, 0.9); display: flex; align-items: center; gap: 8px;">
                                            <i class='bx bx-time' style="font-size: 18px; color: var(--primary);"></i>
                                            ${match.time}
                                        </span>
                                        <span style="color: rgba(255, 255, 255, 0.9); display: flex; align-items: center; gap: 8px;">
                                            <i class='bx bx-map' style="font-size: 18px; color: var(--primary);"></i>
                                            ${match.location}
                                        </span>
                                    </div>
                                    <div style="
                                        display: flex; 
                                        align-items: center; 
                                        gap: 10px; 
                                        padding: 12px; 
                                        background: rgba(0, 255, 157, 0.1); 
                                        border-radius: 8px; 
                                        border: 1px solid rgba(0, 255, 157, 0.2);
                                        margin-top: 15px;
                                    ">
                                        <i class='bx bx-group' style="font-size: 24px; color: ${spotsAvailable > 0 ? 'var(--primary)' : '#ff6b6b'};"></i>
                                        <span style="font-size: 18px; font-weight: bold; color: ${spotsAvailable > 0 ? 'var(--primary)' : '#ff6b6b'};">
                                            Jugadores: ${currentCount}/${maxCapacity} 
                                            ${spotsAvailable > 0 ? `(${spotsAvailable} lugares disponibles)` : '(COMPLETO)'}
                                        </span>
                                    </div>
                                </div>
                                
                                ${spotsAvailable > 0 && availablePlayers.length > 0 ? `
                                    <div style="margin-bottom: 20px;">
                                        <h3 style="color: var(--primary); margin-bottom: 15px; font-weight: 700;">📋 Jugadores Disponibles:</h3>
                                        <div id="available-players-list" style="
                                            max-height: 250px;
                                            overflow-y: auto;
                                            background: var(--card-bg);
                                            border: 1px solid rgba(0, 255, 157, 0.2);
                                            border-radius: 8px;
                                            padding: 10px;
                                        ">
                                            ${availablePlayers.map(player => `
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    padding: 12px;
                                                    margin: 8px 0;
                                                    background: rgba(40, 40, 40, 0.6);
                                                    border: 1px solid rgba(0, 255, 157, 0.1);
                                                    border-radius: 8px;
                                                    transition: all 0.3s ease;
                                                    cursor: pointer;
                                                " onmouseover="this.style.background='rgba(0, 255, 157, 0.1)'; this.style.borderColor='rgba(0, 255, 157, 0.3)'" onmouseout="this.style.background='rgba(40, 40, 40, 0.6)'; this.style.borderColor='rgba(0, 255, 157, 0.1)'">
                                                    <input type="checkbox" 
                                                           id="player-${player.id}" 
                                                           value="${player.id}"
                                                           style="margin-right: 15px; width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary);">
                                                    <label for="player-${player.id}" style="
                                                        display: flex;
                                                        align-items: center;
                                                        width: 100%;
                                                        cursor: pointer;
                                                    ">
                                                        <div style="width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: #000; font-weight: bold; font-size: 18px; box-shadow: 0 2px 8px rgba(0, 255, 157, 0.3);">
                                                            ${player.name ? player.name.charAt(0).toUpperCase() : '?'}
                                                        </div>
                                                        <div style="flex: 1;">
                                                            <div style="font-weight: 700; color: #fff; font-size: 16px;">${player.name}</div>
                                                            <div style="color: var(--primary); font-size: 14px; font-weight: 600;">
                                                                ${player.position || 'N/A'} | OVR: ${player.ovr || 50}
                                                            </div>
                                                        </div>
                                                    </label>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : spotsAvailable === 0 ? '<div style="background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.3); border-radius: 8px; padding: 20px; text-align: center; color: #ff4444; font-weight: 600;">⚠️ El partido está completo</div>' : '<div style="background: var(--card-bg); border: 1px solid rgba(0, 255, 157, 0.2); border-radius: 8px; padding: 20px; text-align: center; color: var(--text-secondary); font-weight: 500;">📭 No hay jugadores disponibles para invitar</div>'}
                                
                                <div style="margin-bottom: 20px;">
                                    <h3 style="color: var(--primary); margin-bottom: 15px; font-weight: 700;">✅ Jugadores Ya Anotados:</h3>
                                    <div style="
                                        max-height: 200px;
                                        overflow-y: auto;
                                        background: var(--card-bg);
                                        border: 1px solid rgba(0, 255, 157, 0.2);
                                        border-radius: 8px;
                                        padding: 10px;
                                    ">
                                        ${match.registeredPlayers.map(player => `
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                padding: 12px;
                                                margin: 8px 0;
                                                background: rgba(0, 255, 157, 0.1);
                                                border: 1px solid rgba(0, 255, 157, 0.2);
                                                border-radius: 8px;
                                                box-shadow: 0 2px 6px rgba(0, 255, 157, 0.1);
                                            ">
                                                <div style="width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; background: linear-gradient(135deg, var(--primary), #00d4aa); display: flex; align-items: center; justify-content: center; color: #000; font-weight: bold; font-size: 18px; box-shadow: 0 2px 8px rgba(0, 255, 157, 0.4);">
                                                    ${(player.displayName || player.name || '?').charAt(0).toUpperCase()}
                                                </div>
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 700; color: #fff; font-size: 16px;">${player.displayName || player.name}</div>
                                                    <div style="color: var(--primary); font-size: 14px; font-weight: 600;">
                                                        ${player.position || 'N/A'} | OVR: ${player.ovr || 50}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px;">
                                    <button onclick="document.getElementById('invite-players-modal').remove()" style="
                                        background: rgba(40, 40, 40, 0.8);
                                        color: #fff;
                                        padding: 12px 24px;
                                        border: 1px solid rgba(255, 255, 255, 0.2);
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 16px;
                                        font-weight: 600;
                                        transition: all 0.3s ease;
                                    " onmouseover="this.style.background='rgba(60, 60, 60, 0.9)'; this.style.borderColor='rgba(255, 255, 255, 0.3)'" onmouseout="this.style.background='rgba(40, 40, 40, 0.8)'; this.style.borderColor='rgba(255, 255, 255, 0.2)'">
                                        ✖️ Cancelar
                                    </button>
                                    ${spotsAvailable > 0 && availablePlayers.length > 0 ? `
                                        <button onclick="collaborativeSystem.saveInvitedPlayersFromModal('${matchId}')" style="
                                            background: linear-gradient(90deg, var(--primary), var(--secondary));
                                            color: #000;
                                            padding: 12px 24px;
                                            border: none;
                                            border-radius: 6px;
                                            cursor: pointer;
                                            font-size: 16px;
                                            font-weight: 700;
                                            box-shadow: 0 4px 12px rgba(0, 255, 157, 0.3);
                                            transition: all 0.3s ease;
                                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0, 255, 157, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 255, 157, 0.3)'">
                                            💾 Guardar Invitaciones
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                }
                
                async saveInvitedPlayersFromModal(matchId) {
                    const checkboxes = document.querySelectorAll('#available-players-list input[type="checkbox"]:checked');
                    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
                    
                    if (selectedIds.length === 0) {
                        if (window.notificationsSystem) {
                            window.notificationsSystem.showModal({
                                title: '⚠️ Selección Requerida',
                                message: 'Por favor selecciona al menos un jugador',
                                type: 'warning'
                            });
                        } else {
                            alert('⚠️ Por favor selecciona al menos un jugador');
                        }
                        return;
                    }
                    
                    const match = this.availableMatches.find(m => m.id === matchId) || 
                                 this.userMatches?.find(m => m.id === matchId);
                    
                    if (!match) return;
                    
                    const allPlayers = Storage.getPlayers() || [];
                    const playersToAdd = allPlayers.filter(p => selectedIds.includes(p.id));
                    
                    playersToAdd.forEach(player => {
                        match.registeredPlayers.push({
                            uid: player.id,
                            displayName: player.name,
                            position: player.position || 'N/A',
                            ovr: player.ovr || 50,
                            registeredAt: new Date().toISOString(),
                            isGuest: false
                        });
                    });
                    
                    // Save to Firebase
                    await this.saveMatchToFirebase(match);
                    
                    // Close modal and refresh
                    document.getElementById('invite-players-modal').remove();
                    this.renderAvailableMatches();
                    
                    window.unifiedNotifications?.showToast(`Se agregaron ${playersToAdd.length} jugador(es) al partido`, 'success', '✅ Jugadores Agregados') || alert(`✅ Se agregaron ${playersToAdd.length} jugador(es) al partido`);
                }
                
                async addGuestToMatch(matchId, name, position, ovr) {
                    try {
                        const match = this.availableMatches.find(m => m.id === matchId) || 
                                     this.userMatches?.find(m => m.id === matchId);
                        
                        if (!match) {
                            if (window.notificationsSystem) {
                                window.notificationsSystem.showModal({
                                    title: '❌ Error',
                                    message: 'Partido no encontrado',
                                    type: 'error'
                                });
                            } else {
                                alert('Partido no encontrado');
                            }
                            return;
                        }
                        
                        if (match.registeredPlayers.length >= match.maxPlayers) {
                            window.unifiedNotifications?.alert('El partido está completo', '⚠️ Partido Lleno') || alert('El partido está completo');
                            return;
                        }
                        
                        const guestData = {
                            uid: 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            displayName: name,
                            position: position || 'MED',
                            ovr: ovr || 70,
                            isGuest: true,
                            invitedBy: this.currentUser?.displayName || 'Usuario',
                            joinedAt: new Date().toISOString()
                        };
                        
                        match.registeredPlayers.push(guestData);
                        
                        if (match.registeredPlayers.length >= match.maxPlayers) {
                            match.status = 'full';
                        }
                        
                        if (typeof db !== 'undefined' && db) {
                            await db.collection('collaborative_matches').doc(matchId).update({
                                registeredPlayers: match.registeredPlayers,
                                status: match.status
                            });
                        }
                        
                        window.unifiedNotifications?.showToast(`¡${name} fue invitado correctamente!`, 'success', '✅ Invitación Enviada') || alert(`¡${name} fue invitado correctamente!`);
                        this.renderAvailableMatches();
                        
                    } catch (error) {
                        console.error('Error adding guest:', error);
                        window.unifiedNotifications?.alert('Error al invitar: ' + error.message, '❌ Error') || alert('Error al invitar: ' + error.message);
                    }
                }
                
                async deleteMatch(matchId) {
                    if (!confirm('⚠️ ¿Estás seguro de que quieres ELIMINAR este partido? Esta acción no se puede deshacer.')) {
                        return;
                    }
                    
                    try {
                        if (typeof db !== 'undefined' && db) {
                            await db.collection('collaborative_matches').doc(matchId).delete();
                        }
                        
                        // Remove from local arrays
                        this.availableMatches = this.availableMatches.filter(m => m.id !== matchId);
                        if (this.userMatches) {
                            this.userMatches = this.userMatches.filter(m => m.id !== matchId);
                        }
                        
                        console.log('✅ Match deleted successfully');
                        window.unifiedNotifications?.showToast('Partido eliminado correctamente', 'success', '✅ Eliminado') || alert('Partido eliminado correctamente');
                        
                        this.renderAvailableMatches();
                        
                    } catch (error) {
                        console.error('Error deleting match:', error);
                        window.unifiedNotifications?.alert('Error al eliminar partido: ' + error.message, '❌ Error') || alert('Error al eliminar partido: ' + error.message);
                    }
                }
                
                showTeamsModal(matchId) {
                    console.log('⚽ Fallback: Showing teams modal for:', matchId);
                    
                    const match = this.availableMatches.find(m => m.id === matchId) || 
                                 this.userMatches?.find(m => m.id === matchId);
                    
                    if (!match) {
                        window.unifiedNotifications?.alert('Partido no encontrado', '❌ Error') || alert('Partido no encontrado');
                        return;
                    }
                    
                    if (!match.teams) {
                        window.unifiedNotifications?.alert('Los equipos aún no han sido generados', '⚠️ Equipos Pendientes') || alert('Los equipos aún no han sido generados');
                        return;
                    }
                    
                    let teamsInfo = `🏆 EQUIPOS PARA: ${match.title}\n\n`;
                    teamsInfo += `👕 EQUIPO A:\n`;
                    match.teams.teamA.forEach(player => {
                        teamsInfo += `• ${player.displayName} (${player.position}) - OVR ${player.ovr}\n`;
                    });
                    teamsInfo += `\n🔷 EQUIPO B:\n`;
                    match.teams.teamB.forEach(player => {
                        teamsInfo += `• ${player.displayName} (${player.position}) - OVR ${player.ovr}\n`;
                    });
                    
                    window.unifiedNotifications?.alert(teamsInfo, '🏆 Información de Equipos') || alert(teamsInfo);
                }
                
                async loadPendingEvaluations() {
                    console.log('📝 Fallback: Loading pending evaluations (stub)');
                    // Simplified version
                    const section = document.getElementById('evaluation-section');
                    if (section) {
                        section.style.display = 'none';
                    }
                }
            };
            
            // Create fallback instance ONLY if it doesn't exist
            if (!window.collaborativeSystem) {
                window.collaborativeSystem = new CollaborativeSystem();
                console.log('✅ Fallback collaborative system created');
            } else {
                console.log('⚠️ Fallback: collaborativeSystem already exists, reusing');
            }
        }

        // Ensure collaborative system is properly initialized after page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 DOM loaded - checking collaborative system...');
            
            // Give a small delay to ensure all scripts have loaded
            setTimeout(() => {
                if (typeof collaborativeSystem === 'undefined' || !collaborativeSystem) {
                    console.log('⚠️ collaborativeSystem not found after DOM load, creating it now...');
                    if (typeof CollaborativeSystem !== 'undefined' && !window.collaborativeSystem) {
                        window.collaborativeSystem = new CollaborativeSystem();
                        console.log('✅ Created collaborative system after DOM load');
                    }
                }
                
                // Event listeners are already attached in collaborative-system.js
                // No need to re-attach them here
            }, 100);
        });
    </script>
    <script src="js/test-app.js"></script>
    
    <!-- Add JavaScript for expandable player cards -->
    <script>
        // Function to get OVR class based on rating
        function getOVRClass(ovr) {
            if (ovr >= 88) return 'ovr-special'; // Star players (88+)
            if (ovr >= 85) return 'ovr-excellent'; // Excellent players (85-87)
            if (ovr >= 75) return 'ovr-gold'; // Gold players (75-84)
            if (ovr >= 65) return 'ovr-silver'; // Silver players (65-74)
            if (ovr >= 40) return 'ovr-bronze'; // Bronze players (40-64)
            return 'ovr-low'; // Low players (<40)
        }
        
        // Function to get stat class based on value
        function getStatClass(value) {
            if (value >= 85) return 'stat-excellent';
            if (value >= 70) return 'stat-good';
            if (value >= 50) return 'stat-medium';
            return 'stat-low';
        }
        
        // Function to toggle expandable player cards
        function togglePlayerCard(card) {
            const details = card.querySelector('.player-details');
            const icon = card.querySelector('.expand-icon');
            
            if (details.classList.contains('expanded')) {
                details.classList.remove('expanded');
                icon.classList.remove('rotated');
                icon.style.transform = 'rotate(0deg) scale(1)';
                icon.style.background = 'rgba(0, 255, 157, 0.1)';
                icon.style.boxShadow = '0 0 8px rgba(0, 255, 157, 0.2)';
            } else {
                details.classList.add('expanded');
                icon.classList.add('rotated');
                icon.style.transform = 'rotate(180deg) scale(1.1)';
                icon.style.background = 'rgba(0, 255, 157, 0.2)';
                icon.style.boxShadow = '0 0 12px rgba(0, 255, 157, 0.4)';
            }
        }
        
        // Function to calculate profile OVR
        function calculateProfileOVR() {
            const pac = parseInt(document.getElementById('edit-profile-pac').value) || 50;
            const sho = parseInt(document.getElementById('edit-profile-sho').value) || 50;
            const pas = parseInt(document.getElementById('edit-profile-pas').value) || 50;
            const dri = parseInt(document.getElementById('edit-profile-dri').value) || 50;
            const def = parseInt(document.getElementById('edit-profile-def').value) || 50;
            const phy = parseInt(document.getElementById('edit-profile-phy').value) || 50;
            
            const ovr = Math.round((pac + sho + pas + dri + def + phy) / 6);
            
            // Update the OVR display in the profile view
            const ovrDisplay = document.getElementById('profile-ovr');
            if (ovrDisplay) {
                ovrDisplay.textContent = ovr;
                // Add a little animation
                ovrDisplay.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    ovrDisplay.style.transform = 'scale(1)';
                }, 200);
            }
            
            // Show success message
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '✓ OVR Calculado: ' + ovr;
            button.style.background = 'rgba(46, 204, 113, 0.2)';
            button.style.borderColor = '#2ecc71';
            button.style.color = '#2ecc71';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = 'rgba(40, 40, 40, 0.8)';
                button.style.borderColor = 'var(--primary)';
                button.style.color = 'var(--primary)';
            }, 2000);
        }
        
        // EA SPORTS player rendering function - Now using Enhanced View
        window.renderPlayersEASports = function(players) {
            console.log('🎨 Rendering players with Enhanced EA SPORTS styling');
            console.log('🔍 Players count:', players ? players.length : 0);
            
            // Use the new enhanced players view if available
            if (typeof PlayersViewEnhanced !== 'undefined' && PlayersViewEnhanced.displayPlayers) {
                console.log('✨ Using Enhanced Players View');
                PlayersViewEnhanced.displayPlayers(players);
                return;
            }
            
            // Fallback to original implementation
            const container = document.getElementById('players-list');
            
            if (!players || players.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No hay jugadores cargados</p>';
                return;
            }
            
            let html = '';
            players.forEach((player, index) => {
                // Get attributes or use defaults (compatible with TestApp format)
                const attrs = player.attributes || {};
                const pac = attrs.pac || attrs.ritmo || player.pac || 70;
                const sho = attrs.sho || attrs.tiro || player.sho || 70;
                const pas = attrs.pas || attrs.pase || player.pas || 70;
                const dri = attrs.dri || attrs.regate || player.dri || 70;
                const def = attrs.def || attrs.defensa || player.def || 70;
                const phy = attrs.phy || attrs.fisico || player.phy || 70;
                
                const ovrClass = getOVRClass(player.ovr);
                
                // Handle photo display like TestApp does
                let photoHtml;
                if (player.photo && (player.photo.startsWith('data:') || player.photo.startsWith('http'))) {
                    photoHtml = `<img src="${player.photo}" alt="${player.name}">`;
                } else if (player.photo && player.photo.length <= 4) {
                    // It's an emoji
                    photoHtml = player.photo;
                } else {
                    // No photo - use football emoji
                    photoHtml = '⚽';
                }
                
                html += `
                    <div class="player-card" onclick="togglePlayerCard(this)">
                        <div class="player-header">
                            <div class="player-basic-info">
                                <div class="player-photo">
                                    ${photoHtml}
                                </div>
                                <div class="player-info">
                                    <div class="player-name">${player.name.toUpperCase()}</div>
                                    <div class="player-position">
                                        <span class="position-${player.position}">${player.position}</span>
                                        ${(player.isAuthenticated || player.isAuthenticatedUser) ? 
                                            '<span style="font-size: 9px; background: rgba(255,255,255,0.2); color: var(--text-light); padding: 2px 4px; border-radius: 2px; margin-left: 6px;">AUTH</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="player-rating-section">
                                <div class="player-rating ${ovrClass}">
                                    ${player.ovr}${player.ovr >= 88 ? '<span class="ovr-badge">⭐</span>' : ''}
                                </div>
                                <div class="expand-icon" style="
                                    width: 24px; 
                                    height: 24px; 
                                    border: 2px solid var(--primary); 
                                    border-radius: 50%; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center; 
                                    font-size: 12px; 
                                    color: var(--primary); 
                                    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                                    background: rgba(0, 255, 157, 0.1);
                                    box-shadow: 0 0 8px rgba(0, 255, 157, 0.2);
                                ">▼</div>
                            </div>
                        </div>
                        <div class="player-details">
                            <div class="player-stats">
                                <div class="stat-item">
                                    <span class="stat-label">PAC</span>
                                    <span class="stat-value ${getStatClass(pac)}">${pac}</span>
                                    <div class="stat-bar">
                                        <div class="stat-fill" style="width: ${pac}%"></div>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">SHO</span>
                                    <span class="stat-value ${getStatClass(sho)}">${sho}</span>
                                    <div class="stat-bar">
                                        <div class="stat-fill" style="width: ${sho}%"></div>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">PAS</span>
                                    <span class="stat-value ${getStatClass(pas)}">${pas}</span>
                                    <div class="stat-bar">
                                        <div class="stat-fill" style="width: ${pas}%"></div>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">DRI</span>
                                    <span class="stat-value ${getStatClass(dri)}">${dri}</span>
                                    <div class="stat-bar">
                                        <div class="stat-fill" style="width: ${dri}%"></div>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">DEF</span>
                                    <span class="stat-value ${getStatClass(def)}">${def}</span>
                                    <div class="stat-bar">
                                        <div class="stat-fill" style="width: ${def}%"></div>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">PHY</span>
                                    <span class="stat-value ${getStatClass(phy)}">${phy}</span>
                                    <div class="stat-bar">
                                        <div class="stat-fill" style="width: ${phy}%"></div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                ${(player.isAuthenticated || player.isAuthenticatedUser) ? 
                                    '' : 
                                    `<button onclick="event.stopPropagation(); TestApp.editPlayer('${player.id}')" style="flex: 1;">
                                        ✏️ Editar
                                    </button>
                                    <button onclick="event.stopPropagation(); TestApp.deletePlayer('${player.id}')" style="flex: 1; background: linear-gradient(90deg, #e74c3c, #c0392b) !important;">
                                        🗑️ Borrar
                                    </button>`
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Update dashboard stats
            if (players.length > 0) {
                const totalPlayers = players.length;
                const averageOVR = Math.round(players.reduce((sum, p) => sum + p.ovr, 0) / totalPlayers);
                
                const totalPlayersEl = document.getElementById('total-players');
                const averageOVREl = document.getElementById('average-ovr');
                
                if (totalPlayersEl) totalPlayersEl.textContent = totalPlayers;
                if (averageOVREl) averageOVREl.textContent = averageOVR;
            }
        };
        
        // Override TestApp displayPlayers when it becomes available
        function overrideTestAppRender() {
            if (typeof TestApp !== 'undefined' && TestApp.displayPlayers) {
                console.log('🔄 Overriding TestApp.displayPlayers with EA SPORTS version');
                const originalDisplay = TestApp.displayPlayers;
                TestApp.displayPlayers = function() {
                    renderPlayersEASports(this.players);
                };
                return true;
            }
            return false;
        }
        
        // Enhanced saveProfile function to handle stats
        window.saveProfileWithStats = async function(event) {
            event.preventDefault();
            
            console.log('🔄 Saving profile with stats...');
            
            // Get current user
            let currentUser = null;
            if (window.AuthSystem && window.AuthSystem.currentUser) {
                currentUser = window.AuthSystem.currentUser;
            } else if (window.TestApp && window.TestApp.currentUser) {
                currentUser = window.TestApp.currentUser;
            }
            
            if (!currentUser) {
                window.unifiedNotifications?.alert('No estás autenticado', '🔒 Autenticación Requerida') || alert('No estás autenticado');
                return;
            }
            
            // Get form values
            const newName = document.getElementById('edit-profile-name').value.trim();
            const newPosition = document.getElementById('edit-profile-position').value;
            const imageFile = document.getElementById('edit-profile-image').files[0];
            
            // Get stats values
            const newPac = parseInt(document.getElementById('edit-profile-pac').value) || 50;
            const newSho = parseInt(document.getElementById('edit-profile-sho').value) || 50;
            const newPas = parseInt(document.getElementById('edit-profile-pas').value) || 50;
            const newDri = parseInt(document.getElementById('edit-profile-dri').value) || 50;
            const newDef = parseInt(document.getElementById('edit-profile-def').value) || 50;
            const newPhy = parseInt(document.getElementById('edit-profile-phy').value) || 50;
            
            // Calculate new OVR
            const newOVR = Math.round((newPac + newSho + newPas + newDri + newDef + newPhy) / 6);
            
            console.log('📊 New stats:', { pac: newPac, sho: newSho, pas: newPas, dri: newDri, def: newDef, phy: newPhy, ovr: newOVR });
            
            try {
                // Process image if provided
                let newPhoto = currentUser.photo;
                if (imageFile) {
                    // Check file size
                    if (imageFile.size > 500 * 1024) {
                        window.unifiedNotifications?.alert('La imagen es demasiado grande. Por favor selecciona una imagen menor a 500KB.', '⚠️ Imagen Muy Grande') || alert('La imagen es demasiado grande. Por favor selecciona una imagen menor a 500KB.');
                        return;
                    }
                    
                    // Convert to base64
                    newPhoto = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(imageFile);
                    });
                }
                
                // Update in Firestore
                if (typeof db !== 'undefined' && db) {
                    await db.collection('futbol_users').doc(currentUser.uid).update({
                        displayName: newName,
                        position: newPosition,
                        ovr: newOVR,
                        pac: newPac,
                        sho: newSho,
                        pas: newPas,
                        dri: newDri,
                        def: newDef,
                        phy: newPhy,
                        photo: newPhoto,
                        updatedAt: new Date().toISOString()
                    });
                    
                    console.log('✅ Profile updated in Firestore');
                }
                
                // Update local current user objects
                currentUser.displayName = newName;
                currentUser.name = newName;
                currentUser.position = newPosition;
                currentUser.ovr = newOVR;
                currentUser.pac = newPac;
                currentUser.sho = newSho;
                currentUser.pas = newPas;
                currentUser.dri = newDri;
                currentUser.def = newDef;
                currentUser.phy = newPhy;
                currentUser.photo = newPhoto;
                
                // Update all system references
                if (window.AuthSystem) {
                    window.AuthSystem.currentUser = currentUser;
                }
                if (window.TestApp) {
                    window.TestApp.currentUser = currentUser;
                }
                if (window.collaborativeSystem) {
                    window.collaborativeSystem.setCurrentUser(currentUser);
                }
                
                // Update session storage
                const sessionData = {
                    ...currentUser,
                    timestamp: Date.now(),
                    deviceId: window.AuthSystem ? window.AuthSystem.getDeviceFingerprint() : null
                };
                
                if (window.AuthSystem && window.AuthSystem.USE_SESSION_STORAGE) {
                    sessionStorage.setItem('auth_current_session', JSON.stringify(sessionData));
                } else {
                    localStorage.setItem('auth_current_session', JSON.stringify(sessionData));
                }
                
                // Update profile view display immediately
                document.getElementById('profile-name').textContent = newName;
                document.getElementById('profile-position').textContent = newPosition;
                document.getElementById('profile-ovr').textContent = newOVR;
                document.getElementById('profile-pac').textContent = newPac;
                document.getElementById('profile-sho').textContent = newSho;
                document.getElementById('profile-pas').textContent = newPas;
                document.getElementById('profile-dri').textContent = newDri;
                document.getElementById('profile-def').textContent = newDef;
                document.getElementById('profile-phy').textContent = newPhy;
                
                // Update profile photo if changed
                if (newPhoto && newPhoto !== currentUser.photo) {
                    const photoDisplay = document.getElementById('profile-photo-display');
                    if (photoDisplay) {
                        if (newPhoto.startsWith('data:') || newPhoto.startsWith('http')) {
                            photoDisplay.innerHTML = `<img src="${newPhoto}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"/>`;
                        } else {
                            photoDisplay.textContent = newPhoto;
                        }
                    }
                }
                
                // Close edit form
                if (window.TestApp && window.TestApp.cancelEditProfile) {
                    window.TestApp.cancelEditProfile();
                } else {
                    document.getElementById('profile-edit').style.display = 'none';
                    document.getElementById('profile-view').style.display = 'block';
                }
                
                // Show success message
                window.unifiedNotifications?.showToast('Perfil actualizado correctamente!', 'success', '✅ Perfil Actualizado') || alert('✅ Perfil actualizado correctamente!');
                console.log('✅ Profile update completed');
                
            } catch (error) {
                console.error('❌ Error saving profile:', error);
                window.unifiedNotifications?.alert('Error al guardar el perfil: ' + error.message, '❌ Error') || alert('Error al guardar el perfil: ' + error.message);
            }
        }
        
        // Enhanced editProfile function to load stats data
        window.editProfileWithStats = function() {
            // Show edit form
            document.getElementById('profile-view').style.display = 'none';
            document.getElementById('profile-edit').style.display = 'block';
            
            // Get current user
            let currentUser = null;
            if (window.AuthSystem && window.AuthSystem.currentUser) {
                currentUser = window.AuthSystem.currentUser;
            } else if (window.TestApp && window.TestApp.currentUser) {
                currentUser = window.TestApp.currentUser;
            }
            
            if (!currentUser) {
                console.log('⚠️ No current user found');
                return;
            }
            
            console.log('📥 Loading profile data for editing:', currentUser.displayName);
            console.log('📊 Current user stats:', { pac: currentUser.pac, sho: currentUser.sho, pas: currentUser.pas, dri: currentUser.dri, def: currentUser.def, phy: currentUser.phy });
            
            // Load basic data
            document.getElementById('edit-profile-name').value = currentUser.displayName || currentUser.name || '';
            document.getElementById('edit-profile-position').value = currentUser.position || 'MED';
            
            // Load stats with fallbacks
            document.getElementById('edit-profile-pac').value = currentUser.pac || 50;
            document.getElementById('edit-profile-sho').value = currentUser.sho || 50;
            document.getElementById('edit-profile-pas').value = currentUser.pas || 50;
            document.getElementById('edit-profile-dri').value = currentUser.dri || 50;
            document.getElementById('edit-profile-def').value = currentUser.def || 50;
            document.getElementById('edit-profile-phy').value = currentUser.phy || 50;
            
            console.log('✅ Profile data loaded successfully');
        }
        
        // Override TestApp startMatchEvaluation function for EA SPORTS styling
        function overrideEvaluationSystem() {
            if (typeof TestApp !== 'undefined' && TestApp.startMatchEvaluation && !TestApp._eaSportsEvaluationOverrideApplied) {
                console.log('🎨 Applying EA SPORTS evaluation system override');
                TestApp._eaSportsEvaluationOverrideApplied = true;
                const originalStartMatchEvaluation = TestApp.startMatchEvaluation;
                
                TestApp.startMatchEvaluation = function(matchId) {
                    console.log('🎯 Starting EA SPORTS evaluation for match:', matchId);
                    
                    // Call original function to set up currentEvaluation data
                    originalStartMatchEvaluation.call(this, matchId);
                    
                    // Completely replace the evaluation form with EA SPORTS design
                    setTimeout(() => {
                        this.createCompleteEASportsEvaluationForm();
                    }, 100);
                };
                
                // New function to completely replace evaluation form with EA SPORTS design
                TestApp.createCompleteEASportsEvaluationForm = function() {
                    console.log('🎨 Creating complete EA SPORTS evaluation form');
                    
                    if (!this.currentEvaluation || !this.currentEvaluation.match) {
                        console.warn('⚠️ No current evaluation or match data');
                        return;
                    }
                    
                    const match = this.currentEvaluation.match;
                    
                    // Completely replace match details
                    const matchDetails = document.getElementById('match-details');
                    if (matchDetails) {
                        matchDetails.innerHTML = `
                            <div class="eval-match-header">
                                <div class="eval-match-title">⚽ ${match.format} - ${match.date}</div>
                                <div class="eval-match-info">📍 Evaluando partido del ${new Date(match.createdAt).toLocaleDateString()}</div>
                            </div>
                        `;
                    }
                    
                    // Completely replace score section
                    const scoreSection = document.getElementById('score-section');
                    if (scoreSection) {
                        scoreSection.innerHTML = this.createEASportsScoreSection();
                    }
                    
                    // Completely replace system selector
                    const systemSelector = document.getElementById('evaluation-system-selector');
                    if (systemSelector) {
                        systemSelector.innerHTML = this.createEASportsSystemSelector();
                    }
                    
                    // Completely replace player evaluations
                    const evaluationInputs = document.getElementById('evaluation-inputs');
                    if (evaluationInputs) {
                        evaluationInputs.innerHTML = `
                            <div class="eval-players-section">
                                <div class="eval-team-players team-a">
                                    <div class="eval-players-title">👕 Jugadores Con Chaleco</div>
                                    ${match.teamA.players.map(player => this.createEASportsPlayerCard(player, 'team-a')).join('')}
                                </div>
                                <div class="eval-team-players team-b">
                                    <div class="eval-players-title">🏃 Jugadores Sin Chaleco</div>
                                    ${match.teamB.players.map(player => this.createEASportsPlayerCard(player, 'team-b')).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    // Initialize player performance data for all players
                    this.initializePlayerPerformanceData();
                    
                    console.log('✅ Complete EA SPORTS evaluation form created');
                };
                
                // Initialize performance data for all players in the match
                TestApp.initializePlayerPerformanceData = function() {
                    if (!this.currentEvaluation || !this.currentEvaluation.match) return;
                    
                    const match = this.currentEvaluation.match;
                    const allPlayers = [...match.teamA.players, ...match.teamB.players];
                    
                    if (!this.currentEvaluation.playerPerformances) {
                        this.currentEvaluation.playerPerformances = {};
                    }
                    
                    allPlayers.forEach(player => {
                        if (!this.currentEvaluation.playerPerformances[player.id]) {
                            this.currentEvaluation.playerPerformances[player.id] = {
                                tags: [],
                                rating: 5,
                                goals: 0,
                                notes: ''
                            };
                        }
                    });
                    
                    console.log(`🎮 Initialized performance data for ${allPlayers.length} players`);
                };
                
                // Consolidate all player performance data before submission
                TestApp.consolidatePlayerPerformanceData = function() {
                    if (!this.currentEvaluation || !this.currentEvaluation.match) return;
                    
                    console.log('📊 Consolidating all player performance data...');
                    
                    const match = this.currentEvaluation.match;
                    const allPlayers = [...match.teamA.players, ...match.teamB.players];
                    
                    allPlayers.forEach(player => {
                        this.updatePlayerPerformanceData(player.id);
                    });
                    
                    console.log('✅ Consolidated performance data for all players');
                    console.log('📈 Final playerPerformances:', this.currentEvaluation.playerPerformances);
                };
                
                // Create EA SPORTS score section
                TestApp.createEASportsScoreSection = function() {
                    const match = this.currentEvaluation.match;
                    const teamAScore = match.teamA?.score || 0;
                    const teamBScore = match.teamB?.score || 0;
                    
                    return `
                        <div class="eval-scores-section">
                            <div class="eval-team-score team-a">
                                <div class="eval-team-name">👕 CON CHALECO</div>
                                <div class="eval-score-display" id="teamA-score">${teamAScore}</div>
                                <input type="hidden" id="team-a-score" value="${teamAScore}">
                                <div class="eval-score-controls">
                                    <button class="eval-score-btn plus" onclick="TestApp.updateTeamScore('teamA', 1)">+</button>
                                    <button class="eval-score-btn minus" onclick="TestApp.updateTeamScore('teamA', -1)">−</button>
                                </div>
                            </div>
                            <div class="eval-team-score team-b">
                                <div class="eval-team-name">🏃 SIN CHALECO</div>
                                <div class="eval-score-display" id="teamB-score">${teamBScore}</div>
                                <input type="hidden" id="team-b-score" value="${teamBScore}">
                                <div class="eval-score-controls">
                                    <button class="eval-score-btn plus" onclick="TestApp.updateTeamScore('teamB', 1)">+</button>
                                    <button class="eval-score-btn minus" onclick="TestApp.updateTeamScore('teamB', -1)">−</button>
                                </div>
                            </div>
                        </div>
                    `;
                };
                
                // Create EA SPORTS system selector
                TestApp.createEASportsSystemSelector = function() {
                    return `
                        <div class="eval-system-selector">
                            <div class="eval-system-title">⚙️ Elegir Sistema de Evaluación</div>
                            <div class="eval-system-options">
                                <div class="eval-system-option ${this.evaluationSystem === 'tags' ? 'selected' : ''}" onclick="TestApp.selectEvaluationSystem('tags')">
                                    <input type="radio" name="eval-system" value="tags" ${this.evaluationSystem === 'tags' ? 'checked' : ''}>
                                    <div class="eval-option-title">
                                        <span>🏷️</span>
                                        <span>Sistema de Etiquetas (Detallado)</span>
                                    </div>
                                    <div class="eval-option-description">
                                        Control manual con etiquetas de rendimiento específicas por jugador
                                    </div>
                                </div>
                                <div class="eval-system-option ${this.evaluationSystem === 'rating' ? 'selected' : ''}" onclick="TestApp.selectEvaluationSystem('rating')">
                                    <input type="radio" name="eval-system" value="rating" ${this.evaluationSystem === 'rating' ? 'checked' : ''}>
                                    <div class="eval-option-title">
                                        <span>📊</span>
                                        <span>Sistema de Calificación (Simple)</span>
                                    </div>
                                    <div class="eval-option-description">
                                        Calificación numérica del 1-10 con notas adicionales
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                };
                
                // Update team score function
                TestApp.updateTeamScore = function(team, change) {
                    const match = this.currentEvaluation.match;
                    const currentScore = match[team]?.score || 0;
                    const newScore = Math.max(0, currentScore + change);
                    
                    match[team].score = newScore;
                    document.getElementById(`${team}-score`).textContent = newScore;
                    
                    // Update hidden input that submitEvaluation expects
                    const teamId = team === 'teamA' ? 'team-a-score' : 'team-b-score';
                    const hiddenInput = document.getElementById(teamId);
                    if (hiddenInput) {
                        hiddenInput.value = newScore;
                    }
                    
                    console.log(`Updated ${team} score to ${newScore}`);
                };
                
                // Style player evaluations
                TestApp.stylePlayerEvaluations = function() {
                    const evaluationInputs = document.getElementById('evaluation-inputs');
                    if (evaluationInputs) {
                        // Wait for player cards to be generated then style them
                        setTimeout(() => {
                            this.convertToEASportsPlayerCards();
                        }, 200);
                    }
                };
                
                // Convert existing player cards to EA SPORTS style
                TestApp.convertToEASportsPlayerCards = function() {
                    const playerCards = document.querySelectorAll('.player-evaluation-card');
                    if (playerCards.length === 0) return;
                    
                    const teamAPlayers = [];
                    const teamBPlayers = [];
                    
                    playerCards.forEach((card, index) => {
                        const isTeamA = index < playerCards.length / 2;
                        const playerData = this.extractPlayerDataFromCard(card);
                        
                        if (isTeamA) {
                            teamAPlayers.push(playerData);
                        } else {
                            teamBPlayers.push(playerData);
                        }
                    });
                    
                    // Replace with EA SPORTS styled cards
                    const evaluationInputs = document.getElementById('evaluation-inputs');
                    evaluationInputs.innerHTML = `
                        <div class="eval-players-section">
                            <div class="eval-team-players team-a">
                                <div class="eval-players-title">👕 Jugadores Con Chaleco</div>
                                ${teamAPlayers.map(player => this.createEASportsPlayerCard(player, 'team-a')).join('')}
                            </div>
                            <div class="eval-team-players team-b">
                                <div class="eval-players-title">🏃 Jugadores Sin Chaleco</div>
                                ${teamBPlayers.map(player => this.createEASportsPlayerCard(player, 'team-b')).join('')}
                            </div>
                        </div>
                    `;
                };
                
                // Extract player data from original card
                TestApp.extractPlayerDataFromCard = function(card) {
                    const nameEl = card.querySelector('.player-evaluation-card div[style*="font-weight: bold"]');
                    const infoEl = card.querySelector('.player-evaluation-card div[style*="font-size: 12px; color: #666"]');
                    
                    const name = nameEl ? nameEl.textContent : 'Jugador';
                    const info = infoEl ? infoEl.textContent.split(' | ') : ['MED', 'OVR: 70'];
                    const position = info[0] || 'MED';
                    const ovr = info[1] ? info[1].replace('OVR: ', '') : '70';
                    
                    return { name, position, ovr, id: Math.random().toString(36) };
                };
                
                // Create EA SPORTS player card
                TestApp.createEASportsPlayerCard = function(player, teamClass) {
                    // Get correct player ID from players list (for registered players)
                    const correctPlayer = this.getCorrectPlayerForCard(player);
                    const isTagsSystem = this.evaluationSystem === 'tags';
                    
                    if (isTagsSystem) {
                        return `
                            <div class="eval-player-card" data-player-id="${correctPlayer.id}">
                                <div class="eval-player-header">
                                    <div class="eval-player-photo">⚽</div>
                                    <div class="eval-player-info">
                                        <div class="eval-player-name">${correctPlayer.name.toUpperCase()}</div>
                                        <div class="eval-player-meta">
                                            <span class="position-${correctPlayer.position}">${correctPlayer.position}</span>
                                            <span>OVR: ${correctPlayer.ovr}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="eval-tags-container">
                                    ${Object.keys(this.performanceTags).map(tagKey => `
                                        <button class="eval-tag-btn" data-tag="${tagKey}" data-player="${correctPlayer.id}"
                                                onclick="TestApp.togglePerformanceTag('${correctPlayer.id}', '${tagKey}')">
                                            ${this.performanceTags[tagKey].icon} ${this.performanceTags[tagKey].label}
                                        </button>
                                    `).join('')}
                                </div>
                                <div class="eval-notes-area">
                                    <textarea class="eval-notes-textarea" placeholder="Notas adicionales..." 
                                              onchange="TestApp.updatePlayerNotes('${correctPlayer.id}', this.value)"></textarea>
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="eval-player-card" data-player-id="${correctPlayer.id}">
                                <div class="eval-player-header">
                                    <div class="eval-player-photo">⚽</div>
                                    <div class="eval-player-info">
                                        <div class="eval-player-name">${correctPlayer.name.toUpperCase()}</div>
                                        <div class="eval-player-meta">
                                            <span class="position-${correctPlayer.position}">${correctPlayer.position}</span>
                                            <span>OVR: ${correctPlayer.ovr}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="eval-rating-controls">
                                    <div class="eval-rating-group">
                                        <label class="eval-rating-label">Calificación (1-10)</label>
                                        <input type="number" class="eval-rating-input" value="7.0" min="1" max="10" step="0.1"
                                               onchange="TestApp.updatePlayerRating('${correctPlayer.id}', this.value)">
                                    </div>
                                    <div class="eval-rating-group">
                                        <label class="eval-rating-label">Goles</label>
                                        <input type="number" class="eval-rating-input" value="0" min="0" max="10"
                                               onchange="TestApp.updatePlayerGoals('${correctPlayer.id}', this.value)">
                                    </div>
                                </div>
                                <div class="eval-notes-area">
                                    <textarea class="eval-notes-textarea" placeholder="Notas adicionales sobre el rendimiento..."
                                              onchange="TestApp.updatePlayerNotes('${correctPlayer.id}', this.value)"></textarea>
                                </div>
                            </div>
                        `;
                    }
                };
                
                // Override displayPlayerEvaluations to work with EA SPORTS structure
                TestApp.displayPlayerEvaluations = function() {
                    console.log('🎨 EA SPORTS: Displaying player evaluations');
                    
                    const match = this.currentEvaluation.match;
                    if (!match) {
                        console.warn('⚠️ No current match for evaluation');
                        return;
                    }
                    
                    // Update Team A container
                    const teamAContainer = document.querySelector('.eval-team-players.team-a');
                    if (teamAContainer && match.teamA && match.teamA.players) {
                        let teamAHtml = '<div class="eval-players-title">👕 Jugadores Con Chaleco</div>';
                        match.teamA.players.forEach(player => {
                            teamAHtml += this.createEASportsPlayerCard(player, 'team-a');
                        });
                        teamAContainer.innerHTML = teamAHtml;
                    }
                    
                    // Update Team B container
                    const teamBContainer = document.querySelector('.eval-team-players.team-b');
                    if (teamBContainer && match.teamB && match.teamB.players) {
                        let teamBHtml = '<div class="eval-players-title">🏃 Jugadores Sin Chaleco</div>';
                        match.teamB.players.forEach(player => {
                            teamBHtml += this.createEASportsPlayerCard(player, 'team-b');
                        });
                        teamBContainer.innerHTML = teamBHtml;
                    }
                    
                    console.log('✅ EA SPORTS: Player evaluations displayed successfully');
                };
                
                // Override selectEvaluationSystem to work with EA SPORTS structure
                TestApp.selectEvaluationSystem = function(system) {
                    console.log(`🎨 EA SPORTS: Changing evaluation system to ${system}`);
                    this.evaluationSystem = system;
                    
                    // Update the visual selection in EA SPORTS structure
                    const options = document.querySelectorAll('.eval-system-option');
                    options.forEach(option => {
                        const radio = option.querySelector('input[type="radio"]');
                        if (radio && radio.value === system) {
                            option.classList.add('selected');
                            radio.checked = true;
                        } else {
                            option.classList.remove('selected');
                            if (radio) radio.checked = false;
                        }
                    });
                    
                    // Refresh player evaluation forms
                    this.displayPlayerEvaluations();
                };
                
                // Add missing togglePerformanceTag function
                TestApp.togglePerformanceTag = function(playerId, tagKey) {
                    console.log(`🏷️ Toggling tag "${tagKey}" for player ${playerId}`);
                    
                    if (!this.currentEvaluation) {
                        console.warn('⚠️ No current evaluation');
                        return;
                    }
                    
                    if (!this.currentEvaluation.playerTags) {
                        this.currentEvaluation.playerTags = {};
                    }
                    
                    if (!this.currentEvaluation.playerTags[playerId]) {
                        this.currentEvaluation.playerTags[playerId] = [];
                    }
                    
                    const playerTags = this.currentEvaluation.playerTags[playerId];
                    const tagIndex = playerTags.indexOf(tagKey);
                    
                    // Find the button element
                    const button = document.querySelector(`[data-tag="${tagKey}"][data-player="${playerId}"]`);
                    
                    if (tagIndex > -1) {
                        // Remove tag
                        playerTags.splice(tagIndex, 1);
                        if (button) {
                            button.classList.remove('active');
                            button.classList.remove('selected');
                        }
                        console.log(`🏷️ Removed tag "${tagKey}" from player ${playerId}`);
                    } else {
                        // Add tag
                        playerTags.push(tagKey);
                        if (button) {
                            button.classList.add('active');
                            button.classList.add('selected');
                        }
                        console.log(`🏷️ Added tag "${tagKey}" to player ${playerId}`);
                    }
                    
                    // Update tag counter for this player
                    this.updatePlayerTagCounter(playerId);
                    
                    // Update performance data format
                    this.updatePlayerPerformanceData(playerId);
                };
                
                // Add tag counter functionality
                TestApp.updatePlayerTagCounter = function(playerId) {
                    const playerTags = this.currentEvaluation?.playerTags?.[playerId] || [];
                    const playerCard = document.querySelector(`[data-player-id="${playerId}"]`);
                    
                    if (playerCard) {
                        let counter = playerCard.querySelector('.eval-tag-counter');
                        if (!counter) {
                            counter = document.createElement('div');
                            counter.className = 'eval-tag-counter';
                            const header = playerCard.querySelector('.eval-player-header');
                            if (header) header.appendChild(counter);
                        }
                        
                        if (playerTags.length > 0) {
                            counter.textContent = `${playerTags.length} etiquetas`;
                            counter.style.display = 'block';
                        } else {
                            counter.style.display = 'none';
                        }
                    }
                };
                
                // Add rating system functions
                TestApp.updatePlayerRating = function(playerId, rating) {
                    console.log(`📊 Updating rating for player ${playerId}: ${rating}`);
                    
                    if (!this.currentEvaluation) {
                        console.warn('⚠️ No current evaluation');
                        return;
                    }
                    
                    if (!this.currentEvaluation.playerRatings) {
                        this.currentEvaluation.playerRatings = {};
                    }
                    
                    this.currentEvaluation.playerRatings[playerId] = parseInt(rating);
                    
                    // Update performance data format
                    this.updatePlayerPerformanceData(playerId);
                };
                
                TestApp.updatePlayerGoals = function(playerId, goals) {
                    console.log(`⚽ Updating goals for player ${playerId}: ${goals}`);
                    
                    if (!this.currentEvaluation) {
                        console.warn('⚠️ No current evaluation');
                        return;
                    }
                    
                    if (!this.currentEvaluation.playerGoals) {
                        this.currentEvaluation.playerGoals = {};
                    }
                    
                    this.currentEvaluation.playerGoals[playerId] = parseInt(goals) || 0;
                    
                    // Update performance data format
                    this.updatePlayerPerformanceData(playerId);
                };
                
                TestApp.updatePlayerNotes = function(playerId, notes) {
                    console.log(`📝 Updating notes for player ${playerId}`);
                    
                    if (!this.currentEvaluation) {
                        console.warn('⚠️ No current evaluation');
                        return;
                    }
                    
                    if (!this.currentEvaluation.playerNotes) {
                        this.currentEvaluation.playerNotes = {};
                    }
                    
                    this.currentEvaluation.playerNotes[playerId] = notes;
                    
                    // Also update playerPerformances format
                    this.updatePlayerPerformanceData(playerId);
                };
                
                // Function to convert EA SPORTS data to format expected by submitEvaluation
                TestApp.updatePlayerPerformanceData = function(playerId) {
                    if (!this.currentEvaluation.playerPerformances) {
                        this.currentEvaluation.playerPerformances = {};
                    }
                    
                    if (!this.currentEvaluation.playerPerformances[playerId]) {
                        this.currentEvaluation.playerPerformances[playerId] = {
                            tags: [],
                            rating: 5,
                            goals: 0,
                            notes: ''
                        };
                    }
                    
                    const performance = this.currentEvaluation.playerPerformances[playerId];
                    
                    // Update from EA SPORTS data structures
                    if (this.currentEvaluation.playerTags && this.currentEvaluation.playerTags[playerId]) {
                        performance.tags = this.currentEvaluation.playerTags[playerId];
                        console.log(`🏷️ Player ${playerId} tags:`, performance.tags);
                    }
                    
                    if (this.currentEvaluation.playerRatings && this.currentEvaluation.playerRatings[playerId]) {
                        performance.rating = this.currentEvaluation.playerRatings[playerId];
                        console.log(`📊 Player ${playerId} rating:`, performance.rating);
                    }
                    
                    if (this.currentEvaluation.playerGoals && this.currentEvaluation.playerGoals[playerId]) {
                        performance.goals = this.currentEvaluation.playerGoals[playerId];
                        console.log(`⚽ Player ${playerId} goals:`, performance.goals);
                    }
                    
                    if (this.currentEvaluation.playerNotes && this.currentEvaluation.playerNotes[playerId]) {
                        performance.notes = this.currentEvaluation.playerNotes[playerId];
                    }
                    
                    console.log(`🎮 Updated performance data for player ${playerId}:`, performance);
                };
                
                // Override applyPlayerImprovements to add debugging
                const originalApplyPlayerImprovements = TestApp.applyPlayerImprovements;
                TestApp.applyPlayerImprovements = async function() {
                    console.log('💪 EA SPORTS: Applying player improvements...');
                    console.log('🎯 Current evaluation:', this.currentEvaluation);
                    console.log('👥 Available players:', this.players.length);
                    console.log('📊 Performance data:', this.currentEvaluation.playerPerformances);
                    
                    // Debug current players' evaluation status BEFORE applying improvements
                    console.log('🔍 BEFORE improvements - Player evaluation status:');
                    this.players.forEach(player => {
                        console.log(`   ${player.name}: OVR=${player.ovr}, originalOVR=${player.originalOVR}, hasBeenEvaluated=${player.hasBeenEvaluated}`);
                    });
                    
                    // Call original function and track what happens
                    console.log('🔄 Calling original applyPlayerImprovements...');
                    const result = await originalApplyPlayerImprovements.call(this);
                    
                    // Debug AFTER applying improvements
                    console.log('🔍 AFTER improvements - Player evaluation status:');
                    this.players.forEach(player => {
                        if (player.hasBeenEvaluated) {
                            console.log(`   ✅ ${player.name}: OVR=${player.ovr}, originalOVR=${player.originalOVR}, hasBeenEvaluated=${player.hasBeenEvaluated}`);
                        } else {
                            console.log(`   ❌ ${player.name}: OVR=${player.ovr}, originalOVR=${player.originalOVR}, hasBeenEvaluated=${player.hasBeenEvaluated}`);
                        }
                    });
                    
                    return result;
                };
                
                // Override Storage.updatePlayer to debug what gets saved
                if (typeof Storage !== 'undefined' && Storage.updatePlayer) {
                    const originalUpdatePlayer = Storage.updatePlayer;
                    Storage.updatePlayer = async function(playerData) {
                        console.log('💾 STORAGE DEBUG: Saving player to Firebase:', playerData.name);
                        console.log(`   OVR: ${playerData.ovr}`);
                        console.log(`   Original OVR: ${playerData.originalOVR}`);
                        console.log(`   Has Been Evaluated: ${playerData.hasBeenEvaluated}`);
                        console.log(`   Full player data:`, playerData);
                        
                        const result = await originalUpdatePlayer.call(this, playerData);
                        
                        console.log('💾 STORAGE DEBUG: Player saved successfully');
                        return result;
                    };
                }
                
                // Override TestApp.loadPlayers to debug what gets loaded
                if (typeof TestApp !== 'undefined' && TestApp.loadPlayers) {
                    const originalLoadPlayers = TestApp.loadPlayers;
                    TestApp.loadPlayers = async function() {
                        console.log('📥 LOADING DEBUG: Loading players from Firebase...');
                        
                        const result = await originalLoadPlayers.call(this);
                        
                        console.log('📥 LOADING DEBUG: Players loaded, checking evaluation status:');
                        if (this.players) {
                            this.players.forEach(player => {
                                if (player.hasBeenEvaluated || player.originalOVR) {
                                    console.log(`   ✅ ${player.name}: OVR=${player.ovr}, originalOVR=${player.originalOVR}, hasBeenEvaluated=${player.hasBeenEvaluated}`);
                                } else {
                                    console.log(`   ❌ ${player.name}: OVR=${player.ovr}, originalOVR=${player.originalOVR}, hasBeenEvaluated=${player.hasBeenEvaluated}`);
                                }
                            });
                        }
                        
                        return result;
                    };
                }
                
                // Function to fix player ID mismatches before evaluation
                TestApp.fixPlayerIdMismatches = async function() {
                    console.log('🔧 Fixing player ID mismatches...');
                    
                    if (!this.currentEvaluation || !this.currentEvaluation.match) {
                        return;
                    }
                    
                    const match = this.currentEvaluation.match;
                    const allMatchPlayers = [...match.teamA.players, ...match.teamB.players];
                    
                    for (const matchPlayer of allMatchPlayers) {
                        // Try to find this player in the main players list
                        let registeredPlayer = this.players.find(p => p.id === matchPlayer.id);
                        
                        // If not found by ID, try to find by name
                        if (!registeredPlayer && matchPlayer.name) {
                            registeredPlayer = this.players.find(p => p.name === matchPlayer.name);
                            
                            if (registeredPlayer) {
                                console.log(`🔄 Found ID mismatch for ${matchPlayer.name}:`);
                                console.log(`   Match ID: ${matchPlayer.id} → Registered ID: ${registeredPlayer.id}`);
                                
                                // Update the player ID in the match data
                                matchPlayer.id = registeredPlayer.id;
                                
                                // Also update any performance data that might exist
                                if (this.currentEvaluation.playerPerformances && this.currentEvaluation.playerPerformances[matchPlayer.id]) {
                                    const oldPerformance = this.currentEvaluation.playerPerformances[matchPlayer.id];
                                    this.currentEvaluation.playerPerformances[registeredPlayer.id] = oldPerformance;
                                    delete this.currentEvaluation.playerPerformances[matchPlayer.id];
                                }
                                
                                // Update other evaluation data structures
                                if (this.currentEvaluation.playerTags && this.currentEvaluation.playerTags[matchPlayer.id]) {
                                    this.currentEvaluation.playerTags[registeredPlayer.id] = this.currentEvaluation.playerTags[matchPlayer.id];
                                    delete this.currentEvaluation.playerTags[matchPlayer.id];
                                }
                                
                                if (this.currentEvaluation.playerRatings && this.currentEvaluation.playerRatings[matchPlayer.id]) {
                                    this.currentEvaluation.playerRatings[registeredPlayer.id] = this.currentEvaluation.playerRatings[matchPlayer.id];
                                    delete this.currentEvaluation.playerRatings[matchPlayer.id];
                                }
                                
                                if (this.currentEvaluation.playerGoals && this.currentEvaluation.playerGoals[matchPlayer.id]) {
                                    this.currentEvaluation.playerGoals[registeredPlayer.id] = this.currentEvaluation.playerGoals[matchPlayer.id];
                                    delete this.currentEvaluation.playerGoals[matchPlayer.id];
                                }
                                
                                if (this.currentEvaluation.playerNotes && this.currentEvaluation.playerNotes[matchPlayer.id]) {
                                    this.currentEvaluation.playerNotes[registeredPlayer.id] = this.currentEvaluation.playerNotes[matchPlayer.id];
                                    delete this.currentEvaluation.playerNotes[matchPlayer.id];
                                }
                                
                                console.log(`✅ Fixed ID for ${matchPlayer.name}: now using ${registeredPlayer.id}`);
                            }
                        }
                        
                        // If still not found, this might be a truly unregistered player
                        if (!registeredPlayer) {
                            console.warn(`⚠️ Player ${matchPlayer.name} (ID: ${matchPlayer.id}) not found in registered players`);
                            console.log('   This player might need to be added to the database');
                        }
                    }
                    
                    console.log('🔧 Player ID mismatch fixing complete');
                };

                // Store reference to the enhanced function for future use
                const enhancedApplyPlayerImprovements = TestApp.applyPlayerImprovements;
                
                // Override again to add the ID matching logic that was originally after
                TestApp.applyPlayerImprovements = async function() {
                    console.log('💪 EA SPORTS: Enhanced Apply Player Improvements Starting...');
                    
                    // FIRST: Fix any player ID mismatches
                    await this.fixPlayerIdMismatches();
                    
                    // Debug player ID matching
                    console.log('🔍 Player ID Analysis:');
                    if (this.currentEvaluation.playerPerformances) {
                        Object.keys(this.currentEvaluation.playerPerformances).forEach(evalPlayerId => {
                            const foundPlayer = this.players.find(p => p.id === evalPlayerId);
                            console.log(`📋 Eval Player ID: ${evalPlayerId}`);
                            console.log(`   Found in players list: ${foundPlayer ? 'YES' : 'NO'}`);
                            if (foundPlayer) {
                                console.log(`   Player name: ${foundPlayer.name}, Current OVR: ${foundPlayer.ovr}`);
                            } else {
                                console.log('   ⚠️ PLAYER NOT FOUND - checking similar IDs...');
                                this.players.forEach(p => {
                                    if (p.name && this.currentEvaluation.match) {
                                        const matchPlayers = [...this.currentEvaluation.match.teamA.players, ...this.currentEvaluation.match.teamB.players];
                                        const matchPlayer = matchPlayers.find(mp => mp.id === evalPlayerId);
                                        if (matchPlayer && matchPlayer.name === p.name) {
                                            console.log(`   🔄 Found name match: ${p.name} (List ID: ${p.id})`);
                                        }
                                    }
                                });
                            }
                        });
                    }
                    
                    // Fix player ID mismatches before applying improvements
                    this.fixPlayerIdMatching();
                    
                    return await enhancedApplyPlayerImprovements.call(this);
                };
                
                // Function to fix player ID matching issues
                TestApp.fixPlayerIdMatching = function() {
                    if (!this.currentEvaluation || !this.currentEvaluation.playerPerformances || !this.currentEvaluation.match) {
                        return;
                    }
                    
                    console.log('🔧 Fixing player ID matching...');
                    const matchPlayers = [...this.currentEvaluation.match.teamA.players, ...this.currentEvaluation.match.teamB.players];
                    
                    Object.keys(this.currentEvaluation.playerPerformances).forEach(evalPlayerId => {
                        const foundPlayer = this.players.find(p => p.id === evalPlayerId);
                        
                        if (!foundPlayer) {
                            // Try to find by name
                            const matchPlayer = matchPlayers.find(mp => mp.id === evalPlayerId);
                            if (matchPlayer && matchPlayer.name) {
                                const playerByName = this.players.find(p => p.name === matchPlayer.name);
                                if (playerByName) {
                                    console.log(`🔄 Fixing ID mismatch: ${matchPlayer.name}`);
                                    console.log(`   Match ID: ${evalPlayerId} -> List ID: ${playerByName.id}`);
                                    
                                    // Copy performance data to correct ID
                                    this.currentEvaluation.playerPerformances[playerByName.id] = this.currentEvaluation.playerPerformances[evalPlayerId];
                                    
                                    // Update match player ID to match list
                                    matchPlayer.id = playerByName.id;
                                    
                                    // Remove old entry
                                    delete this.currentEvaluation.playerPerformances[evalPlayerId];
                                    
                                    console.log(`✅ Fixed ID matching for ${matchPlayer.name}`);
                                }
                            }
                        }
                    });
                };
                
                // Get correct player data for card creation
                TestApp.getCorrectPlayerForCard = function(player) {
                    // First try to find by ID
                    let correctPlayer = this.players.find(p => p.id === player.id);
                    
                    // If not found, try to find by name (for registered players)
                    if (!correctPlayer && player.name) {
                        correctPlayer = this.players.find(p => p.name === player.name);
                        if (correctPlayer) {
                            console.log(`🔄 Using correct ID for ${player.name}: ${correctPlayer.id} instead of ${player.id}`);
                            // Create hybrid player object with correct ID
                            return {
                                ...player,
                                id: correctPlayer.id,
                                ovr: correctPlayer.ovr,
                                attributes: correctPlayer.attributes,
                                originalOVR: correctPlayer.originalOVR,
                                hasBeenEvaluated: correctPlayer.hasBeenEvaluated
                            };
                        }
                    }
                    
                    return correctPlayer || player;
                };
                
                // Override submitEvaluation to consolidate data first
                const originalSubmitEvaluation = TestApp.submitEvaluation;
                TestApp.submitEvaluation = async function() {
                    console.log('🚀 EA SPORTS: Starting evaluation submission...');
                    
                    // Consolidate all player performance data
                    this.consolidatePlayerPerformanceData();
                    
                    // Call original submitEvaluation
                    const result = await originalSubmitEvaluation.call(this);
                    
                    // Refresh player displays after successful evaluation
                    if (result !== false) {
                        console.log('✅ EA SPORTS: Evaluation successful, refreshing player display...');
                        
                        // Force immediate refresh
                        setTimeout(() => {
                            if (typeof this.displayPlayers === 'function') {
                                this.displayPlayers();
                                console.log('🔄 Player display refreshed with updated OVR values');
                            }
                            
                            // Force storage save if available
                            if (typeof Storage !== 'undefined' && Storage.saveAllPlayers) {
                                Storage.saveAllPlayers(this.players);
                                console.log('💾 Players saved to storage with updated OVR');
                            }
                        }, 100);
                        
                        // Additional refresh after a longer delay to ensure data persistence
                        setTimeout(() => {
                            if (typeof this.displayPlayers === 'function') {
                                this.displayPlayers();
                                console.log('🔄 Second player display refresh completed');
                            }
                        }, 1000);
                    }
                    
                    return result;
                };
                
                // Function to render OVR improvement indicators
                TestApp.renderOVRImprovement = function(player) {
                    console.log(`🎯 Checking improvement for ${player.name}:`);
                    console.log(`   Current OVR: ${player.ovr}`);
                    console.log(`   Original OVR: ${player.originalOVR}`);
                    console.log(`   hasBeenEvaluated: ${player.hasBeenEvaluated}`);
                    
                    // Try to get the most up-to-date player data
                    const registeredPlayer = this.players ? this.players.find(p => p.id === player.id || p.name === player.name) : null;
                    
                    if (registeredPlayer) {
                        console.log(`   🔄 Using registered player data: OVR=${registeredPlayer.ovr}, originalOVR=${registeredPlayer.originalOVR}, evaluated=${registeredPlayer.hasBeenEvaluated}`);
                        // Use the registered player data if it's more complete
                        if (registeredPlayer.originalOVR !== undefined && player.originalOVR === undefined) {
                            player = registeredPlayer;
                            console.log(`   ✅ Switched to registered player data`);
                        }
                    }
                    
                    // Check if we have valid originalOVR data
                    if (player.originalOVR === undefined || player.originalOVR === null) {
                        console.log(`   ❌ No improvement indicator (missing originalOVR)`);
                        return '';
                    }
                    
                    const improvement = player.ovr - player.originalOVR;
                    console.log(`   📈 Improvement: ${improvement}`);
                    
                    if (improvement <= 0) {
                        console.log(`   ❌ No improvement to show (${improvement})`);
                        return '';
                    }
                    
                    // Show indicator if player has been evaluated OR if there's clear improvement
                    if (!player.hasBeenEvaluated && improvement <= 0) {
                        console.log(`   ❌ Player not evaluated and no improvement`);
                        return '';
                    }
                    
                    // If we have improvement but player shows as not evaluated, still show the indicator
                    if (!player.hasBeenEvaluated && improvement > 0) {
                        console.log(`   ⚠️ Player shows not evaluated but has improvement - showing indicator anyway`);
                    }
                    
                    const color = improvement >= 3 ? '#00ff9d' : improvement >= 2 ? '#ffdd00' : '#66ff66';
                    console.log(`   ✅ Showing +${improvement} indicator with color ${color}`);
                    
                    return `<span style="
                        position: absolute;
                        top: -8px;
                        right: -8px;
                        background: ${color};
                        color: #000;
                        font-size: 10px;
                        font-weight: 800;
                        padding: 2px 4px;
                        border-radius: 8px;
                        line-height: 1;
                        box-shadow: 0 0 4px rgba(0, 255, 157, 0.4);
                    ">+${improvement}</span>`;
                };
                
                console.log('✅ Successfully overrode evaluation system with EA SPORTS styling');
                return true;
            }
            return false;
        }

        // Override TestApp displayTeamBalance function for translation and EA SPORTS styling  
        function overrideDisplayTeamBalance() {
            if (typeof TestApp !== 'undefined' && TestApp.displayTeamBalance) {
                TestApp.displayTeamBalance = function(difference, format = '5v5') {
                    const teamsDisplay = document.getElementById('teams-display');
                    
                    let balanceHtml = '';
                    let balanceColor = '';
                    let balanceText = '';
                    
                    if (difference <= 2) {
                        balanceColor = 'linear-gradient(90deg, #27ae60, #2ecc71)';
                        balanceText = '⚖️ EQUIPOS PERFECTAMENTE BALANCEADOS';
                    } else if (difference <= 5) {
                        balanceColor = 'linear-gradient(90deg, #f39c12, #e67e22)';
                        balanceText = '⚖️ EQUIPOS BIEN BALANCEADOS';
                    } else {
                        balanceColor = 'linear-gradient(90deg, #e74c3c, #c0392b)';
                        balanceText = '⚠️ EQUIPOS DESBALANCEADOS';
                    }
                    
                    // Get match date and time for display
                    const matchDate = document.getElementById('match-date').value;
                    const matchTime = document.getElementById('match-time').value;
                    
                    const dateFormatted = matchDate ? new Date(matchDate).toLocaleDateString('es-ES') : 'No definida';
                    const timeFormatted = matchTime || 'No definida';
                    
                    balanceHtml = `
                        <div style="
                            margin: 25px 0; 
                            padding: 20px; 
                            background: ${balanceColor}; 
                            color: white; 
                            border-radius: 12px; 
                            text-align: center;
                            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                            backdrop-filter: blur(10px);
                        ">
                            <h4 style="
                                margin: 0 0 12px 0; 
                                font-size: 1.2em;
                                text-transform: uppercase;
                                letter-spacing: 1px;
                                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                            ">${balanceText}</h4>
                            <p style="
                                margin: 0 0 8px 0;
                                font-size: 14px;
                                opacity: 0.95;
                                font-weight: 500;
                            ">Formato: ${format} | Diferencia OVR: ${difference} puntos</p>
                            <p style="
                                margin: 0; 
                                font-size: 13px; 
                                opacity: 0.9;
                                background: rgba(0, 0, 0, 0.2);
                                padding: 8px 12px;
                                border-radius: 6px;
                                display: inline-block;
                            ">📅 ${dateFormatted} a las ${timeFormatted}</p>
                        </div>
                    `;
                    
                    // Insert after teams display
                    if (teamsDisplay.nextElementSibling && teamsDisplay.nextElementSibling.id === 'balance-info') {
                        teamsDisplay.nextElementSibling.innerHTML = balanceHtml;
                    } else {
                        const balanceDiv = document.createElement('div');
                        balanceDiv.id = 'balance-info';
                        balanceDiv.innerHTML = balanceHtml;
                        teamsDisplay.parentNode.insertBefore(balanceDiv, teamsDisplay.nextSibling);
                    }
                };
                
                console.log('✅ Successfully overrode TestApp.displayTeamBalance with EA SPORTS styling');
                return true;
            }
            return false;
        }

        // Override TestApp displayTeam function for EA SPORTS styling
        function overrideDisplayTeam() {
            if (typeof TestApp !== 'undefined' && TestApp.displayTeam) {
                const originalDisplayTeam = TestApp.displayTeam;
                
                TestApp.displayTeam = function(containerId, players, teamName) {
                    console.log('🎨 Using EA SPORTS displayTeam override');
                    
                    const container = document.querySelector(`#${containerId} .team-players`);
                    
                    let html = '';
                    let totalOVR = 0;
                    
                    players.forEach(player => {
                        totalOVR += player.ovr || 70;
                        const ovrClass = getOVRClass(player.ovr || 70);
                        
                        // Handle photo display
                        let photoHtml;
                        if (player.photo && (player.photo.startsWith('data:') || player.photo.startsWith('http'))) {
                            photoHtml = `<img src="${player.photo}" alt="${player.name}">`;
                        } else if (player.photo && player.photo.length <= 4) {
                            photoHtml = player.photo;
                        } else {
                            photoHtml = '⚽';
                        }
                        
                        html += `
                            <div style="
                                background: var(--card-bg); 
                                backdrop-filter: blur(10px); 
                                border: 1px solid rgba(0, 255, 157, 0.1); 
                                border-radius: 8px; 
                                padding: 12px; 
                                margin-bottom: 8px;
                                display: flex; 
                                align-items: center; 
                                gap: 12px;
                                transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                            " onmouseover="this.style.borderColor='rgba(0, 255, 157, 0.3)'" 
                               onmouseout="this.style.borderColor='rgba(0, 255, 157, 0.1)'">
                                <div class="player-photo" style="
                                    width: 35px; 
                                    height: 35px; 
                                    border-radius: 50%; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center; 
                                    background: rgba(40, 40, 40, 0.8); 
                                    font-size: 18px;
                                    border: 2px solid rgba(0, 255, 157, 0.2);
                                ">
                                    ${photoHtml}
                                </div>
                                <div style="flex: 1;">
                                    <div style="
                                        color: var(--text-light); 
                                        font-weight: 600; 
                                        font-size: 13px;
                                        margin-bottom: 2px;
                                    ">${player.name.toUpperCase()}</div>
                                    <div style="
                                        font-size: 11px; 
                                        color: rgba(255, 255, 255, 0.6);
                                    ">
                                        <span class="position-${player.position || 'MED'}">${player.position || 'MED'}</span>
                                    </div>
                                </div>
                                <div class="player-rating ${ovrClass}" style="
                                    font-size: 16px; 
                                    font-weight: 700;
                                    min-width: 35px;
                                    text-align: center;
                                    position: relative;
                                ">
                                    ${player.ovr || 70}${(player.ovr || 70) >= 88 ? '<span class="ovr-badge">⭐</span>' : ''}
                                    ${(() => {
                                        console.log(`🔍 Attempting to render improvement for ${player.name}`);
                                        return TestApp?.renderOVRImprovement ? TestApp.renderOVRImprovement(player) : '';
                                    })()}
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    
                    // Update team header with new names
                    const avgOvr = Math.round(totalOVR / players.length);
                    const header = document.querySelector(`#${containerId} h3`);
                    if (containerId === 'team-a') {
                        header.innerHTML = `👕 CON CHALECO <small style="font-size: 0.7em; opacity: 0.8;">(AVG: ${avgOvr})</small>`;
                    } else if (containerId === 'team-b') {
                        header.innerHTML = `🏃 SIN CHALECO <small style="font-size: 0.7em; opacity: 0.8;">(AVG: ${avgOvr})</small>`;
                    }
                };
                
                console.log('✅ Successfully overrode TestApp.displayTeam with EA SPORTS styling');
                return true;
            }
            return false;
        }
        
        // Try to override immediately, and set up polling if needed  
        if (!overrideTestAppRender() || !overrideDisplayTeam() || !overrideDisplayTeamBalance() || !overrideEvaluationSystem()) {
            console.log('⏳ TestApp not ready, setting up polling...');
            const checkInterval = setInterval(() => {
                if (overrideTestAppRender() && overrideDisplayTeam() && overrideDisplayTeamBalance() && overrideEvaluationSystem()) {
                    clearInterval(checkInterval);
                }
            }, 100);
            
            // Stop polling after 10 seconds
            setTimeout(() => {
                clearInterval(checkInterval);
                console.log('⚠️ Stopped polling for TestApp');
            }, 10000);
        }
    </script>
    
    <script>
        // TestApp initialization is now handled by AuthSystem
        // AuthSystem will call TestApp.init() after authentication
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 App starting - AuthSystem will handle initialization...');
            
            // Also try to override TestApp after DOM loads
            setTimeout(() => {
                const renderOverride = overrideTestAppRender();
                const teamOverride = overrideDisplayTeam();
                const balanceOverride = overrideDisplayTeamBalance();
                const evaluationOverride = overrideEvaluationSystem();
                if (renderOverride && teamOverride && balanceOverride && evaluationOverride) {
                    console.log('✅ Successfully overrode all TestApp display functions on DOM ready');
                    // Force refresh if players are already loaded
                    if (typeof TestApp !== 'undefined' && TestApp.players && TestApp.players.length > 0) {
                        console.log('🔄 Forcing re-render of existing players');
                        TestApp.displayPlayers();
                    }
                } else {
                    console.log('⚠️ Could not override all functions yet');
                }
            }, 1000);
            
            // Additional attempts
            setTimeout(() => { overrideTestAppRender(); overrideDisplayTeam(); overrideDisplayTeamBalance(); overrideEvaluationSystem(); }, 2000);
            setTimeout(() => { overrideTestAppRender(); overrideDisplayTeam(); overrideDisplayTeamBalance(); overrideEvaluationSystem(); }, 3000);
        });
    </script>

    <!-- Modal Container -->
    <div id="ea-modal-overlay" class="ea-modal-overlay">
        <div class="ea-modal">
            <div class="ea-modal-header">
                <h2 id="ea-modal-title" class="ea-modal-title"></h2>
                <button id="ea-modal-close" class="ea-modal-close">✕</button>
            </div>
            <div class="ea-modal-body">
                <i id="ea-modal-icon" class="ea-modal-icon bx"></i>
                <div id="ea-modal-message" class="ea-modal-message"></div>
                <input id="ea-modal-input" class="ea-modal-input" style="display: none;" />
            </div>
            <div id="ea-modal-actions" class="ea-modal-actions">
                <!-- Buttons will be inserted here dynamically -->
            </div>
        </div>
    </div>

    <!-- EA SPORTS Modal System -->
    <script>
        window.EAModal = {
            overlay: null,
            modal: null,
            currentResolve: null,
            currentReject: null,

            init() {
                this.overlay = document.getElementById('ea-modal-overlay');
                this.modal = this.overlay?.querySelector('.ea-modal');
                
                // Close modal when clicking overlay
                this.overlay?.addEventListener('click', (e) => {
                    if (e.target === this.overlay) {
                        this.close(false);
                    }
                });

                // Close button
                document.getElementById('ea-modal-close')?.addEventListener('click', () => {
                    this.close(false);
                });

                // ESC key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.overlay?.classList.contains('show')) {
                        this.close(false);
                    }
                });
            },

            show(options = {}) {
                return new Promise((resolve, reject) => {
                    this.currentResolve = resolve;
                    this.currentReject = reject;

                    const {
                        title = '⚡ EA SPORTS',
                        message = '',
                        type = 'info', // info, success, warning, danger
                        buttons = [{ text: 'OK', primary: true }],
                        input = false,
                        inputValue = '',
                        inputPlaceholder = 'Escribe aquí...'
                    } = options;

                    // Set title
                    document.getElementById('ea-modal-title').textContent = title;

                    // Set message
                    document.getElementById('ea-modal-message').innerHTML = message;

                    // Set icon based on type
                    const iconEl = document.getElementById('ea-modal-icon');
                    iconEl.className = `ea-modal-icon ${type} bx`;
                    switch (type) {
                        case 'success':
                            iconEl.classList.add('bx-check-circle');
                            break;
                        case 'warning':
                            iconEl.classList.add('bx-error-circle');
                            break;
                        case 'danger':
                            iconEl.classList.add('bx-x-circle');
                            break;
                        default:
                            iconEl.classList.add('bx-info-circle');
                    }

                    // Handle input
                    const inputEl = document.getElementById('ea-modal-input');
                    if (input) {
                        inputEl.style.display = 'block';
                        inputEl.value = inputValue;
                        inputEl.placeholder = inputPlaceholder;
                        setTimeout(() => inputEl.focus(), 300);
                    } else {
                        inputEl.style.display = 'none';
                    }

                    // Create buttons
                    const actionsEl = document.getElementById('ea-modal-actions');
                    actionsEl.innerHTML = '';
                    
                    buttons.forEach((btn, index) => {
                        const button = document.createElement('button');
                        button.className = 'ea-modal-btn';
                        button.textContent = btn.text;
                        
                        if (btn.primary) {
                            button.classList.add('ea-modal-btn-primary');
                        } else if (btn.danger) {
                            button.classList.add('ea-modal-btn-danger');
                        } else {
                            button.classList.add('ea-modal-btn-secondary');
                        }

                        button.addEventListener('click', () => {
                            const result = input ? inputEl.value : btn.value !== undefined ? btn.value : index;
                            this.close(result);
                        });

                        actionsEl.appendChild(button);
                    });

                    // Show modal
                    this.overlay.classList.add('show');
                });
            },

            close(result) {
                this.overlay?.classList.remove('show');
                if (this.currentResolve) {
                    this.currentResolve(result);
                    this.currentResolve = null;
                    this.currentReject = null;
                }
            },

            // EA SPORTS Alert
            alert(message, title = '⚡ Notificación', type = 'info') {
                return this.show({
                    title,
                    message,
                    type,
                    buttons: [{ text: 'Entendido', primary: true }]
                });
            },

            // EA SPORTS Confirm
            confirm(message, title = '⚠️ Confirmación') {
                return this.show({
                    title,
                    message,
                    type: 'warning',
                    buttons: [
                        { text: 'Cancelar', value: false },
                        { text: 'Confirmar', primary: true, value: true }
                    ]
                });
            },

            // EA SPORTS Prompt
            prompt(message, defaultValue = '', title = '✏️ Ingresa Datos') {
                return this.show({
                    title,
                    message,
                    type: 'info',
                    input: true,
                    inputValue: defaultValue,
                    buttons: [
                        { text: 'Cancelar', value: null },
                        { text: 'Confirmar', primary: true, value: 'input' }
                    ]
                }).then(result => {
                    if (result === 'input') {
                        return document.getElementById('ea-modal-input').value;
                    }
                    return result;
                });
            }
        };

        // Override native dialogs
        // Métodos nativos reemplazados por UnifiedNotificationSystem
        // window.alert, window.confirm, window.prompt serán manejados automáticamente
        // Los métodos confirm y prompt serán manejados por UnifiedNotificationSystem
        // window.confirm = (message) => unifiedNotifications.confirm(message);
        // window.prompt = (message, defaultValue) => unifiedNotifications.prompt(message, defaultValue);

        // Initialize when DOM is loaded
        
        // Limpieza automática removida - notificaciones viejas eliminadas
        // EAModal ya no es necesario - UnifiedNotificationSystem maneja todo
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Gaming Header and Dashboard synchronization
            initializeGamingUI();
            
            // Initialize CLEAN HEADER (nuevo sistema limpio)
            setTimeout(async () => {
                console.log('🚀 Initializing Clean Header...');
                try {
                    // Create and initialize the clean header
                    if (typeof CleanHeader !== 'undefined') {
                        const cleanHeader = new CleanHeader();
                        await cleanHeader.init();
                        // Make it globally accessible
                        window.cleanHeader = cleanHeader;
                        console.log('✅ Clean Header initialized successfully');
                    } else {
                        console.error('❌ CleanHeader class not found');
                    }
                } catch (error) {
                    console.error('❌ Error initializing clean header:', error);
                }
                
                // Initialize Enhanced Footer (header is handled by NewHeaderManager now)
                if (window.headerFooter) {
                    console.log('🎨 Initializing enhanced footer...');
                    await window.headerFooter.initialize();
                }
            }, 1000); // Wait for user authentication to complete
        });
        
        // Gaming UI Synchronization
        function initializeGamingUI() {
            // Sync user data between old and new headers
            function syncUserData() {
                const oldCurrentUser = document.getElementById('current-user');
                const newCurrentUser = document.getElementById('current-user-new');
                const userAvatar = document.getElementById('user-avatar-letter');
                
                if (oldCurrentUser && newCurrentUser) {
                    const userName = oldCurrentUser.textContent || 'Sin usuario';
                    newCurrentUser.textContent = userName;
                    
                    // Update avatar letter
                    if (userAvatar && userName !== 'Sin usuario') {
                        userAvatar.textContent = userName.charAt(0).toUpperCase();
                    }
                }
                
                // Sync pending evaluations
                const oldPendingCount = document.getElementById('pending-count');
                const newPendingCount = document.getElementById('pending-count-new');
                const pendingCard = document.getElementById('pending-evaluations-enhanced');
                
                if (oldPendingCount && newPendingCount) {
                    const count = oldPendingCount.textContent || '0';
                    newPendingCount.textContent = count;
                    
                    // Show/hide new pending evaluations card
                    if (pendingCard) {
                        if (parseInt(count) > 0) {
                            pendingCard.style.display = 'block';
                        } else {
                            pendingCard.style.display = 'none';
                        }
                    }
                }
            }
            
            // Observe changes to legacy elements and sync with new ones
            const oldCurrentUser = document.getElementById('current-user');
            const oldPendingCount = document.getElementById('pending-count');
            
            if (oldCurrentUser) {
                const userObserver = new MutationObserver(syncUserData);
                userObserver.observe(oldCurrentUser, { 
                    childList: true, 
                    subtree: true, 
                    characterData: true 
                });
            }
            
            if (oldPendingCount) {
                const countObserver = new MutationObserver(syncUserData);
                countObserver.observe(oldPendingCount, { 
                    childList: true, 
                    subtree: true, 
                    characterData: true 
                });
            }
            
            // Initial sync
            syncUserData();
            
            // Periodic sync every 2 seconds to catch any missed updates
            setInterval(syncUserData, 2000);
        }
    </script>
</body>
</html>