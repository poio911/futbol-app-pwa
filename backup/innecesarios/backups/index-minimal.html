<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F√∫tbol Mi√©rcoles - BETA Test</title>
    
    <!-- Firebase Scripts - REQUIRED -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    
    <!-- Minimal Styles -->
    <link href="css/minimal.css" rel="stylesheet">
</head>
<body>
    <div id="app">
        <!-- Authentication Screen -->
        <div id="auth-screen" class="auth-overlay" style="
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; 
            align-items: center; 
            justify-content: center;
            z-index: 1000;
        ">
            <div class="auth-container" style="
                background: white; 
                padding: 40px; 
                border-radius: 20px; 
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 400px;
                width: 90%;
                text-align: center;
            ">
                <div class="auth-header" style="margin-bottom: 30px;">
                    <h1 style="color: #333; margin: 0 0 10px 0; font-size: 28px;">‚öΩ F√∫tbol Stats</h1>
                    <p style="color: #666; margin: 0; font-size: 16px;">BETA test F√∫tbol Mi√©rcoles</p>
                </div>

                <!-- Login Form -->
                <div id="login-form" class="auth-form">
                    <h2 style="color: #333; margin: 0 0 25px 0; font-size: 22px;">Iniciar Sesi√≥n</h2>
                    
                    <div class="form-group" style="margin-bottom: 20px; text-align: left;">
                        <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 500;">Email:</label>
                        <input type="email" id="login-email" placeholder="tu@email.com" style="
                            width: 100%; 
                            padding: 12px 15px; 
                            border: 2px solid #e1e1e1; 
                            border-radius: 10px; 
                            font-size: 16px;
                            box-sizing: border-box;
                        " required>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 25px; text-align: left;">
                        <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 500;">Contrase√±a:</label>
                        <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="
                            width: 100%; 
                            padding: 12px 15px; 
                            border: 2px solid #e1e1e1; 
                            border-radius: 10px; 
                            font-size: 16px;
                            box-sizing: border-box;
                        " required>
                    </div>
                    
                    <button onclick="AuthSystem.login()" style="
                        width: 100%; 
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                        color: white; 
                        padding: 12px 20px; 
                        border: none; 
                        border-radius: 10px; 
                        font-size: 16px; 
                        font-weight: 600; 
                        cursor: pointer; 
                        margin-bottom: 15px;
                    " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                        üîë Iniciar Sesi√≥n
                    </button>
                    
                    <p style="margin: 0; color: #666;">
                        ¬øNo tienes cuenta? 
                        <a href="#" onclick="AuthSystem.showRegister()" style="color: #667eea; text-decoration: none; font-weight: 600;">
                            Reg√≠strate aqu√≠
                        </a>
                    </p>
                </div>

                <!-- Register Form -->
                <div id="register-form" class="auth-form" style="display: none;">
                    <h2 style="color: #333; margin: 0 0 25px 0; font-size: 22px;">Crear Cuenta</h2>
                    
                    <div class="form-group" style="margin-bottom: 20px; text-align: left;">
                        <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 500;">Nombre Completo:</label>
                        <input type="text" id="register-name" placeholder="Juan P√©rez" style="
                            width: 100%; 
                            padding: 12px 15px; 
                            border: 2px solid #e1e1e1; 
                            border-radius: 10px; 
                            font-size: 16px;
                            box-sizing: border-box;
                        " required>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px; text-align: left;">
                        <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 500;">Email:</label>
                        <input type="email" id="register-email" placeholder="tu@email.com" style="
                            width: 100%; 
                            padding: 12px 15px; 
                            border: 2px solid #e1e1e1; 
                            border-radius: 10px; 
                            font-size: 16px;
                            box-sizing: border-box;
                        " required>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px; text-align: left;">
                        <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 500;">Posici√≥n Preferida:</label>
                        <select id="register-position" style="
                            width: 100%; 
                            padding: 12px 15px; 
                            border: 2px solid #e1e1e1; 
                            border-radius: 10px; 
                            font-size: 16px;
                            box-sizing: border-box;
                        " required>
                            <option value="">Seleccionar posici√≥n</option>
                            <option value="POR">üß§ POR (Portero)</option>
                            <option value="DEF">üõ°Ô∏è DEF (Defensor)</option>
                            <option value="MED">‚öΩ MED (Mediocampista)</option>
                            <option value="DEL">üéØ DEL (Delantero)</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px; text-align: left;">
                        <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 500;">Imagen de Perfil (opcional - m√°ximo 500KB):</label>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div id="profile-image-preview" style="
                                width: 60px; 
                                height: 60px; 
                                border-radius: 50%; 
                                background: #f0f0f0; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                border: 2px solid #e1e1e1;
                                font-size: 24px;
                            ">üë§</div>
                            <input type="file" id="register-image" accept="image/*" style="
                                flex: 1;
                                padding: 12px 15px; 
                                border: 2px solid #e1e1e1; 
                                border-radius: 10px; 
                                font-size: 14px;
                                box-sizing: border-box;
                                cursor: pointer;
                            ">
                        </div>
                        <p style="font-size: 12px; color: #666; margin: 8px 0 0 0;">JPG, PNG o GIF. M√°ximo 2MB.</p>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 25px; text-align: left;">
                        <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 500;">Contrase√±a:</label>
                        <input type="password" id="register-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="
                            width: 100%; 
                            padding: 12px 15px; 
                            border: 2px solid #e1e1e1; 
                            border-radius: 10px; 
                            font-size: 16px;
                            box-sizing: border-box;
                        " required>
                    </div>
                    
                    <button onclick="AuthSystem.register()" style="
                        width: 100%; 
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                        color: white; 
                        padding: 12px 20px; 
                        border: none; 
                        border-radius: 10px; 
                        font-size: 16px; 
                        font-weight: 600; 
                        cursor: pointer; 
                        margin-bottom: 15px;
                    " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                        ‚öΩ Crear Cuenta y Empezar
                    </button>
                    
                    <p style="margin: 0; color: #666;">
                        ¬øYa tienes cuenta? 
                        <a href="#" onclick="AuthSystem.showLogin()" style="color: #667eea; text-decoration: none; font-weight: 600;">
                            Inicia sesi√≥n aqu√≠
                        </a>
                    </p>
                </div>

                <!-- Demo Mode -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e1e1e1;">
                    <button onclick="AuthSystem.enterDemoMode()" style="
                        background: transparent; 
                        color: #999; 
                        border: 1px solid #ddd; 
                        padding: 8px 16px; 
                        border-radius: 5px; 
                        font-size: 14px; 
                        cursor: pointer;
                    ">
                        üîç Modo Demo (sin registro)
                    </button>
                </div>

                <!-- Loading/Error Messages -->
                <div id="auth-message" style="
                    margin-top: 15px; 
                    padding: 10px; 
                    border-radius: 8px; 
                    display: none;
                "></div>
            </div>
        </div>

        <!-- Group Selector -->
        <div id="group-selector" class="login-overlay" style="display:none;">
            <div class="login-container">
                <h2>Seleccionar Grupo</h2>
                <div id="groups-list" class="groups-list">
                    <p>Cargando grupos...</p>
                </div>
                <button onclick="TestApp.skipGroupSelection()">Saltar Grupo</button>
            </div>
        </div>

        <!-- Header -->
        <header id="app-header">
            <h1>‚öΩ F√∫tbol Mi√©rcoles - BETA</h1>
            <div id="user-info">
                <span id="current-user">Sin usuario</span> | 
                <span id="current-group">Sin grupo</span>
                <button onclick="AuthSystem.logout()" style="margin-left: 10px;">Cerrar Sesi√≥n</button>
            </div>
        </header>

        <!-- Navigation -->
        <nav id="main-nav">
            <button class="nav-btn" data-screen="dashboard">
                <span>üè†</span>
                <span>Inicio</span>
            </button>
            <button class="nav-btn" data-screen="collaborative">
                <span>‚öΩ</span>
                <span>Partidos</span>
            </button>
            <button class="nav-btn" data-screen="players">
                <span>üë•</span>
                <span>Jugadores</span>
            </button>
            <button class="nav-btn" data-screen="matches">
                <span>‚öôÔ∏è</span>
                <span>Manual</span>
            </button>
            <button class="nav-btn" data-screen="evaluate">
                <span>‚úÖ</span>
                <span>Evaluar</span>
            </button>
            <button class="nav-btn" data-screen="profile">
                <span>üë§</span>
                <span>Mi Perfil</span>
            </button>
        </nav>

        <!-- Main Content Area -->
        <main id="main-content">
            <!-- Collaborative Matches Screen -->
            <div id="collaborative-screen" class="screen">
                <h2>ü§ù Partidos Colaborativos</h2>
                <p class="subtitle">
                    √önete a partidos organizados por otros jugadores o crea uno nuevo
                </p>
                
                <!-- Create Match Button -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <button id="create-match-btn" class="btn-create">
                        ‚öΩ Crear Nuevo Partido
                    </button>
                </div>
                
                <!-- Available Matches -->
                <div style="margin-bottom: 30px;">
                    <h3>Partidos Disponibles</h3>
                    <div id="available-matches" style="margin-top: 15px;">
                        <p style="color: #666; text-align: center; padding: 40px;">
                            Cargando partidos disponibles...
                        </p>
                    </div>
                </div>
                
                <!-- My Registered Matches -->
                <div style="margin-top: 40px;">
                    <h3>Mis Partidos</h3>
                    <div id="user-matches" style="margin-top: 15px;">
                        <p style="color: #666; text-align: center; padding: 20px;">
                            No tienes partidos registrados a√∫n
                        </p>
                    </div>
                </div>
            </div>

            <!-- Dashboard Screen -->
            <div id="dashboard-screen" class="screen active">
                <h2>üìä Panel de Control</h2>
                <div id="dashboard-stats">
                    <div class="stat-box">
                        <h3>Total Jugadores</h3>
                        <p id="total-players">0</p>
                    </div>
                    <div class="stat-box">
                        <h3>Total Partidos</h3>
                        <p id="total-matches">0</p>
                    </div>
                    <div class="stat-box">
                        <h3>Grupo Activo</h3>
                        <p id="active-group-name">Ninguno</p>
                    </div>
                </div>
                <div id="dashboard-actions">
                    <button onclick="TestApp.loadPlayers()">Cargar Jugadores</button>
                    <button onclick="TestApp.testFirebase()">Probar Firebase</button>
                </div>
            </div>

            <!-- Evaluation Section -->
            <div id="evaluation-section" style="display: none; margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h3>üìù Evaluaciones Pendientes</h3>
                <div id="pending-evaluations" style="margin-top: 20px;">
                    <!-- Evaluations will be loaded here -->
                </div>
            </div>

            <!-- Players Screen -->
            <div id="players-screen" class="screen">
                <h2>üë• Gesti√≥n de Jugadores</h2>
                <div id="players-actions">
                    <button onclick="TestApp.showAddPlayerForm()">Agregar Jugador</button>
                    <button onclick="TestApp.refreshPlayers()">Actualizar</button>
                </div>
                
                <!-- Add/Edit Player Form -->
                <div id="add-player-form" style="display:none;">
                    <h3 id="player-form-title">Agregar Nuevo Jugador</h3>
                    <form id="player-form">
                        <input type="hidden" id="player-id">
                        
                        <!-- Basic Info -->
                        <div class="form-section">
                            <h4>Informaci√≥n B√°sica</h4>
                            <input type="text" id="player-name" placeholder="Nombre" required>
                            <select id="player-position" required>
                                <option value="">Seleccionar Posici√≥n</option>
                                <option value="POR">POR (Portero)</option>
                                <option value="DEF">DEF (Defensor)</option>
                                <option value="MED">MED (Mediocampista)</option>
                                <option value="DEL">DEL (Delantero)</option>
                            </select>
                        </div>
                        
                        <!-- Photo Upload -->
                        <div class="form-section">
                            <h4>Foto</h4>
                            <div id="photo-preview" style="width: 100px; height: 100px; border: 2px dashed #ccc; margin: 10px 0; display: flex; align-items: center; justify-content: center;">
                                <span style="color: #999;">Sin foto</span>
                            </div>
                            <input type="file" id="player-photo" accept="image/*" onchange="TestApp.previewPhoto(event)">
                            <button type="button" onclick="TestApp.clearPhoto()">Limpiar Foto</button>
                        </div>
                        
                        <!-- Attributes -->
                        <div class="form-section">
                            <h4>Atributos (1-99)</h4>
                            <div class="attributes-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label for="player-pac">PAC (Ritmo)</label>
                                    <input type="number" id="player-pac" min="1" max="99" value="70" required>
                                </div>
                                <div>
                                    <label for="player-sho">SHO (Tiro)</label>
                                    <input type="number" id="player-sho" min="1" max="99" value="70" required>
                                </div>
                                <div>
                                    <label for="player-pas">PAS (Pase)</label>
                                    <input type="number" id="player-pas" min="1" max="99" value="70" required>
                                </div>
                                <div>
                                    <label for="player-dri">DRI (Regate)</label>
                                    <input type="number" id="player-dri" min="1" max="99" value="70" required>
                                </div>
                                <div>
                                    <label for="player-def">DEF (Defensa)</label>
                                    <input type="number" id="player-def" min="1" max="99" value="70" required>
                                </div>
                                <div>
                                    <label for="player-phy">PHY (F√≠sico)</label>
                                    <input type="number" id="player-phy" min="1" max="99" value="70" required>
                                </div>
                            </div>
                            <div style="margin-top: 10px;">
                                <label for="player-ovr">OVR (General) - Auto-calculado</label>
                                <input type="number" id="player-ovr" min="1" max="99" readonly style="background: #f0f0f0;">
                                <button type="button" onclick="TestApp.calculateOVR()">Calcular OVR</button>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" id="submit-player-btn">Agregar Jugador</button>
                            <button type="button" onclick="TestApp.hideAddPlayerForm()">Cancelar</button>
                        </div>
                    </form>
                </div>
                
                <!-- Players List -->
                <div id="players-list">
                    <p>No hay jugadores cargados</p>
                </div>
            </div>

            <!-- Matches Screen -->
            <div id="matches-screen" class="screen">
                <h2>‚öôÔ∏è Partidos Manuales</h2>
                
                <!-- Match Configuration -->
                <div id="match-config" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0;">Configuraci√≥n del Partido</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Formato del Partido:</label>
                            <select id="match-format" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="5v5">5 vs 5</option>
                                <option value="7v7">7 vs 7</option>
                                <option value="11v11">11 vs 11</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Fecha del Partido:</label>
                            <input type="date" id="match-date" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Hora del Partido:</label>
                            <input type="time" id="match-time" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                </div>
                
                <div id="matches-actions" style="margin-bottom: 20px;">
                    <button onclick="TestApp.generateTeams()" style="background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 5px;">
                        Generar Equipos Balanceados
                    </button>
                    <button onclick="TestApp.displayMatchHistory()" style="background: #9b59b6; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 5px;">
                        Ver Historial de Partidos
                    </button>
                    <button onclick="TestApp.debugLoadMatches()" style="background: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 5px;">
                        üêõ Debug: Cargar Partidos
                    </button>
                </div>
                
                <div id="teams-display" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div id="team-a" class="team" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
                        <h3 style="text-align: center; color: #3498db; margin: 0 0 15px 0;">Equipo A</h3>
                        <div class="team-players"></div>
                    </div>
                    <div id="team-b" class="team" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #e74c3c;">
                        <h3 style="text-align: center; color: #e74c3c; margin: 0 0 15px 0;">Equipo B</h3>
                        <div class="team-players"></div>
                    </div>
                </div>
                
                <!-- Match Actions (appears after generating teams) -->
                <div id="match-actions-generated" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4>Acciones del Partido</h4>
                    <button onclick="TestApp.saveMatch()" style="background: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 5px;">
                        Guardar Partido
                    </button>
                    <button onclick="TestApp.generateTeams()" style="background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 5px;">
                        Re-generar Equipos
                    </button>
                </div>
            </div>

            <!-- Evaluate Screen -->
            <div id="evaluate-screen" class="screen">
                <h2>‚úÖ Evaluar Partidos</h2>
                <div id="evaluate-actions" style="margin-bottom: 20px;">
                    <button onclick="TestApp.loadPendingMatches()" style="background: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 5px;">
                        Cargar Partidos Pendientes
                    </button>
                </div>
                
                <div id="pending-matches">
                    <h3>Evaluaciones Pendientes</h3>
                    <div id="pending-matches-list" style="margin-top: 15px;">
                        <p style="color: #666;">Haz clic en "Cargar Partidos Pendientes" para ver los partidos listos para evaluar</p>
                    </div>
                </div>
                
                <div id="evaluation-form" style="display:none; background: #fff; padding: 20px; border-radius: 10px; margin-top: 20px; border: 1px solid #ddd;">
                    <h3 style="text-align: center; margin-bottom: 20px; color: #333;">Evaluar Partido</h3>
                    <div id="match-details"></div>
                    <div id="evaluation-inputs">
                        <!-- Evaluation form will be loaded here -->
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="TestApp.submitEvaluation()" style="background: #27ae60; color: white; padding: 15px 30px; border: none; border-radius: 8px; margin: 10px; font-size: 16px; cursor: pointer;">
                            Enviar Evaluaci√≥n
                        </button>
                        <button onclick="TestApp.cancelEvaluation()" style="background: #95a5a6; color: white; padding: 15px 30px; border: none; border-radius: 8px; margin: 10px; font-size: 16px; cursor: pointer;">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Screen -->
            <div id="stats-screen" class="screen">
                <h2>üìà Estad√≠sticas</h2>
                <div id="stats-content">
                    <p>Las estad√≠sticas se mostrar√°n aqu√≠</p>
                </div>
            </div>

            <!-- Profile Screen -->
            <div id="profile-screen" class="screen">
                <h2>üë§ Mi Perfil</h2>
                <div id="profile-content" style="max-width: 600px; margin: 0 auto;">
                    <!-- Profile info will be loaded here -->
                    <div id="profile-view" style="background: #f9f9f9; padding: 30px; border-radius: 12px; margin-bottom: 20px;">
                        <div id="profile-photo-container" style="text-align: center; margin-bottom: 20px;">
                            <div id="profile-photo-display" style="width: 100px; height: 100px; margin: 0 auto; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 48px;">
                                üë§
                            </div>
                        </div>
                        
                        <div id="profile-info" style="margin-bottom: 20px;">
                            <h3 style="text-align: center; margin: 10px 0;">
                                <span id="profile-name">-</span>
                            </h3>
                            <p style="text-align: center; color: #666;">
                                <span id="profile-email">-</span>
                            </p>
                        </div>
                        
                        <div id="profile-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #2ecc71;">
                                    <span id="profile-ovr">50</span>
                                </div>
                                <div style="color: #666; font-size: 12px;">OVR</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #3498db;">
                                    <span id="profile-position">MED</span>
                                </div>
                                <div style="color: #666; font-size: 12px;">Posici√≥n</div>
                            </div>
                        </div>
                        
                        <div id="profile-attributes" style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <h4 style="margin: 0 0 15px 0;">Atributos</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <div>PAC: <strong id="profile-pac">50</strong></div>
                                <div>SHO: <strong id="profile-sho">50</strong></div>
                                <div>PAS: <strong id="profile-pas">50</strong></div>
                                <div>DRI: <strong id="profile-dri">50</strong></div>
                                <div>DEF: <strong id="profile-def">50</strong></div>
                                <div>PHY: <strong id="profile-phy">50</strong></div>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="TestApp.editProfile()" style="
                                background: #3498db;
                                color: white;
                                padding: 12px 30px;
                                border: none;
                                border-radius: 8px;
                                font-size: 16px;
                                cursor: pointer;
                                transition: background 0.3s;
                            ">
                                ‚úèÔ∏è Editar Perfil
                            </button>
                        </div>
                    </div>
                    
                    <!-- Profile edit form (hidden by default) -->
                    <div id="profile-edit" style="display: none; background: #f9f9f9; padding: 30px; border-radius: 12px;">
                        <h3 style="margin: 0 0 20px 0;">Editar Perfil</h3>
                        <form id="profile-edit-form" onsubmit="TestApp.saveProfile(event); return false;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; color: #555;">Nombre:</label>
                                <input type="text" id="edit-profile-name" required style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ddd;
                                    border-radius: 5px;
                                    font-size: 16px;
                                ">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; color: #555;">Posici√≥n:</label>
                                <select id="edit-profile-position" required style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ddd;
                                    border-radius: 5px;
                                    font-size: 16px;
                                ">
                                    <option value="POR">POR (Portero)</option>
                                    <option value="DEF">DEF (Defensa)</option>
                                    <option value="MED">MED (Mediocampista)</option>
                                    <option value="DEL">DEL (Delantero)</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; color: #555;">Imagen de Perfil:</label>
                                <input type="file" id="edit-profile-image" accept="image/*" style="
                                    width: 100%;
                                    padding: 10px;
                                    border: 1px solid #ddd;
                                    border-radius: 5px;
                                    font-size: 16px;
                                ">
                                <small style="color: #666;">M√°ximo 500KB</small>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button type="submit" style="
                                    flex: 1;
                                    background: #2ecc71;
                                    color: white;
                                    padding: 12px;
                                    border: none;
                                    border-radius: 8px;
                                    font-size: 16px;
                                    cursor: pointer;
                                ">
                                    üíæ Guardar Cambios
                                </button>
                                <button type="button" onclick="TestApp.cancelEditProfile()" style="
                                    flex: 1;
                                    background: #95a5a6;
                                    color: white;
                                    padding: 12px;
                                    border: none;
                                    border-radius: 8px;
                                    font-size: 16px;
                                    cursor: pointer;
                                ">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Settings Screen -->
            <div id="settings-screen" class="screen">
                <h2>Configuraci√≥n y Debug</h2>
                <div id="settings-content">
                    <h3>Gesti√≥n de Usuarios</h3>
                    <button onclick="TestApp.createTestUser()">Crear Usuario de Prueba</button>
                    <button onclick="TestApp.listUsers()">Listar Todos los Usuarios</button>
                    
                    <h3>Gesti√≥n de Grupos</h3>
                    <button onclick="TestApp.createTestGroup()">Crear Grupo de Prueba</button>
                    <button onclick="TestApp.listGroups()">Listar Todos los Grupos</button>
                    
                    <h3>Gesti√≥n de Datos</h3>
                    <button onclick="TestApp.clearCache()">Limpiar Cach√©</button>
                    <button onclick="TestApp.reloadApp()">Recargar App</button>
                    
                    <h3>Estado de Firebase</h3>
                    <div id="firebase-status">
                        <p>Estado: <span id="fb-status">Desconocido</span></p>
                        <p>Conexi√≥n: <span id="fb-connection">Desconocida</span></p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Console/Debug Area - COMMENTED FOR PRODUCTION -->
        <!-- 
        <div id="debug-console">
            <h3>Consola de Debug</h3>
            <div id="console-output"></div>
            <button onclick="TestApp.clearConsole()">Limpiar</button>
        </div>
        -->
    </div>

    <!-- Create Match Modal -->
    <div id="create-match-modal" class="modal hidden" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    ">
        <div class="modal-content" style="
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
            <button id="close-modal" style="
                position: absolute;
                top: 15px;
                right: 15px;
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #666;
            ">&times;</button>
            
            <h3 style="margin-bottom: 25px; color: #333; text-align: center;">‚öΩ Crear Nuevo Partido</h3>
            
            <form id="create-match-form">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">
                        T√≠tulo del Partido *
                    </label>
                    <input 
                        type="text" 
                        name="match-title" 
                        required 
                        placeholder="Ej: F√∫tbol de los Mi√©rcoles"
                        style="
                            width: 100%;
                            padding: 12px;
                            border: 2px solid #e1e1e1;
                            border-radius: 8px;
                            font-size: 16px;
                            transition: border-color 0.3s;
                        "
                    >
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">
                            Fecha *
                        </label>
                        <input 
                            type="date" 
                            name="match-date" 
                            required 
                            style="
                                width: 100%;
                                padding: 12px;
                                border: 2px solid #e1e1e1;
                                border-radius: 8px;
                                font-size: 16px;
                            "
                        >
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">
                            Hora *
                        </label>
                        <input 
                            type="time" 
                            name="match-time" 
                            required 
                            style="
                                width: 100%;
                                padding: 12px;
                                border: 2px solid #e1e1e1;
                                border-radius: 8px;
                                font-size: 16px;
                            "
                        >
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">
                        Ubicaci√≥n *
                    </label>
                    <input 
                        type="text" 
                        name="match-location" 
                        required 
                        placeholder="Ej: Complejo Deportivo Sur"
                        style="
                            width: 100%;
                            padding: 12px;
                            border: 2px solid #e1e1e1;
                            border-radius: 8px;
                            font-size: 16px;
                        "
                    >
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">
                        M√°ximo de Jugadores
                    </label>
                    <select 
                        name="max-players" 
                        style="
                            width: 100%;
                            padding: 12px;
                            border: 2px solid #e1e1e1;
                            border-radius: 8px;
                            font-size: 16px;
                        "
                    >
                        <option value="10" selected>10 jugadores (5 vs 5)</option>
                        <option value="14">14 jugadores (7 vs 7)</option>
                        <option value="22">22 jugadores (11 vs 11)</option>
                    </select>
                </div>

                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">
                        Descripci√≥n (opcional)
                    </label>
                    <textarea 
                        name="match-description" 
                        rows="3"
                        placeholder="Informaci√≥n adicional sobre el partido..."
                        style="
                            width: 100%;
                            padding: 12px;
                            border: 2px solid #e1e1e1;
                            border-radius: 8px;
                            font-size: 16px;
                            resize: vertical;
                        "
                    ></textarea>
                </div>

                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button 
                        type="button" 
                        id="cancel-create-match"
                        onclick="collaborativeSystem.closeCreateMatchModal()"
                        style="
                            padding: 12px 24px;
                            border: 2px solid #ddd;
                            background: white;
                            color: #666;
                            border-radius: 8px;
                            font-size: 16px;
                            cursor: pointer;
                            transition: all 0.3s;
                        "
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit"
                        style="
                            padding: 12px 24px;
                            border: none;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: transform 0.2s;
                        "
                        onmouseover="this.style.transform='translateY(-1px)'" 
                        onmouseout="this.style.transform='translateY(0px)'"
                    >
                        üöÄ Crear Partido
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="js/firebase-simple.js"></script>
    <script src="js/auth-system.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/collaborative-system.js"></script>
    <script>
        // Check if collaborative system loaded
        console.log('üîç After loading collaborative-system.js, CollaborativeSystem class:', typeof CollaborativeSystem);
        console.log('üîç collaborativeSystem instance:', typeof collaborativeSystem);
        
        // If collaborative system didn't load, create it inline
        if (typeof CollaborativeSystem === 'undefined') {
            console.log('‚ö†Ô∏è CollaborativeSystem class not found, creating fallback...');
            
            // Simple fallback collaborative system
            window.CollaborativeSystem = class {
                constructor() {
                    console.log('üèóÔ∏è Creating fallback CollaborativeSystem...');
                    this.currentUser = null;
                    this.availableMatches = [];
                    this.userMatches = [];
                    this.attachEventListeners();
                }
                
                attachEventListeners() {
                    console.log('üîó Fallback: Attaching event listeners...');
                    
                    const createMatchBtn = document.getElementById('create-match-btn');
                    console.log('Fallback: Create match button found:', createMatchBtn);
                    
                    if (createMatchBtn) {
                        createMatchBtn.addEventListener('click', () => {
                            console.log('üñ±Ô∏è Fallback: Create match button clicked!');
                            this.showCreateMatchModal();
                        });
                        console.log('‚úÖ Fallback: Event listener attached');
                    }
                    
                    // Modal close button
                    const closeModal = document.getElementById('close-modal');
                    if (closeModal) {
                        closeModal.addEventListener('click', () => this.closeCreateMatchModal());
                    }

                    // Create match form
                    const createMatchForm = document.getElementById('create-match-form');
                    if (createMatchForm) {
                        createMatchForm.addEventListener('submit', (e) => this.handleCreateMatch(e));
                    }
                }
                
                showCreateMatchModal() {
                    console.log('üéØ Fallback: Showing create match modal...');
                    const modal = document.getElementById('create-match-modal');
                    if (modal) {
                        modal.classList.remove('hidden');
                        console.log('‚úÖ Fallback: Modal shown');
                    } else {
                        console.log('‚ùå Fallback: Modal not found');
                    }
                }
                
                closeCreateMatchModal() {
                    const modal = document.getElementById('create-match-modal');
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                    // Reset form
                    const form = document.getElementById('create-match-form');
                    if (form) {
                        form.reset();
                    }
                }
                
                async handleCreateMatch(e) {
                    e.preventDefault();
                    
                    console.log('üèóÔ∏è Fallback: Creating match...');
                    
                    // Prevent double submissions
                    if (this._creatingMatch) {
                        console.log('‚è≥ Already creating a match, ignoring duplicate submission');
                        return;
                    }
                    this._creatingMatch = true;
                    
                    if (!this.currentUser) {
                        this._creatingMatch = false;
                        alert('Debes estar autenticado para crear un partido');
                        return;
                    }

                    const formData = new FormData(e.target);
                    const matchData = {
                        id: this.generateMatchId(),
                        organizer: {
                            uid: this.currentUser.uid,
                            displayName: this.currentUser.displayName,
                            email: this.currentUser.email
                        },
                        title: formData.get('match-title'),
                        date: formData.get('match-date'),
                        time: formData.get('match-time'),
                        location: formData.get('match-location'),
                        maxPlayers: parseInt(formData.get('max-players') || '10'),
                        description: formData.get('match-description') || '',
                        registeredPlayers: [],
                        status: 'open',
                        createdAt: new Date().toISOString(),
                        groupId: 'o8ZOD6N0KEHrvweFfTAd'
                    };

                    try {
                        if (typeof db !== 'undefined' && db) {
                            await db.collection('collaborative_matches').doc(matchData.id).set(matchData);
                        }
                        
                        this.closeCreateMatchModal();
                        this.showSuccessMessage('¬°Partido creado exitosamente!');
                        
                        // Add the new match directly to avoid reload issues
                        this.availableMatches.unshift(matchData);
                        this.renderAvailableMatches();
                        
                    } catch (error) {
                        console.error('Error creating match:', error);
                        alert('Error al crear el partido. Intenta de nuevo.');
                    } finally {
                        this._creatingMatch = false;
                        console.log('‚úÖ Match creation completed');
                    }
                }
                
                generateMatchId() {
                    return 'match_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                }
                
                showSuccessMessage(message) {
                    // Simple alert for now
                    alert(message);
                }
                
                // Debug function to clean duplicates
                async cleanupDuplicateMatches() {
                    console.log('üßπ Cleaning up duplicate matches...');
                    try {
                        if (typeof db !== 'undefined' && db) {
                            const snapshot = await db.collection('collaborative_matches').get();
                            let deletedCount = 0;
                            
                            for (const doc of snapshot.docs) {
                                await doc.ref.delete();
                                deletedCount++;
                                console.log('üóëÔ∏è Deleted:', doc.id);
                            }
                            
                            console.log(`‚úÖ Deleted ${deletedCount} matches`);
                            this.availableMatches = [];
                            this.renderAvailableMatches();
                        }
                    } catch (error) {
                        console.error('Error cleaning matches:', error);
                    }
                }
                
                setCurrentUser(user) {
                    console.log('üë§ Fallback: Setting user:', user);
                    this.currentUser = user;
                }
                
                reinitializeEventListeners() {
                    console.log('üîÑ Fallback: Reinitializing event listeners');
                    this.attachEventListeners();
                }
                
                async loadMatches() {
                    console.log('üìã Fallback: Loading matches...');
                    console.log('üîÑ Current matches before loading:', this.availableMatches.length);
                    
                    // Prevent multiple simultaneous loads
                    if (this._loadingMatches) {
                        console.log('‚è≥ Already loading matches, skipping...');
                        return;
                    }
                    this._loadingMatches = true;
                    
                    try {
                        if (typeof db !== 'undefined' && db) {
                            // Simplified query without orderBy to avoid index requirement
                            const snapshot = await db.collection('collaborative_matches')
                                .where('status', '==', 'open')
                                .get();
                            
                            this.availableMatches = snapshot.docs
                                .map(doc => doc.data())
                                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Sort in memory
                        }
                        this.renderAvailableMatches();
                        await this.loadPendingEvaluations();
                    } catch (error) {
                        console.error('Error loading matches:', error);
                        // Show a fallback message
                        const container = document.getElementById('available-matches');
                        if (container) {
                            container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Error cargando partidos. Intenta recargar la p√°gina.</p>';
                        }
                    } finally {
                        this._loadingMatches = false;
                        console.log('‚úÖ Loading matches completed');
                    }
                }
                
                renderAvailableMatches() {
                    console.log('üé® Fallback: Rendering matches...');
                    console.log('üìä Total matches to render:', this.availableMatches.length);
                    console.log('üìã Matches:', this.availableMatches.map(m => m.id));
                    
                    const availableContainer = document.getElementById('available-matches');
                    const userContainer = document.getElementById('user-matches');
                    
                    if (!availableContainer || !userContainer) return;
                    
                    // Remove duplicates by ID before rendering
                    const uniqueMatches = [];
                    const seenIds = new Set();
                    
                    for (const match of this.availableMatches) {
                        if (!seenIds.has(match.id)) {
                            seenIds.add(match.id);
                            uniqueMatches.push(match);
                        }
                    }
                    
                    console.log('‚úÖ Unique matches after deduplication:', uniqueMatches.length);
                    
                    // Separate matches between available and user matches
                    const availableMatches = [];
                    const userMatches = [];
                    
                    uniqueMatches.forEach(match => {
                        const isUserInMatch = this.currentUser && 
                                             match.registeredPlayers.some(p => 
                                                 p.uid === this.currentUser.uid || 
                                                 p.uid === this.currentUser.id
                                             );
                        
                        if (isUserInMatch) {
                            userMatches.push(match);
                        } else {
                            availableMatches.push(match);
                        }
                    });
                    
                    // Render available matches
                    this.renderMatchList(availableMatches, availableContainer, 'available');
                    
                    // Render user matches
                    this.renderMatchList(userMatches, userContainer, 'user');
                }
                
                renderMatchList(matches, container, type) {
                    if (matches.length === 0) {
                        const message = type === 'available' ? 
                            'No hay partidos disponibles' : 
                            'No est√°s anotado en ning√∫n partido';
                        container.innerHTML = `<p style="color: #666; text-align: center; padding: 20px;">${message}</p>`;
                        return;
                    }
                    
                    let html = '';
                    matches.forEach(match => {
                        // Separate registered players by type
                        const authenticatedPlayers = match.registeredPlayers.filter(p => !p.isGuest) || [];
                        const guestPlayers = match.registeredPlayers.filter(p => p.isGuest) || [];
                        
                        const isUserInMatch = this.currentUser && 
                                             match.registeredPlayers.some(p => 
                                                 p.uid === this.currentUser.uid || 
                                                 p.uid === this.currentUser.id
                                             );
                        
                        const isOrganizer = this.currentUser && 
                                           (match.organizer.uid === this.currentUser.uid || 
                                            match.organizer.uid === this.currentUser.id);
                        
                        html += `
                            <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                <h3>${match.title} ${isOrganizer ? '<span style="color: #007bff; font-size: 0.8em;">(Organizador)</span>' : ''}</h3>
                                <p>üìÖ ${match.date} a las ${match.time}</p>
                                <p>üìç ${match.location}</p>
                                <p>üë• ${match.registeredPlayers.length}/${match.maxPlayers} jugadores 
                                   ${guestPlayers.length > 0 ? `(${guestPlayers.length} invitados)` : ''}
                                </p>
                                
                                ${match.registeredPlayers.length > 0 ? `
                                    <details style="margin: 10px 0;">
                                        <summary style="cursor: pointer; font-weight: 600; color: #666;">Ver jugadores anotados</summary>
                                        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                            ${authenticatedPlayers.length > 0 ? `
                                                <p><strong>üë§ Usuarios registrados:</strong></p>
                                                <ul style="margin: 5px 0 10px 20px;">
                                                    ${authenticatedPlayers.map(p => `<li>${p.displayName} (${p.position}) - OVR ${p.ovr}</li>`).join('')}
                                                </ul>
                                            ` : ''}
                                            ${guestPlayers.length > 0 ? `
                                                <p><strong>üé≠ Invitados:</strong></p>
                                                <ul style="margin: 5px 0 10px 20px;">
                                                    ${guestPlayers.map(p => `<li>${p.displayName} (${p.position}) - OVR ${p.ovr} <em style="color: #666;">- invitado</em></li>`).join('')}
                                                </ul>
                                            ` : ''}
                                        </div>
                                    </details>
                                ` : ''}
                                
                                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                                    ${type === 'available' ? `
                                        <button onclick="collaborativeSystem.joinMatch('${match.id}')" 
                                                style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; flex: 1; min-width: 120px;">
                                            ${this.getJoinButtonText(match)}
                                        </button>
                                    ` : `
                                        <button onclick="collaborativeSystem.leaveMatch('${match.id}')" 
                                                style="background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; flex: 1; min-width: 120px;">
                                            üö™ Desanotarse
                                        </button>
                                        
                                        ${match.status === 'full' && match.teams ? `
                                            <button onclick="collaborativeSystem.showTeamsModal('${match.id}')" 
                                                    style="background: #17a2b8; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">
                                                ‚öΩ Ver Equipos
                                            </button>
                                        ` : ''}
                                    `}
                                    
                                    <!-- Bot√≥n Invitar siempre visible -->
                                    <button onclick="collaborativeSystem.showInviteGuestsModal('${match.id}')" 
                                            style="background: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">
                                        üé≠ Invitar
                                    </button>
                                    
                                    <!-- Bot√≥n Borrar solo para organizador -->
                                    ${isOrganizer ? `
                                        <button onclick="collaborativeSystem.deleteMatch('${match.id}')" 
                                                style="background: #e74c3c; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">
                                            üóëÔ∏è Borrar
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                }
                
                getJoinButtonText(match) {
                    if (!this.currentUser) return 'Inicia sesi√≥n para anotarte';
                    if (match.registeredPlayers.length >= match.maxPlayers) return 'Partido lleno';
                    if (match.registeredPlayers.some(player => player.uid === this.currentUser.uid)) {
                        return 'Ya est√°s anotado';
                    }
                    return 'Anotarse';
                }
                
                async joinMatch(matchId) {
                    console.log('üèÉ Fallback: Joining match:', matchId);
                    
                    if (!this.currentUser) {
                        alert('Debes estar autenticado para anotarte al partido');
                        return;
                    }
                    
                    try {
                        const match = this.availableMatches.find(m => m.id === matchId);
                        if (!match) {
                            alert('Partido no encontrado');
                            return;
                        }
                        
                        // Check if already registered
                        if (match.registeredPlayers.some(p => p.uid === this.currentUser.uid)) {
                            alert('Ya est√°s anotado en este partido');
                            return;
                        }
                        
                        // Check if match is full
                        if (match.registeredPlayers.length >= match.maxPlayers) {
                            alert('El partido est√° lleno');
                            return;
                        }
                        
                        // Add current user to registered players
                        const playerData = {
                            uid: this.currentUser.uid,
                            displayName: this.currentUser.displayName,
                            position: this.currentUser.position,
                            ovr: this.currentUser.ovr,
                            registeredAt: new Date().toISOString()
                        };
                        
                        match.registeredPlayers.push(playerData);
                        
                        // Check if match is now full and generate teams
                        if (match.registeredPlayers.length >= match.maxPlayers) {
                            match.status = 'full';
                            await this.generateTeamsForMatch(match);
                            console.log('‚úÖ Match is full! Teams generated automatically');
                        }
                        
                        // Save to Firebase
                        if (typeof db !== 'undefined' && db) {
                            await db.collection('collaborative_matches').doc(matchId).set(match);
                        }
                        
                        // Update local state and re-render
                        this.renderAvailableMatches();
                        
                        this.showSuccessMessage('¬°Te anotaste al partido exitosamente!');
                        
                    } catch (error) {
                        console.error('Error joining match:', error);
                        alert('Error al anotarse al partido. Intenta de nuevo.');
                    }
                }
                
                async leaveMatch(matchId) {
                    console.log('üö™ Leaving match:', matchId);
                    
                    if (!this.currentUser) {
                        alert('Debes estar autenticado');
                        return;
                    }
                    
                    if (!confirm('¬øEst√°s seguro de que quieres desanotarte de este partido?')) {
                        return;
                    }
                    
                    try {
                        const match = this.availableMatches.find(m => m.id === matchId);
                        if (!match) return;
                        
                        // Remove user from registered players
                        match.registeredPlayers = match.registeredPlayers.filter(
                            player => player.uid !== this.currentUser.uid && player.uid !== this.currentUser.id
                        );
                        
                        // Update status if needed
                        if (match.status === 'full' && match.registeredPlayers.length < match.maxPlayers) {
                            match.status = 'open';
                            // Remove teams if match is no longer full
                            delete match.teams;
                            delete match.evaluationAssignments;
                        }
                        
                        // Save to Firebase
                        if (typeof db !== 'undefined' && db) {
                            await db.collection('collaborative_matches').doc(matchId).set(match);
                        }
                        
                        // Re-render both sections
                        this.renderAvailableMatches();
                        
                        this.showSuccessMessage('Te desanotaste del partido');
                        
                    } catch (error) {
                        console.error('Error leaving match:', error);
                        alert('Error al desanotarse del partido. Intenta de nuevo.');
                    }
                }
                
                showTeamsModal(matchId) {
                    const match = this.availableMatches.find(m => m.id === matchId);
                    if (!match || !match.teams) return;
                    
                    const modal = document.createElement('div');
                    modal.id = 'teams-modal';
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    `;
                    
                    const modalContent = document.createElement('div');
                    modalContent.style.cssText = `
                        background: white;
                        padding: 30px;
                        border-radius: 15px;
                        max-width: 600px;
                        width: 90%;
                        max-height: 80%;
                        overflow-y: auto;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    `;
                    
                    modalContent.innerHTML = `
                        <h3 style="margin-top: 0; color: #333; text-align: center;">‚öΩ Equipos Generados</h3>
                        <p style="text-align: center; color: #666; margin-bottom: 20px;">${match.title}</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="background: #e3f2fd; padding: 20px; border-radius: 10px;">
                                <h4 style="margin-top: 0; text-align: center; color: #1976d2;">üü¶ Equipo 1</h4>
                                <p style="text-align: center; font-weight: bold;">AVG OVR: ${match.teams.team1.avgOVR}</p>
                                <ul style="list-style: none; padding: 0;">
                                    ${match.teams.team1.players.map(p => `
                                        <li style="padding: 8px; margin: 5px 0; background: white; border-radius: 5px; display: flex; justify-content: space-between;">
                                            <span>${p.name} (${p.position})</span>
                                            <span>OVR ${p.ovr}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            
                            <div style="background: #ffebee; padding: 20px; border-radius: 10px;">
                                <h4 style="margin-top: 0; text-align: center; color: #d32f2f;">üü• Equipo 2</h4>
                                <p style="text-align: center; font-weight: bold;">AVG OVR: ${match.teams.team2.avgOVR}</p>
                                <ul style="list-style: none; padding: 0;">
                                    ${match.teams.team2.players.map(p => `
                                        <li style="padding: 8px; margin: 5px 0; background: white; border-radius: 5px; display: flex; justify-content: space-between;">
                                            <span>${p.name} (${p.position})</span>
                                            <span>OVR ${p.ovr}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                        
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                            <strong>‚öñÔ∏è Diferencia de balance: ${match.teams.balanceDiff} OVR</strong>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="this.closest('#teams-modal').remove()" 
                                    style="background: #6c757d; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                Cerrar
                            </button>
                        </div>
                    `;
                    
                    modal.appendChild(modalContent);
                    document.body.appendChild(modal);
                    
                    // Close modal when clicking outside
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });
                }
                
                async deleteMatch(matchId) {
                    console.log('üóëÔ∏è Deleting match:', matchId);
                    
                    if (!this.currentUser) {
                        alert('Debes estar autenticado para borrar partidos');
                        return;
                    }
                    
                    const match = this.availableMatches.find(m => m.id === matchId);
                    if (!match) {
                        alert('Partido no encontrado');
                        return;
                    }
                    
                    // Verify user is organizer
                    const isOrganizer = match.organizer.uid === this.currentUser.uid || 
                                       match.organizer.uid === this.currentUser.id;
                    
                    if (!isOrganizer) {
                        alert('Solo el organizador puede borrar el partido');
                        return;
                    }
                    
                    // Confirm deletion
                    const confirmMessage = match.registeredPlayers.length > 0 ? 
                        `¬øEst√°s seguro de que quieres borrar el partido "${match.title}"?\n\nHay ${match.registeredPlayers.length} jugador${match.registeredPlayers.length > 1 ? 'es' : ''} anotado${match.registeredPlayers.length > 1 ? 's' : ''}.` :
                        `¬øEst√°s seguro de que quieres borrar el partido "${match.title}"?`;
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                    
                    try {
                        // Delete from Firebase
                        if (typeof db !== 'undefined' && db) {
                            await db.collection('collaborative_matches').doc(matchId).delete();
                        }
                        
                        // Remove from local array
                        const index = this.availableMatches.findIndex(m => m.id === matchId);
                        if (index !== -1) {
                            this.availableMatches.splice(index, 1);
                        }
                        
                        // Re-render both sections
                        this.renderAvailableMatches();
                        
                        this.showSuccessMessage('Partido borrado exitosamente');
                        
                    } catch (error) {
                        console.error('Error deleting match:', error);
                        alert('Error al borrar el partido. Intenta de nuevo.');
                    }
                }
                
                async showInviteGuestsModal(matchId) {
                    console.log('üé≠ Showing invite guests modal for match:', matchId);
                    
                    // Get available manual players from the system
                    let availablePlayers = [];
                    try {
                        if (typeof TestApp !== 'undefined' && TestApp.players) {
                            // Get manual players (those without uid or with manual createdBy)
                            availablePlayers = TestApp.players.filter(player => 
                                !player.uid || player.createdBy === 'manual_creation' || player.createdBy === 'unknown'
                            );
                        }
                    } catch (error) {
                        console.error('Error getting manual players:', error);
                    }
                    
                    if (availablePlayers.length === 0) {
                        alert('No hay jugadores manuales disponibles para invitar. Ve a "Jugadores" para crear algunos.');
                        return;
                    }
                    
                    const match = this.availableMatches.find(m => m.id === matchId);
                    if (!match) return;
                    
                    // Filter out players that are already in the match (both guests and registered users)
                    const playersAlreadyInMatch = new Set();
                    
                    match.registeredPlayers.forEach(player => {
                        // Add manual player IDs (guests)
                        if (player.manualPlayerId) {
                            playersAlreadyInMatch.add(player.manualPlayerId);
                        }
                        // Add names of registered users (to avoid inviting someone with same name)
                        if (player.displayName) {
                            playersAlreadyInMatch.add(player.displayName.toLowerCase().trim());
                        }
                    });
                    
                    const availablePlayersFiltered = availablePlayers.filter(player => {
                        // Check by ID
                        if (playersAlreadyInMatch.has(player.id)) {
                            return false;
                        }
                        // Check by name (case insensitive)
                        if (playersAlreadyInMatch.has(player.name.toLowerCase().trim())) {
                            return false;
                        }
                        return true;
                    });
                    
                    if (availablePlayersFiltered.length === 0) {
                        if (availablePlayers.length === 0) {
                            alert('No hay jugadores manuales disponibles para invitar. Ve a "Jugadores" para crear algunos.');
                        } else {
                            alert('Todos los jugadores manuales disponibles ya est√°n invitados a este partido.');
                        }
                        return;
                    }
                    
                    // Create modal
                    const modal = document.createElement('div');
                    modal.id = 'invite-guests-modal';
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    `;
                    
                    const modalContent = document.createElement('div');
                    modalContent.style.cssText = `
                        background: white;
                        padding: 30px;
                        border-radius: 15px;
                        max-width: 500px;
                        width: 90%;
                        max-height: 80%;
                        overflow-y: auto;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    `;
                    
                    modalContent.innerHTML = `
                        <h3 style="margin-top: 0; color: #333;">üé≠ Invitar Jugadores Manuales</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            Selecciona jugadores manuales para invitar como "invitados" al partido:<br>
                            <small><em>Solo se muestran jugadores que NO est√°n ya anotados.</em></small>
                        </p>
                        
                        <div id="available-players-list">
                            ${availablePlayersFiltered.map(player => `
                                <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border: 2px solid transparent;" 
                                     class="player-invite-item" data-player-id="${player.id}">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" style="margin-right: 10px; transform: scale(1.2);">
                                        <div>
                                            <strong>${player.name}</strong> (${player.position})
                                            <br>
                                            <small style="color: #666;">OVR: ${player.ovr} - Creado manualmente</small>
                                        </div>
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="collaborativeSystem.inviteSelectedGuests('${matchId}')" 
                                    style="background: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; flex: 1;">
                                ‚úÖ Invitar Seleccionados
                            </button>
                            <button onclick="collaborativeSystem.closeInviteGuestsModal()" 
                                    style="background: #6c757d; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;">
                                Cancelar
                            </button>
                        </div>
                    `;
                    
                    modal.appendChild(modalContent);
                    document.body.appendChild(modal);
                    
                    // Close modal when clicking outside
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.closeInviteGuestsModal();
                        }
                    });
                }
                
                closeInviteGuestsModal() {
                    const modal = document.getElementById('invite-guests-modal');
                    if (modal) {
                        modal.remove();
                    }
                }
                
                async inviteSelectedGuests(matchId) {
                    const checkboxes = document.querySelectorAll('#invite-guests-modal input[type="checkbox"]:checked');
                    
                    if (checkboxes.length === 0) {
                        alert('Por favor selecciona al menos un jugador para invitar');
                        return;
                    }
                    
                    try {
                        const match = this.availableMatches.find(m => m.id === matchId);
                        if (!match) return;
                        
                        let addedCount = 0;
                        
                        checkboxes.forEach(checkbox => {
                            const playerItem = checkbox.closest('.player-invite-item');
                            const playerId = playerItem.dataset.playerId;
                            
                            // Find the manual player
                            const manualPlayer = TestApp.players.find(p => p.id === playerId);
                            if (!manualPlayer) return;
                            
                            // Check if already in match
                            if (match.registeredPlayers.some(p => p.manualPlayerId === playerId)) return;
                            
                            // Check if match is full
                            if (match.registeredPlayers.length >= match.maxPlayers) return;
                            
                            // Add as guest
                            const guestData = {
                                uid: `guest_${playerId}`,
                                displayName: manualPlayer.name,
                                position: manualPlayer.position,
                                ovr: manualPlayer.ovr,
                                isGuest: true,
                                manualPlayerId: playerId,
                                registeredAt: new Date().toISOString()
                            };
                            
                            match.registeredPlayers.push(guestData);
                            addedCount++;
                        });
                        
                        // Check if match is now full and generate teams
                        if (match.registeredPlayers.length >= match.maxPlayers) {
                            match.status = 'full';
                            await this.generateTeamsForMatch(match);
                            console.log('‚úÖ Match is full! Teams generated with guests');
                        }
                        
                        // Save to Firebase
                        if (typeof db !== 'undefined' && db) {
                            await db.collection('collaborative_matches').doc(matchId).set(match);
                        }
                        
                        this.closeInviteGuestsModal();
                        this.renderAvailableMatches();
                        
                        alert(`¬°${addedCount} invitado${addedCount > 1 ? 's' : ''} agregado${addedCount > 1 ? 's' : ''} al partido!`);
                        
                    } catch (error) {
                        console.error('Error inviting guests:', error);
                        alert('Error al invitar jugadores. Intenta de nuevo.');
                    }
                }
                
                async generateTeamsForMatch(match) {
                    console.log('‚öΩ Fallback: Generating teams for match:', match.title);
                    
                    const players = match.registeredPlayers.map(p => ({
                        name: p.displayName,
                        position: p.position,
                        ovr: p.ovr,
                        uid: p.uid,
                        isGuest: p.isGuest || false,
                        manualPlayerId: p.manualPlayerId
                    }));

                    // Sort by OVR (highest first)
                    players.sort((a, b) => b.ovr - a.ovr);
                    
                    // Separate by positions for better balance
                    const goalkeepers = players.filter(p => p.position === 'POR');
                    const defenders = players.filter(p => p.position === 'DEF');
                    const midfielders = players.filter(p => p.position === 'MED');
                    const forwards = players.filter(p => p.position === 'DEL');
                    
                    const team1 = [];
                    const team2 = [];
                    let team1OVR = 0;
                    let team2OVR = 0;
                    
                    // Distribute goalkeepers first
                    for (let i = 0; i < goalkeepers.length; i++) {
                        if (i % 2 === 0) {
                            team1.push(goalkeepers[i]);
                            team1OVR += goalkeepers[i].ovr;
                        } else {
                            team2.push(goalkeepers[i]);
                            team2OVR += goalkeepers[i].ovr;
                        }
                    }
                    
                    // Combine other positions and distribute
                    const otherPlayers = [...defenders, ...midfielders, ...forwards];
                    
                    for (const player of otherPlayers) {
                        if (team1OVR <= team2OVR && team1.length < 5) {
                            team1.push(player);
                            team1OVR += player.ovr;
                        } else if (team2.length < 5) {
                            team2.push(player);
                            team2OVR += player.ovr;
                        } else {
                            if (team1.length < 5) {
                                team1.push(player);
                                team1OVR += player.ovr;
                            } else {
                                team2.push(player);
                                team2OVR += player.ovr;
                            }
                        }
                    }
                    
                    const team1Avg = Math.round(team1OVR / team1.length);
                    const team2Avg = Math.round(team2OVR / team2.length);
                    
                    match.teams = {
                        team1: {
                            players: team1,
                            avgOVR: team1Avg,
                            totalOVR: team1OVR
                        },
                        team2: {
                            players: team2,
                            avgOVR: team2Avg,
                            totalOVR: team2OVR
                        },
                        generatedAt: new Date().toISOString(),
                        balanceDiff: Math.abs(team1Avg - team2Avg)
                    };

                    // Generate evaluation assignments
                    match.evaluationAssignments = this.generateEvaluationAssignments(players);
                    
                    console.log(`‚öΩ Teams generated! Team 1 AVG: ${team1Avg}, Team 2 AVG: ${team2Avg}, Balance diff: ${match.teams.balanceDiff}`);
                }
                
                generateEvaluationAssignments(players) {
                    console.log('üìù Fallback: Generating evaluation assignments...');
                    
                    // Only authenticated players participate in evaluations
                    const authenticatedPlayers = players.filter(p => !p.isGuest);
                    const guestCount = players.length - authenticatedPlayers.length;
                    
                    console.log(`üìä Evaluation setup: ${authenticatedPlayers.length} authenticated players, ${guestCount} guests (guests excluded from evaluations)`);
                    
                    if (authenticatedPlayers.length < 2) {
                        console.log('‚ö†Ô∏è Not enough authenticated players for evaluations');
                        return {};
                    }
                    
                    const assignments = {};
                    const evaluationCount = {};
                    
                    // Initialize counters for authenticated players only
                    authenticatedPlayers.forEach(p => {
                        assignments[p.uid] = [];
                        evaluationCount[p.uid] = 0;
                    });
                    
                    // Each authenticated player evaluates 2 other authenticated players
                    for (const evaluator of authenticatedPlayers) {
                        let availableToEvaluate = authenticatedPlayers
                            .filter(p => p.uid !== evaluator.uid)
                            .sort((a, b) => evaluationCount[a.uid] - evaluationCount[b.uid]);
                        
                        const maxEvaluations = Math.min(2, availableToEvaluate.length);
                        
                        for (let i = 0; i < maxEvaluations; i++) {
                            const playerToEvaluate = availableToEvaluate[i];
                            assignments[evaluator.uid].push({
                                uid: playerToEvaluate.uid,
                                name: playerToEvaluate.name,
                                position: playerToEvaluate.position
                            });
                            evaluationCount[playerToEvaluate.uid]++;
                        }
                    }
                    
                    return assignments;
                }
                
                async loadPendingEvaluations() {
                    console.log('üìù Fallback: Loading pending evaluations (stub)');
                    // Simplified version
                    const section = document.getElementById('evaluation-section');
                    if (section) {
                        section.style.display = 'none';
                    }
                }
            };
            
            // Create fallback instance
            window.collaborativeSystem = new CollaborativeSystem();
            console.log('‚úÖ Fallback collaborative system created');
        }
    </script>
    <script src="js/test-app.js"></script>
    
    <script>
        // TestApp initialization is now handled by AuthSystem
        // AuthSystem will call TestApp.init() after authentication
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ App starting - AuthSystem will handle initialization...');
        });
    </script>
</body>
</html>