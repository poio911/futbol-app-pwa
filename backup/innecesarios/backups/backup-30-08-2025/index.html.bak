<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#00ff9d">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FC24 Manager">
    <title>FC MIL DISCULPIS</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="css/styles.css" rel="stylesheet">
    <link href="css/match-management.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- NEW: Welcome/Login Screen -->
        <div id="welcome-screen" class="screen active animate__animated animate__fadeIn">
            <div class="welcome-container">
                <div class="welcome-header">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%2300ff9d'/%3E%3Cpath d='M30 50 L45 35 L45 45 L70 45 L70 55 L45 55 L45 65 Z' fill='black'/%3E%3C/svg%3E" alt="FC24" class="welcome-logo">
                    <h1 class="welcome-title">Futbol Miercoles</h1>
                    <p class="welcome-subtitle">Gestiona tus equipos de f√∫tbol</p>
                </div>

                <div class="welcome-options">
                    <!-- Existing Users Section -->
                    <div class="welcome-section">
                        <h2>Iniciar Sesi√≥n</h2>
                        <p>Selecciona tu usuario existente</p>
                        
                        <div class="existing-users-list" id="existing-users-list">
                            <!-- Users will be loaded here -->
                        </div>
                        
                        <div class="no-users-message" id="no-users-message" style="display: none;">
                            <i class='bx bx-user-x'></i>
                            <p>No hay usuarios registrados</p>
                        </div>
                    </div>

                    <!-- Or Divider -->
                    <div class="welcome-divider">
                        <span>O</span>
                    </div>

                    <!-- New User Section -->
                    <div class="welcome-section">
                        <h2>¬øPrimera vez?</h2>
                        <p>Crea tu cuenta en segundos</p>
                        
                        <button class="btn btn-primary btn-large" id="create-account-btn">
                            <i class='bx bx-user-plus'></i>
                            <span>Crear Nueva Cuenta</span>
                        </button>
                        
                        <div class="demo-option">
                            <button class="btn-link" id="demo-mode-btn">
                                <i class='bx bx-play-circle'></i>
                                <span>Probar modo demo</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="welcome-footer">
                    <small>Versi√≥n 2.2 | ¬© 2025 poiolopez</small>
                </div>
            </div>
        </div>

        <!-- Person Setup Screen (for new users) -->
        <div id="person-setup-screen" class="screen animate__animated animate__fadeIn setup-screen">
            <div class="setup-layout">
                <h1 class="setup-title">Bienvenido a FC24 Team Manager</h1>
                <p class="setup-subtitle">Para comenzar, necesitamos crear tu perfil personal</p>

                <form id="person-form" class="setup-form">
                    <div class="form-field">
                        <label for="person-name">Tu Nombre Completo</label>
                        <input type="text" id="person-name" placeholder="Ej. Juan P√©rez" required>
                    </div>

                    <div class="form-field">
                        <label for="person-email">Email</label>
                        <input type="email" id="person-email" placeholder="juan@email.com" required>
                    </div>

                    <div class="form-field">
                        <label for="person-phone">Tel√©fono (Opcional)</label>
                        <input type="tel" id="person-phone" placeholder="+1234567890">
                    </div>

                    <div class="photo-section">
                        <label class="photo-label">Foto de Perfil (Opcional)</label>
                        <div class="photo-wrapper">
                            <div class="person-photo" id="person-photo-preview">
                                <div class="player-photo-placeholder"><i class='bx bx-user'></i></div>
                            </div>
                            <button type="button" class="upload-btn photo-action" id="person-upload-trigger">
                                <i class='bx bx-image-add'></i> Seleccionar Foto
                            </button>
                            <input type="file" id="person-photo" accept="image/*" style="display:none;">
                        </div>
                    </div>

                    <button type="submit" class="btn primary-btn">Crear Perfil</button>
                </form>
            </div>
        </div>

        <!-- NEW: Group Setup Screen -->
        <div id="group-setup-screen" class="screen animate__animated animate__fadeIn">
            <h1>Configurar Grupo</h1>
            <div class="setup-intro">
                <p>¬°Hola <span id="person-greeting">Usuario</span>!</p>
                <p>Ahora puedes crear un nuevo grupo o unirte a uno existente</p>
            </div>
            
            <div class="group-setup-options">
                <div class="setup-option" id="create-group-option">
                    <div class="option-icon">
                        <i class='bx bx-plus-circle'></i>
                    </div>
                    <h3>Crear Nuevo Grupo</h3>
                    <p>Inicia tu propio grupo para organizar partidos</p>
                </div>
                
                <div class="setup-option" id="join-group-option">
                    <div class="option-icon">
                        <i class='bx bx-group'></i>
                    </div>
                    <h3>Unirse a Grupo</h3>
                    <p>√önete a un grupo existente con un c√≥digo</p>
                </div>
            </div>
        </div>

        <!-- NEW: Create Group Screen -->
        <div id="create-group-screen" class="screen animate__animated animate__fadeIn">
            <h1>Crear Nuevo Grupo</h1>
            
            <form id="group-form">
                <div class="form-group">
                    <label for="group-name">Nombre del Grupo</label>
                    <input type="text" id="group-name" placeholder="Ej. F√∫tbol Mi√©rcoles" required>
                </div>
                
                <div class="form-group">
                    <label for="group-description">Descripci√≥n</label>
                    <textarea id="group-description" placeholder="Describe el grupo, horarios, ubicaci√≥n, etc." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="group-schedule">Horario/D√≠a</label>
                    <input type="text" id="group-schedule" placeholder="Ej. Mi√©rcoles 19:00" required>
                </div>
                
                <div class="form-group">
                    <label for="group-max-members">M√°ximo de Miembros</label>
                    <select id="group-max-members">
                        <option value="10">10 miembros</option>
                        <option value="15">15 miembros</option>
                        <option value="20" selected>20 miembros</option>
                        <option value="30">30 miembros</option>
                        <option value="50">50 miembros</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="group-private">
                        <span class="checkmark"></span>
                        Grupo Privado (requiere invitaci√≥n)
                    </label>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="back-to-setup">Volver</button>
                    <button type="submit" class="btn">Crear Grupo</button>
                </div>
            </form>
        </div>

        <!-- NEW: Join Group Screen -->
        <div id="join-group-screen" class="screen animate__animated animate__fadeIn">
            <h1>Unirse a Grupo</h1>
            
            <div class="join-group-form">
                <div class="form-group">
                    <label for="group-code">C√≥digo del Grupo</label>
                    <input type="text" id="group-code" placeholder="Ej. ABC123" maxlength="6" style="text-transform: uppercase;">
                    <small>Solicita el c√≥digo de 6 caracteres al administrador del grupo</small>
                </div>
                
                <div id="group-preview" class="group-preview" style="display: none;">
                    <!-- Group preview will be shown here -->
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="back-to-setup-2">Volver</button>
                    <button type="button" class="btn" id="search-group">Buscar Grupo</button>
                    <button type="button" class="btn" id="join-group-btn" style="display: none;">Unirse al Grupo</button>
                </div>
            </div>
        </div>

        <!-- ENHANCED: Group Selector Screen with full management -->
        <div id="group-selector-screen" class="screen animate__animated animate__fadeIn">
            <div class="screen-header">
                <h1>Mis Grupos</h1>
                <button class="btn-icon" id="refresh-groups-btn">
                    <i class='bx bx-refresh'></i>
                </button>
            </div>
            
            <div class="groups-tabs">
                <button class="tab-btn active" data-tab="my-groups">Mis Grupos</button>
                <button class="tab-btn" data-tab="available-groups">Grupos Disponibles</button>
            </div>
            
            <!-- My Groups Tab -->
            <div class="tab-content active" id="my-groups-tab">
                <div class="groups-grid" id="groups-list">
                    <!-- User's groups will be loaded here -->
                </div>
                
                <div class="empty-state" id="no-groups-message" style="display: none;">
                    <i class='bx bx-group'></i>
                    <h3>No tienes grupos a√∫n</h3>
                    <p>Crea tu primer grupo o √∫nete a uno existente</p>
                </div>
            </div>
            
            <!-- Available Groups Tab -->
            <div class="tab-content" id="available-groups-tab">
                <div class="search-box">
                    <input type="text" id="search-groups" placeholder="Buscar grupos p√∫blicos...">
                    <i class='bx bx-search'></i>
                </div>
                
                <div class="groups-grid" id="available-groups-list">
                    <!-- Available public groups will be loaded here -->
                </div>
                
                <div class="empty-state" id="no-available-groups" style="display: none;">
                    <i class='bx bx-search-alt'></i>
                    <h3>No hay grupos p√∫blicos disponibles</h3>
                    <p>Todos los grupos son privados o ya eres miembro</p>
                </div>
            </div>
            
            <div class="selector-actions">
                <button type="button" class="btn btn-primary" id="create-another-group">
                    <i class='bx bx-plus'></i> Crear Nuevo Grupo
                </button>
                <button type="button" class="btn btn-secondary" id="join-another-group">
                    <i class='bx bx-log-in'></i> Unirse con C√≥digo
                </button>
            </div>
        </div>

        <!-- NEW: Dashboard Screen - Redesigned -->
        <div id="dashboard-screen" class="screen animate__animated animate__fadeIn">
            <div class="dashboard-header">
                <div class="welcome-section">
                    <h1 id="welcome-message">¬°Bienvenido!</h1>
                    <p class="group-info">Grupo: <strong id="dash-group-name">--</strong></p>
                </div>
                <div class="dashboard-date">
                    <i class='bx bx-calendar'></i>
                    <span id="current-date"></span>
                </div>
            </div>

            <!-- Main Dashboard Grid -->
            <div class="dashboard-main-grid">
                <!-- Next Match Card -->
                <div class="dashboard-card next-match-card">
                    <div class="card-header">
                        <h3><i class='bx bx-time-five'></i> Pr√≥ximo Partido</h3>
                    </div>
                    <div id="next-match-content" class="card-content">
                        <!-- Next match info will be loaded here -->
                    </div>
                </div>

                <!-- Recent Matches -->
                <div class="dashboard-card recent-matches-card">
                    <div class="card-header">
                        <h3><i class='bx bx-history'></i> √öltimos Partidos</h3>
                    </div>
                    <div id="recent-matches-content" class="card-content">
                        <!-- Recent matches will be loaded here -->
                    </div>
                </div>

                <!-- Top Performers -->
                <div class="dashboard-card top-performers-card">
                    <div class="card-header">
                        <h3><i class='bx bx-star'></i> Mejores Jugadores</h3>
                        <span class="subtitle">√öltimos 7 d√≠as</span>
                    </div>
                    <div id="top-performers-content" class="card-content">
                        <!-- Top performers will be loaded here -->
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="dashboard-card stats-summary-card">
                    <div class="card-header">
                        <h3><i class='bx bx-stats'></i> Resumen del Grupo</h3>
                    </div>
                    <div class="stats-summary-grid">
                        <div class="mini-stat">
                            <div class="mini-stat-value" id="total-players-stat">0</div>
                            <div class="mini-stat-label">Jugadores</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value" id="total-matches-stat">0</div>
                            <div class="mini-stat-label">Partidos</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value" id="avg-ovr-stat">0</div>
                            <div class="mini-stat-label">OVR Promedio</div>
                        </div>
                        <div class="mini-stat">
                            <div class="mini-stat-value" id="win-rate-stat">0%</div>
                            <div class="mini-stat-label">Victorias</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-quick-actions">
                <button class="quick-action-btn primary" onclick="App.navigateToScreen('matches-screen')" data-tooltip="Generar equipos balanceados y programar partidos">
                    <i class='bx bx-football'></i>
                    <span>Crear Partido</span>
                </button>
                <button class="quick-action-btn" onclick="App.navigateToScreen('register-screen')" data-tooltip="Registrar un nuevo jugador en el grupo">
                    <i class='bx bx-user-plus'></i>
                    <span>Agregar Jugador</span>
                </button>
                <button class="quick-action-btn" onclick="App.navigateToScreen('evaluate-screen')" data-tooltip="Evaluar el desempe√±o de jugadores despu√©s de un partido">
                    <i class='bx bx-clipboard'></i>
                    <span>Evaluar</span>
                </button>
                <button class="quick-action-btn" onclick="App.navigateToScreen('stats-screen')" data-tooltip="Ver ranking y estad√≠sticas detalladas de jugadores">
                    <i class='bx bx-bar-chart-alt-2'></i>
                    <span>Estad√≠sticas</span>
                </button>
            </div>
        </div>

        <!-- Registro Screen - MODIFIED: Added group context indicator -->
        <div id="register-screen" class="screen animate__animated animate__fadeIn">
            <!-- NEW: Group Context Header -->
            <div class="group-context-header" id="group-context-header">
                <div class="current-group-info">
                    <span class="group-label">Grupo Activo:</span>
                    <span class="group-name" id="current-group-name">Sin Grupo</span>
                    <button class="change-group-btn" id="change-group-btn">
                        <i class='bx bx-refresh'></i>
                    </button>
                </div>
                <div class="person-info">
                    <span class="person-name" id="current-person-name">Usuario</span>
                    <button class="person-menu-btn" id="person-menu-btn">
                        <i class='bx bx-user-circle'></i>
                    </button>
                </div>
            </div>

            <h1>Registro de Jugadores</h1>
            
            <form id="player-form">
                <div class="form-group">
                    <label for="player-name">Nombre del Jugador</label>
                    <input type="text" id="player-name" placeholder="Ej. Lionel Messi" required>
                </div>
                
                <div class="form-group">
                    <label for="player-position">Posici√≥n</label>
                    <select id="player-position" required>
                        <option value="">Selecciona una posici√≥n</option>
                        <option value="POR">Portero (POR)</option>
                        <option value="DEF">Defensa (DEF)</option>
                        <option value="MED">Mediocampista (MED)</option>
                        <option value="DEL">Delantero (DEL)</option>
                    </select>
                </div>
                
                <div class="photo-upload">
                    <label>Foto del Jugador</label>
                    <div class="player-photo" id="photo-preview">
                        <div class="player-photo-placeholder">
                            <i class='bx bx-user'></i>
                        </div>
                    </div>
                    <input type="file" id="player-photo" accept="image/*" style="display: none;">
                    <button type="button" class="upload-btn" id="upload-trigger">Seleccionar Foto</button>
                </div>
                
                <div class="form-group">
                    <label>Atributos</label>
                    
                    <div class="stat-slider">
                        <span class="stat-name">PAC</span>
                        <input type="range" id="pac" min="1" max="100" value="50">
                        <span class="stat-value" id="pac-value">50</span>
                    </div>
                    
                    <div class="stat-slider">
                        <span class="stat-name">SHO</span>
                        <input type="range" id="sho" min="1" max="100" value="50">
                        <span class="stat-value" id="sho-value">50</span>
                    </div>
                    
                    <div class="stat-slider">
                        <span class="stat-name">PAS</span>
                        <input type="range" id="pas" min="1" max="100" value="50">
                        <span class="stat-value" id="pas-value">50</span>
                    </div>
                    
                    <div class="stat-slider">
                        <span class="stat-name">DRI</span>
                        <input type="range" id="dri" min="1" max="100" value="50">
                        <span class="stat-value" id="dri-value">50</span>
                    </div>
                    
                    <div class="stat-slider">
                        <span class="stat-name">DEF</span>
                        <input type="range" id="def" min="1" max="100" value="50">
                        <span class="stat-value" id="def-value">50</span>
                    </div>
                    
                    <div class="stat-slider">
                        <span class="stat-name">PHY</span>
                        <input type="range" id="phy" min="1" max="100" value="50">
                        <span class="stat-value" id="phy-value">50</span>
                    </div>
                </div>
                
                <div class="card-preview">
                    <h3>Vista Previa</h3>
                    <div class="player-card">
                        <div class="player-card-content">
                            <div class="player-photo" id="preview-photo">
                                <div class="player-photo-placeholder">
                                    <i class='bx bx-user'></i>
                                </div>
                            </div>
                            <div class="player-info">
                                <div class="player-name" id="preview-name">Nombre del Jugador</div>
                                <div class="player-position" id="preview-position">POS</div>
                            </div>
                            <div class="player-ovr" id="preview-ovr">50</div>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn">Guardar Jugador</button>
            </form>
        </div>
        
        <!-- Stats Screen - ENHANCED: Added player management -->
        <div id="stats-screen" class="screen animate__animated animate__fadeIn">
            <div class="group-context-header">
                <div class="current-group-info">
                    <span class="group-label">Grupo:</span>
                    <span class="group-name" id="stats-group-name">Sin Grupo</span>
                </div>
            </div>

            <div class="stats-header">
                <h1>Estad√≠sticas de Jugadores</h1>
                <div class="stats-actions">
                    <button id="toggle-edit-mode" class="btn-icon" title="Modo edici√≥n">
                        <i class='bx bx-edit'></i>
                    </button>
                    <button id="delete-selected-btn" class="btn-danger" style="display: none;">
                        <i class='bx bx-trash'></i> Eliminar Seleccionados
                    </button>
                </div>
            </div>
            
            <div class="player-grid" id="players-grid">
                <!-- Players will be loaded here with delete options -->
            </div>
        </div>
        
        <!-- Partidos Screen - ENHANCED with complete match management -->
        <div id="matches-screen" class="screen animate__animated animate__fadeIn">
            <div class="group-context-header">
                <div class="current-group-info">
                    <span class="group-label">Grupo:</span>
                    <span class="group-name" id="matches-group-name">Sin Grupo</span>
                </div>
            </div>

            <h1>Gesti√≥n de Partidos</h1>
            
            <!-- Enhanced Match Creation Section -->
            <div class="match-creation-section">
                <div class="creation-tabs">
                    <button class="tab-btn active" data-tab="auto-teams">Equipos Autom√°ticos</button>
                    <button class="tab-btn" data-tab="manual-teams">Equipos Manuales</button>
                </div>
                
                <!-- Auto Teams Tab -->
                <div class="tab-content active" id="auto-teams-tab">
                    <div class="match-controls">
                        <div class="match-settings">
                            <div class="setting-group">
                                <label for="match-format">Formato:</label>
                                <select id="match-format">
                                    <option value="5v5">5 vs 5</option>
                                    <option value="7v7">7 vs 7</option>
                                    <option value="11v11">11 vs 11</option>
                                </select>
                            </div>
                            <div class="setting-group">
                                <label for="match-date">Fecha del Partido:</label>
                                <input type="datetime-local" id="match-date" />
                            </div>
                        </div>
                        <div class="match-action-buttons">
                            <button id="select-players-btn" class="btn-secondary">
                                <i class='bx bx-user-check'></i> Seleccionar Jugadores
                            </button>
                            <button id="generate-teams-btn" class="btn">
                                <i class='bx bx-shuffle'></i> Generar Equipos Balanceados
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Manual Teams Tab -->
                <div class="tab-content" id="manual-teams-tab">
                    <div class="manual-team-builder">
                        <div class="setting-group">
                            <label for="manual-match-date">Fecha del Partido:</label>
                            <input type="datetime-local" id="manual-match-date" />
                        </div>
                        <div class="teams-builder-container">
                            <div class="team-builder" id="team-a-builder">
                                <h3>Equipo A</h3>
                                <div class="team-players-list" id="team-a-players">
                                    <!-- Drop players here -->
                                </div>
                                <div class="team-stats">
                                    OVR: <span id="team-a-ovr">0</span>
                                </div>
                            </div>
                            <div class="available-players-section">
                                <h3>Jugadores Disponibles</h3>
                                <div class="available-players-list" id="available-players">
                                    <!-- Players will be loaded here -->
                                </div>
                            </div>
                            <div class="team-builder" id="team-b-builder">
                                <h3>Equipo B</h3>
                                <div class="team-players-list" id="team-b-players">
                                    <!-- Drop players here -->
                                </div>
                                <div class="team-stats">
                                    OVR: <span id="team-b-ovr">0</span>
                                </div>
                            </div>
                        </div>
                        <button id="save-manual-teams-btn" class="btn btn-primary" disabled>
                            <i class='bx bx-save'></i> Guardar Equipos Manuales
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ENHANCED: Player selection area with full functionality -->
            <div id="player-selection-area" class="player-selection-area" style="display: none;">
                <div class="selection-header">
                    <h3>Selecciona Jugadores para el Partido</h3>
                    <button id="close-selection-btn" class="btn-close">
                        <i class='bx bx-x'></i>
                    </button>
                </div>
                
                <div class="format-info">
                    <div class="format-item">
                        <i class='bx bx-football'></i>
                        <span id="format-display">Formato: 5v5</span>
                    </div>
                    <div class="format-item">
                        <i class='bx bx-user-check'></i>
                        <span id="players-needed">Jugadores necesarios: 10</span>
                    </div>
                    <div class="format-item selected-count">
                        <i class='bx bx-group'></i>
                        <span id="players-selected">Seleccionados: 0</span>
                    </div>
                </div>
                
                <!-- Search and filter -->
                <div class="selection-filters">
                    <input type="text" id="player-search" placeholder="Buscar jugador..." class="search-input">
                    <select id="position-filter" class="filter-select">
                        <option value="">Todas las posiciones</option>
                        <option value="POR">Porteros</option>
                        <option value="DEF">Defensas</option>
                        <option value="MED">Mediocampistas</option>
                        <option value="DEL">Delanteros</option>
                    </select>
                    <select id="sort-players" class="filter-select">
                        <option value="ovr-desc">OVR ‚Üì</option>
                        <option value="ovr-asc">OVR ‚Üë</option>
                        <option value="name-asc">Nombre A-Z</option>
                        <option value="name-desc">Nombre Z-A</option>
                    </select>
                </div>
                
                <div class="player-selection-grid" id="player-selection-grid">
                    <!-- Players will be loaded here dynamically -->
                </div>
                
                <div class="selection-actions">
                    <button id="select-all-btn" class="btn-secondary">
                        <i class='bx bx-select-multiple'></i> Seleccionar Todos
                    </button>
                    <button id="clear-selection-btn" class="btn-secondary">
                        <i class='bx bx-x-circle'></i> Limpiar Selecci√≥n
                    </button>
                    <button id="generate-selected-teams-btn" class="btn btn-primary" disabled>
                        <i class='bx bx-trophy'></i> Generar Equipos
                    </button>
                </div>
            </div>
            
            <div id="teams-container" class="teams-container">
                <!-- Teams will be shown here -->
            </div>
            
            <!-- NEW: Save match button -->
            <div class="match-save-section" style="display: none;">
                <button id="save-match-btn" class="btn btn-success">
                    <i class='bx bx-save'></i> Programar Partido
                </button>
            </div>
            
            <!-- Enhanced Match History with Management Options -->
            <div class="match-history">
                <div class="history-header">
                    <h2>Historial de Partidos</h2>
                    <div class="history-controls">
                        <button id="toggle-edit-matches" class="btn-icon" title="Modo edici√≥n">
                            <i class='bx bx-edit'></i>
                        </button>
                        <button id="delete-selected-matches" class="btn-danger" style="display: none;">
                            <i class='bx bx-trash'></i> Eliminar Seleccionados
                        </button>
                    </div>
                </div>
                <div class="match-filters">
                    <select id="match-status-filter">
                        <option value="all">Todos los partidos</option>
                        <option value="pending">Pendientes</option>
                        <option value="completed">Completados</option>
                    </select>
                    <input type="date" id="match-date-filter" placeholder="Filtrar por fecha">
                </div>
                <div id="match-list" class="match-list">
                    <!-- Enhanced match cards will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Evaluar Screen - MODIFIED: Added group context -->
        <div id="evaluate-screen" class="screen animate__animated animate__fadeIn">
            <div class="group-context-header">
                <div class="current-group-info">
                    <span class="group-label">Grupo:</span>
                    <span class="group-name" id="evaluate-group-name">Sin Grupo</span>
                </div>
            </div>

            <h1>Evaluar Partidos</h1>
            
            <!-- Match Selection -->
            <div class="evaluation-section">
                <h2>Seleccionar Partido</h2>
                <div id="matches-for-evaluation" class="matches-evaluation-list">
                    <!-- Matches ready for evaluation will be loaded here -->
                </div>
            </div>
            
            <!-- Match Evaluation Form (hidden initially) -->
            <div id="match-evaluation-form" class="match-evaluation-form" style="display: none;">
                <div class="evaluation-header">
                    <h2>Evaluar Partido</h2>
                    <div class="match-info">
                        <div class="match-date" id="eval-match-date">Fecha del partido</div>
                        <div class="match-teams" id="eval-match-teams">Equipos</div>
                    </div>
                </div>
                
                <!-- Match Result -->
                <div class="match-result-section">
                    <h3>Resultado del Partido</h3>
                    <div class="result-input">
                        <div class="team-score">
                            <label id="team-a-label">Equipo A</label>
                            <input type="number" id="team-a-score" min="0" max="50" value="0">
                        </div>
                        <div class="score-separator">-</div>
                        <div class="team-score">
                            <label id="team-b-label">Equipo B</label>
                            <input type="number" id="team-b-score" min="0" max="50" value="0">
                        </div>
                    </div>
                </div>
                
                <!-- Goal Scorers section removed - using simple score input only -->
                
                <!-- Player Ratings -->
                <div class="player-ratings-section">
                    <h3>Calificar Jugadores</h3>
                    <div id="player-ratings-list" class="player-ratings-list">
                        <!-- Player rating cards will be loaded here -->
                    </div>
                </div>
                
                <!-- Save Evaluation -->
                <div class="evaluation-actions">
                    <button type="button" id="save-evaluation-btn" class="btn btn-success">
                        <i class='bx bx-save'></i> Guardar Evaluaci√≥n
                    </button>
                    <button type="button" id="cancel-evaluation-btn" class="btn-secondary">
                        <i class='bx bx-x'></i> Cancelar
                    </button>
                </div>
            </div>
            
            <!-- Legacy player selector (keeping for compatibility) -->
            <div id="legacy-player-evaluation" style="display: none;">
                <select id="player-selector" class="player-selector">
                    <option value="">Selecciona un jugador</option>
                    <!-- Players will be loaded here -->
                </select>
            
            <div id="evaluation-form" style="display: none;">
                <div class="form-group">
                    <label>Atributos</label>
                    
                    <div class="stat-slider">
                        <span class="stat-name">PAC</span>
                        <input type="range" id="eval-pac" min="1" max="100" value="50">
                        <span class="stat-value" id="eval-pac-value">50</span>
                    </div>
                    
                    <div class="stat-slider">
                        <span class="stat-name">SHO</span>
                        <input type="range" id="eval-sho" min="1" max="100" value="50">
                        <span class="stat-value" id="eval-sho-value">50</span>
                    </div>
                    
                    <div class="stat-slider">
                        <span class="stat-name">PAS</span>
                        <input type="range" id="eval-pas" min="1" max="100" value="50">
                        <span class="stat-value" id="eval-pas-value">50</span>
                    </div>
                    
                    <div class="stat-slider">
                        <span class="stat-name">DRI</span>
                        <input type="range" id="eval-dri" min="1" max="100" value="50">
                        <span class="stat-value" id="eval-dri-value">50</span>
                    </div>
                    
                    <div class="stat-slider">
                        <span class="stat-name">DEF</span>
                        <input type="range" id="eval-def" min="1" max="100" value="50">
                        <span class="stat-value" id="eval-def-value">50</span>
                    </div>
                    
                    <div class="stat-slider">
                        <span class="stat-name">PHY</span>
                        <input type="range" id="eval-phy" min="1" max="100" value="50">
                        <span class="stat-value" id="eval-phy-value">50</span>
                    </div>
                </div>
                
                <button id="save-evaluation" class="btn">Guardar Evaluaci√≥n</button>
            </div>
        </div>
        
        <!-- Ranking Screen - MODIFIED: Added group context -->
        <div id="ranking-screen" class="screen animate__animated animate__fadeIn">
            <div class="group-context-header">
                <div class="current-group-info">
                    <span class="group-label">Grupo:</span>
                    <span class="group-name" id="ranking-group-name">Sin Grupo</span>
                </div>
            </div>

            <h1>Ranking de Jugadores</h1>
            
            <ul class="ranking-list" id="ranking-list">
                <!-- Players ranked by OVR will be listed here -->
            </ul>
        </div>
    </div>
    
    <!-- Player Detail Modal - UNCHANGED -->
    <div id="player-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="close-modal"><i class='bx bx-x'></i></span>
            
            <div class="player-detail" id="player-detail">
                <!-- Player details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- ENHANCED: Person Menu Modal with full functionality -->
    <div id="person-menu-modal" class="modal">
        <div class="modal-content person-menu-content">
            <span class="close-modal" id="close-person-menu"><i class='bx bx-x'></i></span>
            
            <div class="person-menu">
                <div class="person-profile">
                    <div class="person-avatar" id="person-menu-avatar">
                        <i class='bx bx-user-circle'></i>
                    </div>
                    <div class="person-info">
                        <h3 id="person-menu-name">Usuario</h3>
                        <p id="person-menu-email">email@example.com</p>
                        <span class="member-since" id="member-since">Miembro desde: --</span>
                    </div>
                </div>
                
                <div class="person-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="total-groups">0</span>
                        <span class="stat-label">Grupos</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="total-players">0</span>
                        <span class="stat-label">Jugadores</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="total-matches">0</span>
                        <span class="stat-label">Partidos</span>
                    </div>
                </div>
                
                <div class="menu-options">
                    <button class="menu-option" id="change-group-option">
                        <i class='bx bx-refresh'></i>
                        <span>Cambiar Grupo Activo</span>
                        <i class='bx bx-chevron-right'></i>
                    </button>
                    <button class="menu-option" id="manage-groups-option">
                        <i class='bx bx-cog'></i>
                        <span>Gestionar Mis Grupos</span>
                        <i class='bx bx-chevron-right'></i>
                    </button>
                    <button class="menu-option" id="import-data-option">
                        <i class='bx bx-import'></i>
                        <span>Importar Datos</span>
                        <i class='bx bx-chevron-right'></i>
                    </button>
                    <button class="menu-option" id="export-data-option">
                        <i class='bx bx-export'></i>
                        <span>Exportar Datos</span>
                        <i class='bx bx-chevron-right'></i>
                    </button>
                    <button class="menu-option" id="theme-toggle-option">
                        <i class='bx bx-moon' id="theme-icon"></i>
                        <span id="theme-text">Modo Oscuro</span>
                        <i class='bx bx-chevron-right'></i>
                    </button>
                    <button class="menu-option" id="settings-option">
                        <i class='bx bx-slider-alt'></i>
                        <span>Configuraci√≥n</span>
                        <i class='bx bx-chevron-right'></i>
                    </button>
                    <div class="menu-divider"></div>
                    <button class="menu-option danger" id="logout-option">
                        <i class='bx bx-log-out'></i>
                        <span>Cerrar Sesi√≥n</span>
                        <i class='bx bx-chevron-right'></i>
                    </button>
                </div>
                
                <div class="app-version">
                    <small>FC24 Team Manager v2.2</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Spinner - UNCHANGED -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Cargando...</div>
    </div>
    
    <!-- Bottom Navigation - MODIFIED: Updated for new flow -->
    <nav class="nav-bar" id="main-nav-bar">
        <a href="javascript:void(0)" class="nav-item active" data-screen="register-screen">
            <i class='bx bx-user-plus'></i>
            <span>Registro</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" data-screen="stats-screen">
            <i class='bx bx-stats'></i>
            <span>Stats</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" data-screen="matches-screen">
            <i class='bx bx-football'></i>
            <span>Partidos</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" data-screen="evaluate-screen">
            <i class='bx bx-edit-alt'></i>
            <span>Evaluar</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" data-screen="ranking-screen">
            <i class='bx bx-trophy'></i>
            <span>Ranking</span>
        </a>
    </nav>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- JavaScript Files in correct order -->
    <script src="js/firebase-simple.js"></script>
    <script src="js/supabase-storage.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/validators.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/ui-helpers.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/match-system-v2.js"></script>
    <script src="js/app.js"></script>
    <script src="js/match-manager.js"></script>
    <script src="js/seed-demo.js"></script>
    
    <script>
        // Initialize Firebase mode with improved error handling
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Starting FC24 Team Manager...');
            console.log('Firebase mode active - will load real data from Firestore');
            
            // Wait a bit for all scripts to load
            await new Promise(resolve => setTimeout(resolve, 100));
            
            try {
                // Check for critical dependencies
                const dependencies = ['App', 'Storage', 'UI', 'Utils', 'GlobalErrorHandler'];
                const missing = dependencies.filter(dep => typeof window[dep] === 'undefined');
                
                if (missing.length > 0) {
                    const error = new Error(`Critical dependencies missing: ${missing.join(', ')}`);
                    if (typeof window.handleError === 'function') {
                        handleError(error, 'initialization');
                    } else {
                        console.error('Critical error:', error);
                    }
                    
                    // Show loading overlay with error
                    document.body.innerHTML += `
                        <div class="loading-overlay">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Error cargando la aplicaci√≥n...</div>
                            <div style="color: #ff4444; margin-top: 20px; text-align: center;">
                                <p>Faltan componentes cr√≠ticos: ${missing.join(', ')}</p>
                                <button onclick="window.location.reload()" style="padding: 10px 20px; background: var(--primary-color); border: none; border-radius: 5px; color: black; cursor: pointer;">
                                    Recargar P√°gina
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Show loading during initialization
                if (typeof UI !== 'undefined' && UI.showLoading) {
                    UI.showLoading('Iniciando aplicaci√≥n...');
                }
                
                // Initialize with timeout
                const initTimeout = setTimeout(() => {
                    handleError(new Error('App initialization timeout'), 'initialization');
                    if (typeof UI !== 'undefined') {
                        UI.hideLoading();
                        UI.showNotification('La aplicaci√≥n tard√≥ demasiado en cargar. Recargando...', 'error');
                    }
                    setTimeout(() => window.location.reload(), 3000);
                }, 10000); // 10 segundos timeout
                
                await App.init();
                clearTimeout(initTimeout);
                
                if (typeof UI !== 'undefined' && UI.hideLoading) {
                    UI.hideLoading();
                }
                
                console.log('‚úÖ FC24 Team Manager initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Error initializing app:', error);
                handleError(error, 'initialization');
                
                // Show user-friendly error
                if (typeof UI !== 'undefined') {
                    UI.hideLoading();
                    UI.showNotification('Error al inicializar la aplicaci√≥n. Recargando...', 'error');
                } else {
                    alert('Error al cargar la aplicaci√≥n. La p√°gina se recargar√°.');
                }
                
                setTimeout(() => window.location.reload(), 3000);
            }
        });

        // Handle critical initialization errors
        window.addEventListener('error', (event) => {
            if (event.message && event.message.includes('App is not defined')) {
                console.error('Critical: App.js failed to load properly');
                document.body.innerHTML += `
                    <div class="loading-overlay">
                        <div style="text-align: center; color: white;">
                            <h2 style="color: #ff4444;">Error Cr√≠tico</h2>
                            <p>La aplicaci√≥n no pudo cargar correctamente.</p>
                            <p>Por favor, recarga la p√°gina.</p>
                            <button onclick="window.location.reload()" style="padding: 10px 20px; background: var(--primary-color); border: none; border-radius: 5px; color: black; cursor: pointer; margin-top: 20px;">
                                Recargar P√°gina
                            </button>
                        </div>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>